<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内存管理架构详解</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        header {
            background: linear-gradient(90deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .architecture {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 600px;
        }
        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 20px;
        }
        .memory-item {
            background: rgba(255, 255, 255, 0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .memory-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        .memory-item.active {
            background: rgba(52, 152, 219, 0.3);
            border-left-color: #3498db;
        }
        .content-area {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .detail-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .detail-card h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .memory-hierarchy {
            grid-column: 1 / -1;
        }
        .hierarchy-container {
            position: relative;
            height: 500px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .memory-level {
            position: absolute;
            width: 90%;
            padding: 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .memory-level:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .physical-memory {
            top: 20px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            z-index: 5;
        }
        .kernel-space {
            top: 100px;
            background: linear-gradient(90deg, #f39c12, #e67e22);
            z-index: 4;
        }
        .user-space {
            top: 180px;
            background: linear-gradient(90deg, #3498db, #2980b9);
            z-index: 3;
        }
        .direct-memory {
            top: 260px;
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            z-index: 2;
        }
        .jvm-memory {
            top: 340px;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            z-index: 1;
        }
        .connection-line {
            position: absolute;
            left: 50%;
            width: 4px;
            background: #7f8c8d;
            z-index: 0;
        }
        .connection-line::before {
            content: "↓";
            position: absolute;
            left: -8px;
            color: #7f8c8d;
            font-size: 20px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .info-box h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #3498db;
            color: white;
        }
        .comparison-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        footer {
            text-align: center;
            padding: 20px;
            background: #2c3e50;
            color: white;
            margin-top: 20px;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>内存管理架构详解</h1>
            <p class="subtitle">从物理硬件到应用层的内存管理关系解析</p>
        </header>

        <div class="architecture">
            <div class="sidebar">
                <h3>内存区域</h3>
                <div class="memory-item active" data-target="physical">物理内存</div>
                <div class="memory-item" data-target="kernel">内核空间</div>
                <div class="memory-item" data-target="user">用户空间</div>
                <div class="memory-item" data-target="direct">直接内存</div>
                <div class="memory-item" data-target="jvm">JVM内存</div>
                <div class="memory-item" data-target="relations">关联关系</div>
            </div>

            <div class="content-area">
                <!-- 物理内存详情 -->
                <div class="detail-card physical-detail">
                    <h2>物理内存 (Physical Memory)</h2>
                    <div class="info-grid">
                        <div class="info-box">
                            <h3>管理者</h3>
                            <p><strong>操作系统内存管理单元 (MMU)</strong> 负责物理内存的分配和管理</p>
                        </div>
                        <div class="info-box">
                            <h3>物理位置</h3>
                            <p>计算机的 <strong>RAM (随机存取存储器)</strong> 芯片</p>
                        </div>
                        <div class="info-box">
                            <h3>大小限制</h3>
                            <p>受硬件限制，通常为 4GB - 128GB（服务器可达数TB）</p>
                        </div>
                        <div class="info-box">
                            <h3>访问方式</h3>
                            <p>通过内存总线直接访问，速度最快</p>
                        </div>
                    </div>
                    
                    <h3>关键特性</h3>
                    <ul>
                        <li>所有程序运行的最终存储位置</li>
                        <li>通过虚拟内存技术扩展（使用硬盘作为交换空间）</li>
                        <li>按页(page)进行管理，通常每页4KB</li>
                        <li>CPU通过物理地址直接访问</li>
                    </ul>
                </div>

                <!-- 内存层次结构 -->
                <div class="detail-card memory-hierarchy">
                    <h2>内存层次结构</h2>
                    <div class="hierarchy-container">
                        <div class="connection-line" style="top: 70px; height: 60px;"></div>
                        <div class="memory-level physical-memory">
                            <h3>物理内存 (Physical Memory)</h3>
                            <p>管理者：操作系统 MMU | 位置：RAM 硬件芯片</p>
                        </div>
                        
                        <div class="connection-line" style="top: 150px; height: 60px;"></div>
                        <div class="memory-level kernel-space">
                            <h3>内核空间 (Kernel Space)</h3>
                            <p>管理者：操作系统内核 | 位置：物理内存的受保护区域</p>
                        </div>
                        
                        <div class="connection-line" style="top: 230px; height: 60px;"></div>
                        <div class="memory-level user-space">
                            <h3>用户空间 (User Space)</h3>
                            <p>管理者：用户进程 | 位置：物理内存的用户可访问区域</p>
                        </div>
                        
                        <div class="connection-line" style="top: 310px; height: 60px;"></div>
                        <div class="memory-level direct-memory">
                            <h3>直接内存 (Direct Memory)</h3>
                            <p>管理者：JVM（通过malloc） | 位置：用户空间内的特殊区域</p>
                        </div>
                        
                        <div class="connection-line" style="top: 390px; height: 60px;"></div>
                        <div class="memory-level jvm-memory">
                            <h3>JVM内存 (JVM Memory)</h3>
                            <p>管理者：Java虚拟机 | 位置：用户空间内的堆区域</p>
                        </div>
                    </div>
                </div>

                <!-- 内核空间详情 -->
                <div class="detail-card kernel-detail" style="display: none;">
                    <h2>内核空间 (Kernel Space)</h2>
                    <div class="info-grid">
                        <div class="info-box">
                            <h3>管理者</h3>
                            <p><strong>操作系统内核</strong> 直接管理</p>
                        </div>
                        <div class="info-box">
                            <h3>物理位置</h3>
                            <p>物理内存的<strong>高端地址区域</strong>（如Linux中3GB-4GB）</p>
                        </div>
                        <div class="info-box">
                            <h3>访问权限</h3>
                            <p>仅内核模式(ring 0)可访问，用户程序无法直接访问</p>
                        </div>
                        <div class="info-box">
                            <h3>主要用途</h3>
                            <p>内核代码、驱动程序、中断处理、内存管理等</p>
                        </div>
                    </div>
                    
                    <h3>包含内容</h3>
                    <ul>
                        <li>操作系统内核代码和数据</li>
                        <li>设备驱动程序</li>
                        <li>内核栈和进程控制块</li>
                        <li>DMA缓冲区</li>
                        <li>网络协议栈内核部分</li>
                    </ul>
                    
                    <div class="code-block">
// 系统调用示例：从用户空间到内核空间的切换
// 用户空间代码
read(fd, buffer, size);

// 内核空间处理
// 1. 陷入内核模式 (trap)
// 2. 执行系统调用处理程序
// 3. 访问硬件设备
// 4. 将数据复制到用户空间缓冲区
// 5. 返回到用户模式
                    </div>
                </div>

                <!-- 用户空间详情 -->
                <div class="detail-card user-detail" style="display: none;">
                    <h2>用户空间 (User Space)</h2>
                    <div class="info-grid">
                        <div class="info-box">
                            <h3>管理者</h3>
                            <p>各个<strong>用户进程</strong>独立管理自己的用户空间</p>
                        </div>
                        <div class="info-box">
                            <h3>物理位置</h3>
                            <p>物理内存的<strong>低端地址区域</strong>（如Linux中0-3GB）</p>
                        </div>
                        <div class="info-box">
                            <h3>访问权限</h3>
                            <p>用户模式(ring 3)可访问，受操作系统保护</p>
                        </div>
                        <div class="info-box">
                            <h3>隔离性</h3>
                            <p>进程间用户空间相互隔离，无法直接访问</p>
                        </div>
                    </div>
                    
                    <h3>进程内存布局</h3>
                    <table class="comparison-table">
                        <tr>
                            <th>区域</th>
                            <th>用途</th>
                            <th>增长方向</th>
                        </tr>
                        <tr>
                            <td>代码段(text)</td>
                            <td>存放可执行代码</td>
                            <td>固定大小</td>
                        </tr>
                        <tr>
                            <td>数据段(data)</td>
                            <td>全局变量和静态变量</td>
                            <td>固定大小</td>
                        </tr>
                        <tr>
                            <td>堆(heap)</td>
                            <td>动态内存分配</td>
                            <td>向高地址增长</td>
                        </tr>
                        <tr>
                            <td>栈(stack)</td>
                            <td>函数调用、局部变量</td>
                            <td>向低地址增长</td>
                        </tr>
                        <tr>
                            <td>内存映射区</td>
                            <td>文件映射、共享库</td>
                            <td>灵活</td>
                        </tr>
                    </table>
                </div>

                <!-- 直接内存详情 -->
                <div class="detail-card direct-detail" style="display: none;">
                    <h2>直接内存 (Direct Memory)</h2>
                    <div class="info-grid">
                        <div class="info-box">
                            <h3>管理者</h3>
                            <p><strong>JVM</strong>通过<strong>malloc/free</strong>系统调用管理</p>
                        </div>
                        <div class="info-box">
                            <h3>物理位置</h3>
                            <p>用户空间内的<strong>堆外内存</strong>区域</p>
                        </div>
                        <div class="info-box">
                            <h3>分配方式</h3>
                            <p>通过<strong>ByteBuffer.allocateDirect()</strong>分配</p>
                        </div>
                        <div class="info-box">
                            <h3>GC管理</h3>
                            <p>不由常规GC管理，通过<strong>Cleaner机制</strong>释放</p>
                        </div>
                    </div>
                    
                    <h3>零拷贝原理</h3>
                    <div class="code-block">
// 直接内存分配示例
ByteBuffer directBuffer = ByteBuffer.allocateDirect(1024);

// 底层实现：
// 1. 通过Unsafe.allocateMemory()分配本地内存
// 2. 创建DirectByteBuffer对象引用该内存
// 3. 内存位于JVM堆外，但由JVM进程管理

// 传统IO vs 零拷贝IO
// 传统：数据从内核缓冲区 → JVM堆 → 用户处理 → JVM堆 → 内核缓冲区
// 零拷贝：数据在内核缓冲区与直接内存间直接传输
                    </div>
                    
                    <h3>优势与风险</h3>
                    <ul>
                        <li><strong>优势</strong>：减少内存拷贝、提高I/O性能、避免GC压力</li>
                        <li><strong>风险</strong>：内存泄漏风险、分配成本较高、调试困难</li>
                    </ul>
                </div>

                <!-- JVM内存详情 -->
                <div class="detail-card jvm-detail" style="display: none;">
                    <h2>JVM内存 (JVM Memory)</h2>
                    <div class="info-grid">
                        <div class="info-box">
                            <h3>管理者</h3>
                            <p><strong>Java虚拟机</strong>的垃圾回收器和内存管理器</p>
                        </div>
                        <div class="info-box">
                            <h3>物理位置</h3>
                            <p>用户空间内的<strong>JVM进程堆</strong>区域</p>
                        </div>
                        <div class="info-box">
                            <h3>内存结构</h3>
                            <p>堆、方法区、虚拟机栈、本地方法栈、程序计数器</p>
                        </div>
                        <div class="info-box">
                            <h3>GC管理</h3>
                            <p>由JVM的<strong>垃圾回收器</strong>自动管理</p>
                        </div>
                    </div>
                    
                    <h3>JVM内存模型</h3>
                    <table class="comparison-table">
                        <tr>
                            <th>区域</th>
                            <th>线程共享</th>
                            <th>存储内容</th>
                            <th>异常类型</th>
                        </tr>
                        <tr>
                            <td>堆(Heap)</td>
                            <td>是</td>
                            <td>对象实例、数组</td>
                            <td>OutOfMemoryError</td>
                        </tr>
                        <tr>
                            <td>方法区(Method Area)</td>
                            <td>是</td>
                            <td>类信息、常量、静态变量</td>
                            <td>OutOfMemoryError</td>
                        </tr>
                        <tr>
                            <td>JVM栈(VM Stack)</td>
                            <td>否</td>
                            <td>局部变量、操作数栈</td>
                            <td>StackOverflowError</td>
                        </tr>
                        <tr>
                            <td>本地方法栈(Native Stack)</td>
                            <td>否</td>
                            <td>Native方法调用</td>
                            <td>StackOverflowError</td>
                        </tr>
                        <tr>
                            <td>程序计数器(PC Register)</td>
                            <td>否</td>
                            <td>当前指令地址</td>
                            <td>无</td>
                        </tr>
                    </table>
                </div>

                <!-- 关联关系详情 -->
                <div class="detail-card relations-detail" style="display: none;">
                    <h2>内存区域关联关系</h2>
                    
                    <h3>数据流通过程</h3>
                    <div class="code-block">
// 网络数据读取示例 - 传统方式
1. 网卡接收数据 → DMA → 内核缓冲区
2. 内核缓冲区 → 拷贝 → JVM堆缓冲区 (1次拷贝)
3. 应用程序处理数据

// 网络数据读取示例 - 零拷贝方式  
1. 网卡接收数据 → DMA → 内核缓冲区
2. 内核缓冲区 → DMA → 直接内存 (零拷贝)
3. 应用程序通过DirectByteBuffer访问

// 文件发送示例 - sendfile系统调用
1. 文件数据在内核缓冲区
2. sendfile系统调用：内核缓冲区 → 网络协议栈
3. 完全在内核空间完成，无需用户空间参与
                    </div>
                    
                    <h3>关键关联点</h3>
                    <ul>
                        <li><strong>系统调用</strong>：用户空间与内核空间的桥梁</li>
                        <li><strong>内存映射</strong>：将文件直接映射到用户空间</li>
                        <li><strong>DMA传输</strong>：设备直接访问内存，绕过CPU</li>
                        <li><strong>虚拟内存</strong>：为每个进程提供独立的地址空间</li>
                        <li><strong>分页机制</strong>：物理内存与虚拟地址的映射</li>
                    </ul>
                    
                    <h3>性能优化要点</h3>
                    <div class="info-grid">
                        <div class="info-box">
                            <h3>减少上下文切换</h3>
                            <p>使用epoll等I/O多路复用技术减少系统调用</p>
                        </div>
                        <div class="info-box">
                            <h3>减少内存拷贝</h3>
                            <p>使用直接内存和sendfile等零拷贝技术</p>
                        </div>
                        <div class="info-box">
                            <h3>合理内存分配</h3>
                            <p>根据使用场景选择堆内存或直接内存</p>
                        </div>
                        <div class="info-box">
                            <h3>缓存优化</h3>
                            <p>利用CPU缓存局部性原理优化数据布局</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>内存管理架构深度解析 | 从物理硬件到JVM应用的完整内存视图</p>
            <p>理解内存层次关系是进行高性能编程和系统优化的基础</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const memoryItems = document.querySelectorAll('.memory-item');
            const detailCards = document.querySelectorAll('.detail-card');
            
            // 显示默认选中的物理内存详情
            showDetail('physical');
            
            memoryItems.forEach(item => {
                item.addEventListener('click', function() {
                    // 移除所有active类
                    memoryItems.forEach(i => i.classList.remove('active'));
                    // 添加当前active类
                    this.classList.add('active');
                    // 显示对应的详情
                    const target = this.getAttribute('data-target');
                    showDetail(target);
                });
            });
            
            function showDetail(target) {
                // 隐藏所有详情卡片
                detailCards.forEach(card => {
                    card.style.display = 'none';
                });
                
                // 显示目标详情卡片
                const targetCard = document.querySelector(`.${target}-detail`);
                if (targetCard) {
                    targetCard.style.display = 'block';
                }
                
                // 特殊处理关系视图
                if (target === 'relations') {
                    document.querySelector('.physical-detail').style.display = 'block';
                    document.querySelector('.memory-hierarchy').style.display = 'block';
                }
            }
            
            // 添加层次结构的交互效果
            const memoryLevels = document.querySelectorAll('.memory-level');
            memoryLevels.forEach(level => {
                level.addEventListener('click', function() {
                    const levelType = this.classList[1].split('-')[0];
                    // 切换到对应的内存类型
                    memoryItems.forEach(i => i.classList.remove('active'));
                    document.querySelector(`[data-target="${levelType}"]`).classList.add('active');
                    showDetail(levelType);
                });
            });
        });
    </script>
</body>
</html>