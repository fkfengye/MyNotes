<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReentrantLock多线程获取锁流程详解</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #e0e0e0;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            width: 100%;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .content {
            display: flex;
            width: 100%;
            gap: 25px;
            margin-top: 20px;
        }
        
        .visualization {
            flex: 3;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .explanation {
            flex: 2;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .explanation h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #4facfe;
            text-align: center;
        }
        
        .step-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #00f2fe;
        }
        
        .step-info h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #00f2fe;
        }
        
        .step-details {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .state-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .state-table th {
            background: rgba(74, 107, 227, 0.6);
            padding: 10px;
            text-align: left;
        }
        
        .state-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .state-table tr:last-child td {
            border-bottom: none;
        }
        
        .lock-state {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 12px;
            width: 100%;
        }
        
        .state-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a2a6c, #4facfe);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .state-value {
            font-size: 3rem;
            margin-top: 5px;
            color: #00f2fe;
        }
        
        .queue-container {
            width: 100%;
            min-height: 300px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        
        .queue-title {
            text-align: center;
            margin-bottom: 20px;
            color: #00f2fe;
            font-size: 1.4rem;
        }
        
        .queue {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 30px;
            min-height: 200px;
        }
        
        .node {
            width: 140px;
            height: 160px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .node.head::before {
            content: 'HEAD';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(74, 107, 227, 0.8);
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .node.tail::after {
            content: 'TAIL';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(74, 107, 227, 0.8);
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .node.dummy {
            background: linear-gradient(135deg, #3a1c71, #d76d77);
        }
        
        .node.locked {
            box-shadow: 0 0 15px #00f2fe, 0 0 25px #4facfe;
        }
        
        .node.blocked {
            opacity: 0.7;
            filter: grayscale(50%);
        }
        
        .node-type {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00f2fe;
        }
        
        .thread-info {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 5px 0;
            text-align: center;
        }
        
        .status-info {
            font-size: 0.95rem;
            margin: 3px 0;
            color: #ffcc00;
            text-align: center;
        }
        
        .wait-status {
            background: rgba(255, 204, 0, 0.2);
            padding: 3px 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        .arrow {
            font-size: 2rem;
            color: #00f2fe;
            display: flex;
            align-items: center;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
            width: 100%;
        }
        
        button {
            padding: 12px 30px;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            background: linear-gradient(135deg, #3a9dfc, #00e0f0);
        }
        
        button:disabled {
            background: linear-gradient(135deg, #7a9fc2, #7fd4d9);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .step-indicator {
            font-size: 1.2rem;
            margin-top: 15px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 20px;
            border-radius: 20px;
        }
        
        .thread-states {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            width: 100%;
            flex-wrap: wrap;
        }
        
        .thread-card {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            padding: 15px;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .thread-card.active {
            background: rgba(74, 107, 227, 0.4);
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.5);
        }
        
        .thread-card.blocked {
            background: rgba(215, 109, 119, 0.4);
        }
        
        .thread-card h4 {
            color: #00f2fe;
            margin-bottom: 10px;
        }
        
        .thread-state {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        @media (max-width: 900px) {
            .content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ReentrantLock 多线程获取锁流程详解</h1>
            <p class="subtitle">本可视化展示了三个线程(T1, T2, T3)在非公平模式下竞争ReentrantLock时，锁状态(state)和同步队列节点状态(waitStatus)的完整变化过程</p>
        </header>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #1e3c72;"></div>
                <span>正常节点</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3a1c71;"></div>
                <span>虚节点(Dummy Node)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"></div>
                <span>持有锁的节点</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffcc00;"></div>
                <span>SIGNAL状态(-1)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #d76d77;"></div>
                <span>阻塞线程</span>
            </div>
        </div>
        
        <div class="content">
            <div class="visualization">
                <div class="lock-state">
                    <div class="state-circle">
                        <div>锁状态</div>
                        <div class="state-value">0</div>
                        <div>state</div>
                    </div>
                </div>
                
                <div class="queue-container">
                    <div class="queue-title">AQS同步队列 (CLH队列)</div>
                    <div class="queue">
                        <!-- 队列节点将通过JS动态生成 -->
                    </div>
                </div>
                
                <div class="thread-states">
                    <div class="thread-card" id="t1-card">
                        <h4>线程 T1</h4>
                        <div class="thread-state">未启动</div>
                    </div>
                    <div class="thread-card" id="t2-card">
                        <h4>线程 T2</h4>
                        <div class="thread-state">未启动</div>
                    </div>
                    <div class="thread-card" id="t3-card">
                        <h4>线程 T3</h4>
                        <div class="thread-state">未启动</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="prev-btn" disabled>上一步</button>
                    <button id="next-btn">下一步</button>
                    <button id="reset-btn">重置</button>
                </div>
                
                <div class="step-indicator">步骤 1/9: 初始状态</div>
            </div>
            
            <div class="explanation">
                <h2>流程说明</h2>
                <div class="step-info">
                    <h3>步骤 1: 初始状态</h3>
                    <div class="step-details">
                        <p>锁状态: <strong>state = 0</strong> (锁空闲)</p>
                        <p>同步队列: <strong>空</strong></p>
                        <p>所有线程尚未启动</p>
                    </div>
                    
                    <table class="state-table">
                        <tr>
                            <th>状态</th>
                            <th>值</th>
                            <th>描述</th>
                        </tr>
                        <tr>
                            <td>state</td>
                            <td>0</td>
                            <td>锁未被占用</td>
                        </tr>
                        <tr>
                            <td>head</td>
                            <td>null</td>
                            <td>队列头节点</td>
                        </tr>
                        <tr>
                            <td>tail</td>
                            <td>null</td>
                            <td>队列尾节点</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 步骤数据
        const steps = [
            {
                title: "步骤 1: 初始状态",
                state: 0,
                queue: [],
                activeThread: null,
                blockedThreads: [],
                explanation: {
                    title: "步骤 1: 初始状态",
                    details: "锁状态: state = 0 (锁空闲)\n同步队列: 空\n所有线程尚未启动"
                }
            },
            {
                title: "步骤 2: T1获取锁",
                state: 1,
                queue: [],
                activeThread: "T1",
                blockedThreads: [],
                explanation: {
                    title: "步骤 2: T1获取锁（成功）",
                    details: "T1调用lock()，通过CAS将state从0设置为1\n锁状态: state = 1 (T1持有锁)\n同步队列: 仍为空"
                }
            },
            {
                title: "步骤 3: T2尝试获取锁",
                state: 1,
                queue: [
                    { id: "dummy", type: "dummy", thread: null, waitStatus: -1, isHead: true, isTail: false, locked: false, blocked: false },
                    { id: "t2", type: "normal", thread: "T2", waitStatus: 0, isHead: false, isTail: true, locked: false, blocked: true }
                ],
                activeThread: "T1",
                blockedThreads: ["T2"],
                explanation: {
                    title: "步骤 3: T2尝试获取锁（失败并入队）",
                    details: "T2调用lock()，CAS设置state失败（因state=1）\n创建虚头节点(dummy)和T2节点\n队列结构: dummy(head) → T2(tail)\n设置dummy.waitStatus = SIGNAL(-1)\nT2阻塞（LockSupport.park()）"
                }
            },
            {
                title: "步骤 4: T3尝试获取锁",
                state: 1,
                queue: [
                    { id: "dummy", type: "dummy", thread: null, waitStatus: -1, isHead: true, isTail: false, locked: false, blocked: false },
                    { id: "t2", type: "normal", thread: "T2", waitStatus: -1, isHead: false, isTail: false, locked: false, blocked: true },
                    { id: "t3", type: "normal", thread: "T3", waitStatus: 0, isHead: false, isTail: true, locked: false, blocked: true }
                ],
                activeThread: "T1",
                blockedThreads: ["T2", "T3"],
                explanation: {
                    title: "步骤 4: T3尝试获取锁（失败并入队）",
                    details: "T3调用lock()，CAS失败（state=1）\n新节点T3加入队尾\n队列结构: dummy → T2 → T3(tail)\n设置T2.waitStatus = SIGNAL(-1)\nT3阻塞"
                }
            },
            {
                title: "步骤 5: T1释放锁",
                state: 0,
                queue: [
                    { id: "dummy", type: "dummy", thread: null, waitStatus: 0, isHead: true, isTail: false, locked: false, blocked: false },
                    { id: "t2", type: "normal", thread: "T2", waitStatus: -1, isHead: false, isTail: false, locked: false, blocked: false },
                    { id: "t3", type: "normal", thread: "T3", waitStatus: 0, isHead: false, isTail: true, locked: false, blocked: true }
                ],
                activeThread: null,
                blockedThreads: ["T3"],
                explanation: {
                    title: "步骤 5: T1释放锁并唤醒T2",
                    details: "T1调用unlock()，state从1减至0\n调用unparkSuccessor()，从dummy找到后继T2\n重置dummy.waitStatus = 0\n唤醒T2（LockSupport.unpark(T2)）"
                }
            },
            {
                title: "步骤 6: T2获取锁",
                state: 1,
                queue: [
                    { id: "t2", type: "normal", thread: "T2", waitStatus: 0, isHead: true, isTail: false, locked: true, blocked: false },
                    { id: "t3", type: "normal", thread: "T3", waitStatus: 0, isHead: false, isTail: true, locked: false, blocked: true }
                ],
                activeThread: "T2",
                blockedThreads: ["T3"],
                explanation: {
                    title: "步骤 6: T2获取锁并成为新头节点",
                    details: "T2被唤醒，在acquireQueued()循环中尝试获取锁\nCAS成功：state从0设置为1\nT2成为新头节点（setHead()）\n队列变为: T2(head) → T3(tail)\nT2.waitStatus重置为0"
                }
            },
            {
                title: "步骤 7: T2释放锁",
                state: 0,
                queue: [
                    { id: "t2", type: "normal", thread: "T2", waitStatus: 0, isHead: true, isTail: false, locked: false, blocked: false },
                    { id: "t3", type: "normal", thread: "T3", waitStatus: 0, isHead: false, isTail: true, locked: false, blocked: false }
                ],
                activeThread: null,
                blockedThreads: [],
                explanation: {
                    title: "步骤 7: T2释放锁并唤醒T3",
                    details: "T2调用unlock()，state从1减至0\n调用unparkSuccessor(T2)，找到后继T3\n重置T2.waitStatus = 0\n唤醒T3（LockSupport.unpark(T3)）"
                }
            },
            {
                title: "步骤 8: T3获取锁",
                state: 1,
                queue: [
                    { id: "t3", type: "normal", thread: "T3", waitStatus: 0, isHead: true, isTail: true, locked: true, blocked: false }
                ],
                activeThread: "T3",
                blockedThreads: [],
                explanation: {
                    title: "步骤 8: T3获取锁并成为头节点",
                    details: "T3被唤醒，在循环中CAS设置state=1（成功）\nT3成为新头节点（setHead()）\n断开T2，队列变为: T3(head)（尾节点指向自身）\nT3.waitStatus重置为0"
                }
            },
            {
                title: "步骤 9: T3释放锁",
                state: 0,
                queue: [
                    { id: "t3", type: "normal", thread: "T3", waitStatus: 0, isHead: true, isTail: true, locked: false, blocked: false }
                ],
                activeThread: null,
                blockedThreads: [],
                explanation: {
                    title: "步骤 9: T3释放锁",
                    details: "T3调用unlock()，state=0\n同步队列：无后继节点，直接结束"
                }
            }
        ];

        let currentStep = 0;
        const queueContainer = document.querySelector('.queue');
        const stateValue = document.querySelector('.state-value');
        const stepIndicator = document.querySelector('.step-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const resetBtn = document.getElementById('reset-btn');
        const explanation = document.querySelector('.step-info');
        const t1Card = document.getElementById('t1-card');
        const t2Card = document.getElementById('t2-card');
        const t3Card = document.getElementById('t3-card');

        // 渲染当前步骤
        function renderStep(stepIndex) {
            const step = steps[stepIndex];
            
            // 更新锁状态
            stateValue.textContent = step.state;
            
            // 更新步骤指示器
            stepIndicator.textContent = `${step.title} (${stepIndex + 1}/9)`;
            
            // 更新解释
            explanation.innerHTML = `
                <h3>${step.explanation.title}</h3>
                <div class="step-details">${step.explanation.details.replace(/\n/g, '<br>')}</div>
                ${generateStateTable(step)}
            `;
            
            // 渲染队列
            renderQueue(step.queue);
            
            // 更新线程状态
            updateThreadCards(step);
            
            // 更新按钮状态
            prevBtn.disabled = stepIndex === 0;
            nextBtn.disabled = stepIndex === steps.length - 1;
        }

        // 生成状态表格
        function generateStateTable(step) {
            let head = 'null';
            let tail = 'null';
            
            if (step.queue.length > 0) {
                head = step.queue[0].id;
                tail = step.queue[step.queue.length - 1].id;
            }
            
            return `
                <table class="state-table">
                    <tr>
                        <th>状态</th>
                        <th>值</th>
                        <th>描述</th>
                    </tr>
                    <tr>
                        <td>state</td>
                        <td>${step.state}</td>
                        <td>${step.state === 0 ? '锁空闲' : '锁被占用' + (step.state > 1 ? `(重入${step.state}次)` : '')}</td>
                    </tr>
                    <tr>
                        <td>head</td>
                        <td>${head}</td>
                        <td>队列头节点</td>
                    </tr>
                    <tr>
                        <td>tail</td>
                        <td>${tail}</td>
                        <td>队列尾节点</td>
                    </tr>
                </table>
            `;
        }

        // 渲染队列
        function renderQueue(queue) {
            queueContainer.innerHTML = '';
            
            if (queue.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.textContent = '同步队列为空';
                emptyMsg.style.color = '#aaa';
                emptyMsg.style.fontSize = '1.2rem';
                emptyMsg.style.marginTop = '50px';
                queueContainer.appendChild(emptyMsg);
                return;
            }
            
            queue.forEach((node, index) => {
                const nodeEl = document.createElement('div');
                nodeEl.className = 'node';
                
                if (node.type === 'dummy') {
                    nodeEl.classList.add('dummy');
                }
                
                if (node.locked) {
                    nodeEl.classList.add('locked');
                }
                
                if (node.blocked) {
                    nodeEl.classList.add('blocked');
                }
                
                if (node.isHead) {
                    nodeEl.classList.add('head');
                }
                
                if (node.isTail) {
                    nodeEl.classList.add('tail');
                }
                
                nodeEl.innerHTML = `
                    <div class="node-type">${node.type === 'dummy' ? '虚节点' : '线程节点'}</div>
                    ${node.thread ? `<div class="thread-info">${node.thread}</div>` : ''}
                    <div class="status-info">${node.locked ? '持有锁' : node.blocked ? '阻塞中' : '等待中'}</div>
                    <div class="wait-status">waitStatus: ${node.waitStatus} ${node.waitStatus === -1 ? '(SIGNAL)' : ''}</div>
                `;
                
                queueContainer.appendChild(nodeEl);
                
                // 添加箭头（除了最后一个节点）
                if (index < queue.length - 1) {
                    const arrow = document.createElement('div');
                    arrow.className = 'arrow';
                    arrow.innerHTML = '→';
                    queueContainer.appendChild(arrow);
                }
            });
        }

        // 更新线程卡片
        function updateThreadCards(step) {
            // 重置所有卡片
            [t1Card, t2Card, t3Card].forEach(card => {
                card.classList.remove('active', 'blocked');
                card.querySelector('.thread-state').textContent = '未启动';
            });
            
            // 更新活动线程
            if (step.activeThread) {
                const activeCard = document.getElementById(`${step.activeThread.toLowerCase()}-card`);
                activeCard.classList.add('active');
                activeCard.querySelector('.thread-state').textContent = '运行中 (持有锁)';
            }
            
            // 更新阻塞线程
            step.blockedThreads.forEach(thread => {
                const blockedCard = document.getElementById(`${thread.toLowerCase()}-card`);
                blockedCard.classList.add('blocked');
                blockedCard.querySelector('.thread-state').textContent = '阻塞中';
            });
            
            // 更新非活动线程
            ['T1', 'T2', 'T3'].forEach(thread => {
                if (thread !== step.activeThread && !step.blockedThreads.includes(thread)) {
                    const threadCard = document.getElementById(`${thread.toLowerCase()}-card`);
                    const state = threadCard.querySelector('.thread-state');
                    
                    if (step.state === 0) {
                        state.textContent = '未启动';
                    } else {
                        state.textContent = '等待中';
                    }
                }
            });
        }

        // 初始化
        renderStep(currentStep);

        // 事件监听
        nextBtn.addEventListener('click', () => {
            if (currentStep < steps.length - 1) {
                currentStep++;
                renderStep(currentStep);
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                renderStep(currentStep);
            }
        });

        resetBtn.addEventListener('click', () => {
            currentStep = 0;
            renderStep(currentStep);
        });
    </script>
</body>
</html>