<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL SELECT查询语句执行流程</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            color: white;
            padding: 30px 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 900px;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
        }
        
        .comparison {
            flex: 1;
            padding: 30px;
            border-right: 1px solid #eaeaea;
        }
        
        .details {
            width: 500px;
            padding: 30px;
            background-color: #f9fafc;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #1565c0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
        }
        
        h3 {
            font-size: 1.4rem;
            margin: 25px 0 15px;
            color: #0d47a1;
        }
        
        .flow-comparison {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        
        .flow-column {
            flex: 1;
            background-color: #fcfdfe;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .flow-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1565c0;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .flow-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .step {
            padding: 15px;
            border-radius: 8px;
            background-color: white;
            border-left: 4px solid #1565c0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .step:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .step.select {
            border-left-color: #4caf50;
        }
        
        .step.update {
            border-left-color: #f44336;
        }
        
        .step-number {
            display: inline-block;
            width: 26px;
            height: 26px;
            background-color: #1565c0;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 26px;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.9rem;
        }
        
        .step-number.select {
            background-color: #4caf50;
        }
        
        .step-number.update {
            background-color: #f44336;
        }
        
        .step-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .step-description {
            font-size: 0.9rem;
            color: #555;
            margin-left: 36px;
        }
        
        .step-layer {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 4px;
            background-color: #f0f0f0;
            color: #666;
            display: inline-block;
            margin-top: 8px;
            font-weight: 500;
        }
        
        .layer-client {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .layer-server {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .layer-innodb-memory {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .layer-innodb-disk {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .key-differences {
            margin-top: 30px;
            padding: 20px;
            background-color: #f0f7ff;
            border-radius: 8px;
            border-left: 4px solid #1565c0;
        }
        
        .key-differences h3 {
            margin-top: 0;
        }
        
        .difference-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .difference-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .difference-title {
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 5px;
        }
        
        .difference-description {
            font-size: 0.95rem;
            color: #555;
        }
        
        .query-example {
            margin-top: 30px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        
        .query-example pre {
            margin: 0;
            font-size: 1rem;
        }
        
        .highlight {
            background-color: #fff9c4;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
        }
        
        .legend-text {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eaeaea;
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
            }
            
            .details {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MySQL SELECT查询语句执行流程</h1>
            <p class="subtitle">详解SELECT语句从客户端到返回结果的完整执行过程，并与UPDATE流程对比</p>
        </header>
        
        <div class="content">
            <div class="comparison">
                <h2>SELECT vs UPDATE 执行流程对比</h2>
                
                <div class="flow-comparison">
                    <div class="flow-column">
                        <div class="flow-title">SELECT查询流程</div>
                        <div class="flow-steps" id="selectSteps">
                            <!-- SELECT步骤将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    
                    <div class="flow-column">
                        <div class="flow-title">UPDATE更新流程</div>
                        <div class="flow-steps" id="updateSteps">
                            <!-- UPDATE步骤将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
                
                <div class="key-differences">
                    <h3>核心区别</h3>
                    <div class="difference-item">
                        <div class="difference-title">1. 数据修改 vs 数据读取</div>
                        <div class="difference-description">
                            SELECT是读操作，只读取数据不修改，因此不需要Undo Log、Redo Log和Binlog（除非在事务中且有写操作）。
                            UPDATE是写操作，需要修改数据，因此需要完整的日志机制保证ACID特性。
                        </div>
                    </div>
                    <div class="difference-item">
                        <div class="difference-title">2. 事务隔离与MVCC</div>
                        <div class="difference-description">
                            SELECT通常利用MVCC（多版本并发控制）读取数据快照，不需要加锁或只加共享锁。
                            UPDATE需要加排他锁，确保数据一致性，防止并发修改冲突。
                        </div>
                    </div>
                    <div class="difference-item">
                        <div class="difference-title">3. 执行复杂度</div>
                        <div class="difference-description">
                            SELECT查询可能涉及复杂的执行计划优化、JOIN操作、排序、分组等。
                            UPDATE相对简单，主要是定位数据并修改，但需要处理锁和日志。
                        </div>
                    </div>
                    <div class="difference-item">
                        <div class="difference-title">4. 性能影响</div>
                        <div class="difference-description">
                            SELECT性能主要受索引、数据量和查询复杂度影响。
                            UPDATE性能除上述因素外，还受锁竞争、日志写入和磁盘IO影响。
                        </div>
                    </div>
                </div>
                
                <div class="query-example">
                    <h3>查询示例与执行计划</h3>
                    <pre>
SELECT 
    e.emp_no, 
    e.first_name, 
    e.last_name,
    s.salary,
    d.dept_name
FROM employees e
JOIN salaries s ON e.emp_no = s.emp_no 
    AND s.from_date <= CURDATE() 
    AND s.to_date >= CURDATE()
JOIN dept_emp de ON e.emp_no = de.emp_no 
    AND de.to_date = '9999-01-01'
JOIN departments d ON de.dept_no = d.dept_no
WHERE e.hire_date > '1990-01-01'
    AND e.gender = 'F'
ORDER BY s.salary DESC
LIMIT 10;
                    </pre>
                    <p>这个复杂查询涉及多个JOIN、WHERE过滤、排序和LIMIT，需要优化器生成高效的执行计划。</p>
                </div>
            </div>
            
            <div class="details">
                <h2>SELECT查询详细流程</h2>
                
                <h3>1. 客户端/连接层</h3>
                <p>查询请求从客户端发起，通过连接器建立连接，验证权限。</p>
                
                <h3>2. 查询缓存（MySQL 8.0前）</h3>
                <p>在MySQL 8.0之前，会先检查查询缓存。如果命中缓存，直接返回结果，否则继续执行。</p>
                
                <h3>3. 分析器</h3>
                <p>对SQL语句进行词法分析和语法分析，检查语法正确性，生成语法树。</p>
                
                <h3>4. 预处理器</h3>
                <p>检查表和列是否存在，解析别名，验证权限，展开视图等。</p>
                
                <h3>5. 优化器</h3>
                <p>基于成本选择最优执行计划，包括：</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>选择使用哪个索引</li>
                    <li>决定JOIN顺序和连接算法</li>
                    <li>评估是否使用覆盖索引</li>
                    <li>决定是否将子查询转换为JOIN</li>
                    <li>评估是否使用索引条件下推</li>
                </ul>
                
                <h3>6. 执行器</h3>
                <p>根据执行计划调用存储引擎接口，处理查询执行过程。</p>
                
                <h3>7. 存储引擎层</h3>
                <p>InnoDB执行以下操作：</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>检查Buffer Pool中是否有需要的数据页</li>
                    <li>如果没有，从磁盘读取数据页到Buffer Pool</li>
                    <li>应用MVCC机制，读取适当版本的数据</li>
                    <li>根据隔离级别加锁（如需要）</li>
                    <li>返回数据给执行器</li>
                </ul>
                
                <h3>8. 结果处理</h3>
                <p>执行器对返回的数据进行处理：</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>应用WHERE条件过滤</li>
                    <li>执行JOIN操作</li>
                    <li>执行GROUP BY和聚合函数</li>
                    <li>执行ORDER BY排序</li>
                    <li>应用LIMIT限制结果集</li>
                </ul>
                
                <h3>9. 返回结果</h3>
                <p>将最终结果返回给客户端，可能涉及网络传输和结果集缓存。</p>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4caf50;"></div>
                        <div class="legend-text">客户端/连接层</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2196f3;"></div>
                        <div class="legend-text">MySQL服务层</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ff9800;"></div>
                        <div class="legend-text">InnoDB内存层</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f44336;"></div>
                        <div class="legend-text">InnoDB磁盘层</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 15px; background-color: #e8f5e9; border-radius: 8px;">
                    <h3>性能优化提示</h3>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>为WHERE条件、JOIN条件和ORDER BY字段创建合适的索引</li>
                        <li>避免SELECT *，只选择需要的列</li>
                        <li>使用EXPLAIN分析查询执行计划</li>
                        <li>合理设计数据库表结构，避免过度规范化</li>
                        <li>注意JOIN的顺序和类型，小表驱动大表</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <footer>
            <p>MySQL SELECT查询语句执行流程详解 | 与UPDATE流程对比 | 基于MySQL 8.0架构</p>
        </footer>
    </div>

    <script>
        // SELECT查询流程步骤
        const selectSteps = [
            {
                id: 1,
                title: "客户端发送SELECT请求",
                description: "客户端应用程序通过MySQL连接发送SELECT查询语句到MySQL服务器。",
                layer: "client",
                highlight: "与UPDATE相同"
            },
            {
                id: 2,
                title: "连接器验证与连接",
                description: "连接器负责身份验证、连接管理和权限验证，确保客户端有权执行查询。",
                layer: "client",
                highlight: "与UPDATE相同"
            },
            {
                id: 3,
                title: "查询缓存检查（MySQL 8.0前）",
                description: "检查查询缓存中是否有相同的查询结果。如果命中则直接返回，否则继续执行。",
                layer: "server",
                highlight: "SELECT特有，UPDATE不需要"
            },
            {
                id: 4,
                title: "分析器语法分析",
                description: "分析器对SQL语句进行词法分析和语法分析，构建语法树，检查语法正确性。",
                layer: "server",
                highlight: "与UPDATE相似"
            },
            {
                id: 5,
                title: "预处理器",
                description: "检查表和列是否存在，解析别名，验证权限，展开视图等。",
                layer: "server",
                highlight: "SELECT更复杂，可能涉及视图、别名等"
            },
            {
                id: 6,
                title: "优化器生成执行计划",
                description: "优化器分析多种执行方案，选择最优执行计划（索引选择、JOIN顺序等）。",
                layer: "server",
                highlight: "SELECT优化更复杂，涉及JOIN优化、排序优化等"
            },
            {
                id: 7,
                title: "执行器调用存储引擎",
                description: "执行器根据执行计划调用InnoDB存储引擎接口，开始执行查询操作。",
                layer: "server",
                highlight: "与UPDATE相似"
            },
            {
                id: 8,
                title: "Buffer Pool数据查找",
                description: "InnoDB首先在Buffer Pool中查找目标数据页，如果不在则从磁盘加载到Buffer Pool。",
                layer: "innodb-memory",
                highlight: "与UPDATE相同"
            },
            {
                id: 9,
                title: "MVCC版本读取",
                description: "根据事务隔离级别，通过MVCC读取适当版本的数据（快照读）。",
                layer: "innodb-memory",
                highlight: "SELECT特有，利用Undo Log实现多版本"
            },
            {
                id: 10,
                title: "返回数据给执行器",
                description: "存储引擎将查询到的数据返回给执行器进行进一步处理。",
                layer: "innodb-memory",
                highlight: "SELECT特有，UPDATE是修改数据"
            },
            {
                id: 11,
                title: "执行器处理结果",
                description: "执行器对返回的数据进行过滤、排序、分组、JOIN等操作。",
                layer: "server",
                highlight: "SELECT特有，UPDATE不需要结果处理"
            },
            {
                id: 12,
                title: "返回查询结果",
                description: "将最终查询结果返回给客户端，可能涉及网络传输。",
                layer: "client",
                highlight: "SELECT返回结果集，UPDATE返回影响行数"
            }
        ];

        // UPDATE流程步骤（简化版）
        const updateSteps = [
            {
                id: 1,
                title: "客户端发送UPDATE请求",
                description: "客户端应用程序通过MySQL连接发送UPDATE语句到MySQL服务器。",
                layer: "client"
            },
            {
                id: 2,
                title: "连接器验证与连接",
                description: "连接器负责身份验证、连接管理和权限验证，确保客户端有权执行操作。",
                layer: "client"
            },
            {
                id: 3,
                title: "分析器语法分析",
                description: "分析器对SQL语句进行词法分析和语法分析，构建语法树，检查语法正确性。",
                layer: "server"
            },
            {
                id: 4,
                title: "优化器生成执行计划",
                description: "优化器分析多种执行方案，选择最优执行计划（如使用哪个索引）。",
                layer: "server"
            },
            {
                id: 5,
                title: "执行器调用存储引擎",
                description: "执行器根据执行计划调用InnoDB存储引擎接口，开始执行UPDATE操作。",
                layer: "server"
            },
            {
                id: 6,
                title: "Buffer Pool数据查找",
                description: "InnoDB首先在Buffer Pool中查找目标数据页，如果不在则从磁盘加载到Buffer Pool。",
                layer: "innodb-memory"
            },
            {
                id: 7,
                title: "加锁与Undo Log记录",
                description: "加排他锁防止并发修改，将原始数据拷贝到Undo Log，用于事务回滚和MVCC。",
                layer: "innodb-memory"
            },
            {
                id: 8,
                title: "更新Buffer Pool数据",
                description: "在Buffer Pool中更新数据，此时数据页变为脏页（Dirty Page）。",
                layer: "innodb-memory"
            },
            {
                id: 9,
                title: "Redo Log Buffer写入",
                description: "将数据变更记录写入Redo Log Buffer，用于崩溃恢复。",
                layer: "innodb-memory"
            },
            {
                id: 10,
                title: "准备事务提交",
                description: "执行器通知InnoDB准备提交事务，InnoDB进入事务提交阶段。",
                layer: "innodb-memory"
            },
            {
                id: 11,
                title: "Redo Log刷盘",
                description: "将Redo Log Buffer的内容持久化到磁盘的Redo Log文件（Write-Ahead Logging）。",
                layer: "innodb-disk"
            },
            {
                id: 12,
                title: "Binlog写入与提交",
                description: "写入Binlog（如果启用），然后提交事务，释放锁等资源。",
                layer: "server"
            },
            {
                id: 13,
                title: "返回客户端结果",
                description: "将执行结果返回给客户端，告知UPDATE操作影响的行数。",
                layer: "client"
            },
            {
                id: 14,
                title: "后台刷脏页",
                description: "InnoDB后台线程将Buffer Pool中的脏页异步刷回磁盘数据文件。",
                layer: "innodb-disk"
            }
        ];

        // 图层样式映射
        const layerStyles = {
            "client": "layer-client",
            "server": "layer-server",
            "innodb-memory": "layer-innodb-memory",
            "innodb-disk": "layer-innodb-disk"
        };

        // 生成步骤HTML
        function generateStepHTML(step, isSelect) {
            const layerClass = layerStyles[step.layer] || "";
            
            return `
                <div class="step ${isSelect ? 'select' : 'update'}">
                    <div>
                        <span class="step-number ${isSelect ? 'select' : 'update'}">${step.id}</span>
                        <span class="step-title">${step.title}</span>
                    </div>
                    <div class="step-description">${step.description}</div>
                    <div class="step-layer ${layerClass}">${getLayerName(step.layer)}</div>
                </div>
            `;
        }

        // 获取图层名称
        function getLayerName(layerKey) {
            const layerNames = {
                "client": "客户端/连接层",
                "server": "MySQL服务层",
                "innodb-memory": "InnoDB内存层",
                "innodb-disk": "InnoDB磁盘层"
            };
            
            return layerNames[layerKey] || layerKey;
        }

        // 初始化页面
        function init() {
            const selectStepsContainer = document.getElementById('selectSteps');
            const updateStepsContainer = document.getElementById('updateSteps');
            
            // 生成SELECT步骤
            selectSteps.forEach(step => {
                selectStepsContainer.innerHTML += generateStepHTML(step, true);
            });
            
            // 生成UPDATE步骤
            updateSteps.forEach(step => {
                updateStepsContainer.innerHTML += generateStepHTML(step, false);
            });
            
            // 添加交互效果：点击步骤时高亮显示
            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('click', function() {
                    // 移除其他步骤的高亮
                    document.querySelectorAll('.step').forEach(s => {
                        s.style.backgroundColor = '';
                    });
                    
                    // 高亮当前步骤
                    this.style.backgroundColor = '#f0f7ff';
                    
                    // 如果是SELECT步骤，在右侧显示详细信息
                    if (this.classList.contains('select')) {
                        const stepId = this.querySelector('.step-number').textContent;
                        const stepInfo = selectSteps.find(s => s.id == stepId);
                        
                        if (stepInfo) {
                            // 可以在这里添加显示详细信息的逻辑
                            console.log('SELECT步骤详情:', stepInfo);
                        }
                    }
                });
            });
            
            // 初始高亮第一个步骤
            setTimeout(() => {
                const firstStep = document.querySelector('.step');
                if (firstStep) {
                    firstStep.style.backgroundColor = '#f0f7ff';
                }
            }, 500);
        }

        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>