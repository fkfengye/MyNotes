<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多事务并发场景下 Read View 可见性判断流程图</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 18px;
            font-weight: normal;
        }
        
        .scenario-description {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 40px;
            border-left: 5px solid #3498db;
        }
        
        .flowchart-container {
            overflow-x: auto;
            margin-bottom: 40px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 10px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .analysis-section {
            background-color: #fffde7;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 40px;
            border-left: 5px solid #ffc107;
        }
        
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .transaction-table th {
            background-color: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .transaction-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .transaction-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        .transaction-table tr:hover {
            background-color: #f0f7ff;
        }
        
        .time-column {
            font-weight: bold;
            color: #e74c3c;
            width: 120px;
        }
        
        .section-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 40px;
            margin-bottom: 20px;
        }
        
        .key-point {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: bold;
            color: #856404;
        }
        
        .code {
            font-family: 'Courier New', monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .timeline-marker {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .t1-color { background-color: #3498db; }
        .t2-color { background-color: #2ecc71; }
        .t3-color { background-color: #e74c3c; }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .legend {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>多事务并发场景下 Read View 可见性判断流程图</h1>
            <div class="subtitle">三个事务并发执行场景下的 Read View 生成与可见性判断时序分析</div>
        </div>
        
        <div class="scenario-description">
            <h3>场景描述</h3>
            <p>三个事务并发执行，分析 Read View 生成时机与可见性判断逻辑。重点展示在 T1 生成 Read View 时，T2 已提交但 T3 仍活跃的情况下，T1 查询应该看到哪个版本的数据。</p>
            
            <div class="key-point">
                <p><strong>事务角色：</strong></p>
                <ul>
                    <li><span class="timeline-marker t1-color"></span> <strong>T1</strong>：生成 Read View 的事务（隔离级别先不限定）</li>
                    <li><span class="timeline-marker t2-color"></span> <strong>T2</strong>：目标事务（trx_id 会落在 [m_up_limit_id, m_low_limit_id) 且不在 m_ids）</li>
                    <li><span class="timeline-marker t3-color"></span> <strong>T3</strong>：干扰事务（用于模拟"活跃事务"，让 m_up_limit_id 有意义）</li>
                </ul>
            </div>
            
            <div class="key-point">
                <p><strong>初始环境：</strong></p>
                <ul>
                    <li>全局事务 ID 生成器：当前已分配的最大 trx_id = 99，下一个待分配 trx_id = 100</li>
                    <li>表 user 初始数据：id=1, name='A'，DB_TRX_ID=50（早于所有事务提交）</li>
                    <li>事务隔离级别：后续对比 RC（读已提交）和 RR（可重复读）</li>
                </ul>
            </div>
        </div>
        
        <div class="flowchart-container">
            <svg width="1300" height="1250" xmlns="http://www.w3.org/2000/svg">
                <!-- 定义样式和渐变 -->
                <defs>
                    <!-- 渐变定义 -->
                    <linearGradient id="t1Gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#e8f4fd;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#3498db;stop-opacity:0.8" />
                    </linearGradient>
                    
                    <linearGradient id="t2Gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#e8f6ef;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#2ecc71;stop-opacity:0.8" />
                    </linearGradient>
                    
                    <linearGradient id="t3Gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fdedec;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#e74c3c;stop-opacity:0.8" />
                    </linearGradient>
                    
                    <linearGradient id="timeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fff3e0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ffb74d;stop-opacity:0.8" />
                    </linearGradient>
                    
                    <linearGradient id="readViewGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#f3e5f5;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#9c27b0;stop-opacity:0.8" />
                    </linearGradient>
                    
                    <linearGradient id="dataGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#e0f2f1;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#26a69a;stop-opacity:0.8" />
                    </linearGradient>
                    
                    <!-- 箭头标记 -->
                    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" 
                            markerWidth="8" markerHeight="8" orient="auto">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#555" />
                    </marker>
                    
                    <marker id="arrowGreen" viewBox="0 0 10 10" refX="9" refY="5" 
                            markerWidth="8" markerHeight="8" orient="auto">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#2ecc71" />
                    </marker>
                    
                    <marker id="arrowBlue" viewBox="0 0 10 10" refX="9" refY="5" 
                            markerWidth="8" markerHeight="8" orient="auto">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#3498db" />
                    </marker>
                </defs>
                
                <!-- 标题 -->
                <text x="650" y="40" text-anchor="middle" font-size="24" font-weight="bold" fill="#2c3e50">
                    三个事务并发执行时序与 Read View 生成
                </text>
                
                <!-- 时间轴 -->
                <rect x="50" y="80" width="1200" height="50" rx="8" ry="8" 
                      fill="url(#timeGradient)" stroke="#ff9800" stroke-width="2" />
                <text x="650" y="110" text-anchor="middle" font-size="18" font-weight="bold" fill="#5d4037">
                    时间轴 (Time) - 修复T5遮挡问题
                </text>
                
                <!-- 时间点标记 -->
                <g id="timeMarkers">
                    <!-- 时间点1 -->
                    <circle cx="150" cy="80" r="18" fill="#ff9800" stroke="#fff" stroke-width="2" />
                    <text x="150" y="85" text-anchor="middle" font-size="14" font-weight="bold" fill="white">时间点1</text>
                    <text x="150" y="155" text-anchor="middle" font-size="16" font-weight="bold" fill="#e74c3c">T3启动</text>
                    
                    <!-- 时间点2 -->
                    <circle cx="350" cy="80" r="18" fill="#ff9800" stroke="#fff" stroke-width="2" />
                    <text x="350" y="85" text-anchor="middle" font-size="14" font-weight="bold" fill="white">时间点2</text>
                    <text x="350" y="155" text-anchor="middle" font-size="16" font-weight="bold" fill="#e74c3c">T2启动</text>
                    
                    <!-- 时间点3 -->
                    <circle cx="550" cy="80" r="18" fill="#ff9800" stroke="#fff" stroke-width="2" />
                    <text x="550" y="85" text-anchor="middle" font-size="14" font-weight="bold" fill="white">时间点3</text>
                    <text x="550" y="155" text-anchor="middle" font-size="16" font-weight="bold" fill="#e74c3c">T2提交</text>
                    
                    <!-- 时间点4 -->
                    <circle cx="750" cy="80" r="18" fill="#ff9800" stroke="#fff" stroke-width="2" />
                    <text x="750" y="85" text-anchor="middle" font-size="14" font-weight="bold" fill="white">时间点4</text>
                    <text x="750" y="155" text-anchor="middle" font-size="16" font-weight="bold" fill="#e74c3c">T1启动</text>
                    
                    <!-- 时间点5 -->
                    <circle cx="950" cy="80" r="18" fill="#ff9800" stroke="#fff" stroke-width="2" />
                    <text x="950" y="85" text-anchor="middle" font-size="14" font-weight="bold" fill="white">时间点5</text>
                    <text x="950" y="155" text-anchor="middle" font-size="16" font-weight="bold" fill="#e74c3c">T1查询</text>
                    
                    <!-- 连接线 -->
                    <line x1="150" y1="80" x2="350" y2="80" stroke="#ff9800" stroke-width="3" stroke-dasharray="5,5" />
                    <line x1="350" y1="80" x2="550" y2="80" stroke="#ff9800" stroke-width="3" stroke-dasharray="5,5" />
                    <line x1="550" y1="80" x2="750" y2="80" stroke="#ff9800" stroke-width="3" stroke-dasharray="5,5" />
                    <line x1="750" y1="80" x2="950" y2="80" stroke="#ff9800" stroke-width="3" stroke-dasharray="5,5" />
                </g>
                
                <!-- 初始状态 -->
                <rect x="50" y="180" width="1150" height="80" rx="10" ry="10" 
                      fill="#f8f9fa" stroke="#bdc3c7" stroke-width="2" />
                <text x="100" y="210" font-size="16" font-weight="bold" fill="#2c3e50">初始状态：</text>
                <text x="100" y="235" font-size="14" fill="#34495e">全局最大 trx_id = 99，下一个待分配 trx_id = 100</text>
                <text x="100" y="255" font-size="14" fill="#34495e">表 user 数据: id=1, name='A', DB_TRX_ID=50</text>
                
                <!-- 事务T3启动（时间点1） -->
                <rect x="50" y="280" width="1150" height="120" rx="10" ry="10" 
                      fill="url(#t3Gradient)" stroke="#e74c3c" stroke-width="2" />
                <text x="100" y="310" font-size="18" font-weight="bold" fill="#c0392b">时间点1：T3 启动</text>
                <text x="120" y="340" font-size="14" fill="#c0392b">• 分配 trx_id = 80</text>
                <text x="120" y="365" font-size="14" fill="#c0392b">• 执行 UPDATE user SET name='X' WHERE id=1</text>
                <text x="120" y="390" font-size="14" fill="#c0392b">• 事务状态：未提交</text>
                
                <!-- 全局状态变化1 -->
                <rect x="50" y="420" width="1150" height="70" rx="8" ry="8" 
                      fill="#f8f9fa" stroke="#bdc3c7" stroke-width="2" />
                <text x="100" y="450" font-size="14" fill="#2c3e50">全局状态变化：活跃事务 = [T3(80)]，全局最大 trx_id = 80，下一个待分配 trx_id = 81</text>
                
                <!-- 事务T2启动（时间点2） -->
                <rect x="50" y="510" width="1150" height="120" rx="10" ry="10" 
                      fill="url(#t2Gradient)" stroke="#2ecc71" stroke-width="2" />
                <text x="100" y="540" font-size="18" font-weight="bold" fill="#27ae60">时间点2：T2 启动</text>
                <text x="120" y="570" font-size="14" fill="#27ae60">• 分配 trx_id = 95</text>
                <text x="120" y="595" font-size="14" fill="#27ae60">• 执行 UPDATE user SET name='B' WHERE id=1</text>
                <text x="120" y="620" font-size="14" fill="#27ae60">• 事务状态：未提交</text>
                
                <!-- 全局状态变化2 -->
                <rect x="50" y="650" width="1150" height="70" rx="8" ry="8" 
                      fill="#f8f9fa" stroke="#bdc3c7" stroke-width="2" />
                <text x="100" y="680" font-size="14" fill="#2c3e50">全局状态变化：活跃事务 = [T3(80), T2(95)]，全局最大 trx_id = 95，下一个待分配 trx_id = 96</text>
                
                <!-- 事务T2提交（时间点3） -->
                <rect x="50" y="740" width="1150" height="100" rx="10" ry="10" 
                      fill="url(#t2Gradient)" stroke="#2ecc71" stroke-width="2" />
                <rect x="55" y="745" width="1140" height="90" rx="8" ry="8" 
                      fill="rgba(46, 204, 113, 0.1)" stroke="#27ae60" stroke-width="2" stroke-dasharray="5,5" />
                <text x="100" y="770" font-size="18" font-weight="bold" fill="#27ae60">时间点3：T2 提交</text>
                <text x="120" y="800" font-size="14" fill="#27ae60">• trx_id = 95 标记为已提交</text>
                <text x="120" y="825" font-size="14" fill="#27ae60">• 数据版本更新：id=1 的 name='B', DB_TRX_ID=95</text>
                
                <!-- 全局状态变化3 -->
                <rect x="50" y="860" width="1150" height="70" rx="8" ry="8" 
                      fill="#f8f9fa" stroke="#bdc3c7" stroke-width="2" />
                <text x="100" y="890" font-size="14" fill="#2c3e50">全局状态变化：活跃事务 = [T3(80)]（仅 T3 未提交），全局最大 trx_id = 95，下一个待分配 trx_id = 96</text>
                
                <!-- 事务T1启动并生成Read View（时间点4） -->
                <rect x="50" y="950" width="1150" height="140" rx="10" ry="10" 
                      fill="url(#t1Gradient)" stroke="#3498db" stroke-width="2" />
                <text x="100" y="980" font-size="18" font-weight="bold" fill="#2980b9">时间点4：T1 启动并生成 Read View（核心步骤）</text>
                <text x="120" y="1015" font-size="14" fill="#2980b9">• 分配 trx_id = 100（简化处理，启动时分配）</text>
                <text x="120" y="1040" font-size="14" fill="#2980b9">• 第一次执行 SELECT，生成 Read View</text>
                <text x="120" y="1065" font-size="14" fill="#2980b9">• 读取当前全局状态生成 Read View 属性</text>
                
                <!-- Read View 属性框 -->
                <rect x="400" y="1000" width="400" height="80" rx="8" ry="8" 
                      fill="url(#readViewGradient)" stroke="#9c27b0" stroke-width="2" />
                <text x="420" y="1025" font-size="14" fill="#6a1b9a">Read View 属性：</text>
                <text x="440" y="1045" font-size="13" fill="#6a1b9a">• m_creator_trx_id = 100</text>
                <text x="440" y="1065" font-size="13" fill="#6a1b9a">• m_ids = [80]（活跃事务列表）</text>
                <text x="650" y="1045" font-size="13" fill="#6a1b9a">• m_up_limit_id = 80（最小活跃事务ID）</text>
                <text x="650" y="1065" font-size="13" fill="#6a1b9a">• m_low_limit_id = 96（下一个待分配事务ID）</text>
                
                <!-- 数据版本链 -->
                <rect x="850" y="1000" width="300" height="80" rx="8" ry="8" 
                      fill="url(#dataGradient)" stroke="#26a69a" stroke-width="2" />
                <text x="870" y="1025" font-size="14" fill="#00796b">数据版本链：</text>
                <text x="890" y="1045" font-size="13" fill="#00796b">• 最新版本：name='B', DB_TRX_ID=95</text>
                <text x="890" y="1065" font-size="13" fill="#00796b">• 上一版本：name='A', DB_TRX_ID=50</text>
                
                <!-- 事务T1执行查询并判断可见性（时间点5） -->
                <rect x="50" y="1110" width="1150" height="140" rx="10" ry="10" 
                      fill="url(#t1Gradient)" stroke="#3498db" stroke-width="2" />
                <text x="100" y="1140" font-size="18" font-weight="bold" fill="#2980b9">时间点5：T1 执行查询并触发可见性判断</text>
                <text x="120" y="1170" font-size="14" fill="#2980b9">• 执行 SELECT name FROM user WHERE id=1</text>
                <text x="120" y="1195" font-size="14" fill="#2980b9">• 最新数据版本：DB_TRX_ID = 95（T2 提交的修改）</text>
                <text x="120" y="1220" font-size="14" fill="#2980b9">• 触发 Read View 可见性判断逻辑</text>
                
                <!-- 可见性判断过程 -->
                <rect x="400" y="1150" width="400" height="90" rx="8" ry="8" 
                      fill="#fffde7" stroke="#ffc107" stroke-width="2" />
                <text x="420" y="1175" font-size="14" fill="#ff9800">可见性判断过程：</text>
                <text x="440" y="1195" font-size="13" fill="#ff9800">1. 95 != 100（不是自身修改）</text>
                <text x="440" y="1215" font-size="13" fill="#ff9800">2. 95 >= 80（不在活跃事务之前）</text>
                <text x="650" y="1195" font-size="13" fill="#ff9800">3. 95 < 96（不是未来事务）</text>
                <text x="650" y="1215" font-size="13" fill="#ff9800">4. 95 ∉ [80]（不在活跃事务列表中）</text>
                
                <!-- 判断结果 -->
                <rect x="850" y="1150" width="300" height="90" rx="8" ry="8" 
                      fill="#e8f5e9" stroke="#4caf50" stroke-width="2" />
                <text x="870" y="1175" font-size="16" font-weight="bold" fill="#2e7d32">判断结果：</text>
                <text x="890" y="1205" font-size="16" font-weight="bold" fill="#2e7d32">可见！</text>
                <text x="890" y="1225" font-size="14" fill="#2e7d32">查询结果：name='B'</text>
                
                <!-- 连接箭头 -->
                <g id="connectors">
                    <!-- 初始状态 -> T3启动 -->
                    <path d="M 650 260 L 650 280" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                    
                    <!-- T3启动 -> 全局状态1 -->
                    <path d="M 650 400 L 650 420" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                    
                    <!-- 全局状态1 -> T2启动 -->
                    <path d="M 650 490 L 650 510" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                    
                    <!-- T2启动 -> 全局状态2 -->
                    <path d="M 650 630 L 650 650" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                    
                    <!-- 全局状态2 -> T2提交 -->
                    <path d="M 650 720 L 650 740" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                    
                    <!-- T2提交 -> 全局状态3 -->
                    <path d="M 650 840 L 650 860" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                    
                    <!-- 全局状态3 -> T1启动 -->
                    <path d="M 650 930 L 650 950" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                    
                    <!-- T1启动 -> T1查询 -->
                    <path d="M 650 1090 L 650 1110" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                </g>
                
                <!-- 关键分析区域 -->
                <rect x="50" y="1270" width="1150" height="120" rx="10" ry="10" 
                      fill="#e3f2fd" stroke="#2196f3" stroke-width="2" />
                <text x="100" y="1300" font-size="18" font-weight="bold" fill="#1565c0">关键分析：为什么 T2 的修改对 T1 可见？</text>
                <text x="120" y="1330" font-size="14" fill="#1565c0">1. T2 的 trx_id=95 落在 [m_up_limit_id=80, m_low_limit_id=96) 区间内</text>
                <text x="120" y="1350" font-size="14" fill="#1565c0">   • 因为 T2 在 T1 生成 Read View 前启动（时间点2 早于 时间点4），所以 trx_id < m_low_limit_id=96</text>
                <text x="120" y="1370" font-size="14" fill="#1565c0">2. T2 的 trx_id=95 不在 m_ids=[80] 列表中</text>
                <text x="120" y="1390" font-size="14" fill="#1565c0">   • 因为 T2 在 T1 生成 Read View 前已提交（时间点3 早于 时间点4），m_ids 只包含生成快照时活跃未提交的事务</text>
            </svg>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color t1-color"></div>
                <div class="legend-text">T1：生成 Read View 的事务</div>
            </div>
            <div class="legend-item">
                <div class="legend-color t2-color"></div>
                <div class="legend-text">T2：目标事务（已提交）</div>
            </div>
            <div class="legend-item">
                <div class="legend-color t3-color"></div>
                <div class="legend-text">T3：干扰事务（活跃未提交）</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ff9800;"></div>
                <div class="legend-text">时间点标记</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #9c27b0;"></div>
                <div class="legend-text">Read View 属性</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4caf50;"></div>
                <div class="legend-text">可见性判断结果</div>
            </div>
        </div>
        
        <h2 class="section-title">详细时序步骤</h2>
        
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>时间点</th>
                    <th>事务操作</th>
                    <th>全局事务状态变化</th>
                    <th>数据版本链状态</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="time-column">初始状态</td>
                    <td>表 user 初始数据：id=1, name='A', DB_TRX_ID=50</td>
                    <td>全局最大 trx_id = 99，下一个待分配 trx_id = 100</td>
                    <td>版本链：name='A' (DB_TRX_ID=50)</td>
                </tr>
                <tr>
                    <td class="time-column">时间点1</td>
                    <td><span class="timeline-marker t3-color"></span> T3 启动 → 执行 UPDATE user SET name='X' WHERE id=1 → 分配 trx_id=80（未提交）</td>
                    <td>活跃事务：[T3(80)]；全局最大 trx_id=80；下一个待分配 trx_id=81</td>
                    <td>版本链：name='X' (DB_TRX_ID=80, 未提交) ← name='A' (DB_TRX_ID=50)</td>
                </tr>
                <tr>
                    <td class="time-column">时间点2</td>
                    <td><span class="timeline-marker t2-color"></span> T2 启动 → 执行 UPDATE user SET name='B' WHERE id=1 → 分配 trx_id=95（未提交）</td>
                    <td>活跃事务：[T3(80), T2(95)]；全局最大 trx_id=95；下一个待分配 trx_id=96</td>
                    <td>版本链：name='B' (DB_TRX_ID=95, 未提交) ← name='X' (DB_TRX_ID=80, 未提交) ← name='A' (DB_TRX_ID=50)</td>
                </tr>
                <tr>
                    <td class="time-column">时间点3</td>
                    <td><span class="timeline-marker t2-color"></span> T2 提交事务（trx_id=95 标记为已提交）</td>
                    <td>活跃事务：[T3(80)]（仅 T3 未提交）；全局最大 trx_id=95；下一个待分配 trx_id=96</td>
                    <td>版本链：name='B' (DB_TRX_ID=95, 已提交) ← name='X' (DB_TRX_ID=80, 未提交) ← name='A' (DB_TRX_ID=50)</td>
                </tr>
                <tr>
                    <td class="time-column">时间点4</td>
                    <td><span class="timeline-marker t1-color"></span> T1 启动 → 第一次执行 SELECT → 生成 Read View</td>
                    <td>生成 Read View 时读取全局状态：
                        <ul>
                            <li>m_creator_trx_id = 100</li>
                            <li>m_ids = [80]</li>
                            <li>m_up_limit_id = 80</li>
                            <li>m_low_limit_id = 96</li>
                        </ul>
                    </td>
                    <td>版本链不变：name='B' (DB_TRX_ID=95) ← name='X' (DB_TRX_ID=80) ← name='A' (DB_TRX_ID=50)</td>
                </tr>
                <tr>
                    <td class="time-column">时间点5</td>
                    <td><span class="timeline-marker t1-color"></span> T1 执行查询（SELECT name FROM user WHERE id=1） → 触发可见性判断</td>
                    <td>全局状态不变</td>
                    <td><strong>可见性判断：</strong>DB_TRX_ID=95
                        <ul>
                            <li>95 != 100（不是自身修改）</li>
                            <li>95 >= 80（不在活跃事务之前）</li>
                            <li>95 < 96（不是未来事务）</li>
                            <li>95 ∉ [80]（不在活跃事务列表中）</li>
                            <li><strong>结果：可见！查询结果为 name='B'</strong></li>
                        </ul>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <div class="analysis-section">
            <h3>核心原理分析</h3>
            
            <div class="key-point">
                <p><strong>为什么 T2 的修改对 T1 可见？</strong></p>
                <p>T2 的事务 ID (95) 满足以下条件：</p>
                <ol>
                    <li>落在区间 <span class="highlight">[m_up_limit_id=80, m_low_limit_id=96)</span> 内</li>
                    <li><span class="highlight">不在 m_ids=[80] 列表</span>中</li>
                </ol>
                <p>这意味着 T2 是 <span class="highlight">"在 Read View 生成前启动，且在 Read View 生成前已提交"</span> 的事务。</p>
            </div>
            
            <div class="key-point">
                <p><strong>隔离级别的影响（RC vs RR）</strong></p>
                <ul>
                    <li><strong>RC（读已提交）</strong>：每次 SELECT 都会生成新的 Read View。如果 T3 在 T1 第二次查询前提交，那么 T1 的第二次查询将能看到 T3 的修改。</li>
                    <li><strong>RR（可重复读）</strong>：只在第一次 SELECT 时生成 Read View。无论 T3 何时提交，T1 在整个事务期间都使用同一个 Read View，因此永远看不到 T3 的修改（除非 T3 在 T1 生成 Read View 前已提交）。</li>
                </ul>
            </div>
            
            <div class="key-point">
                <p><strong>关键结论</strong></p>
                <p>对于 trx_id 落在 <span class="highlight">[m_up_limit_id, m_low_limit_id)</span> 区间且不在 m_ids 列表中的事务，其修改对当前事务是可见的。这类事务对应于：</p>
                <ul>
                    <li>在 Read View 生成前启动</li>
                    <li>在 Read View 生成前已提交</li>
                    <li>既不是"太早"（小于 m_up_limit_id）也不是"太晚"（大于等于 m_low_limit_id）的事务</li>
                </ul>
            </div>
        </div>
        
        <h2 class="section-title">算法总结</h2>
        
        <div class="code">
// Read View 可见性判断算法简化表示
function isVisible(trx_id, readView) {
    // 1. 检查是否是自身修改
    if (trx_id == readView.creator_trx_id) return true;
    
    // 2. 检查是否在活跃事务列表之前（事务已提交）
    if (trx_id < readView.up_limit_id) return true;
    
    // 3. 检查是否在未来事务之后（Read View生成后才启动）
    if (trx_id >= readView.low_limit_id) return false;
    
    // 4. 检查是否在活跃事务列表中（事务未提交）
    if (readView.ids.contains(trx_id)) return false;
    
    // 5. 其他情况：事务在 Read View 生成前启动且已提交
    return true;
}

// 本场景中的判断过程
const readView = {
    creator_trx_id: 100,
    ids: [80],
    up_limit_id: 80,
    low_limit_id: 96
};

const trx_id = 95; // T2 的事务ID

// 判断步骤：
// 1. 95 != 100 → 不是自身修改
// 2. 95 < 80? → 否，不在活跃事务之前
// 3. 95 >= 96? → 否，不是未来事务
// 4. [80].contains(95)? → 否，不在活跃事务列表中
// 5. 返回 true → 可见！
        </div>
    </div>
</body>
</html>