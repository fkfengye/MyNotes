<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read View 可见性判断流程图</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .description {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }
        
        .svg-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            overflow-x: auto;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .legend-text {
            font-size: 14px;
        }
        
        .code-block {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        
        .note {
            background-color: #fffde7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .svg-container {
                overflow-x: scroll;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Read View 可见性判断流程图</h1>
        
        <div class="description">
            <p><strong>Read View</strong> 是数据库MVCC（多版本并发控制）机制的核心组件，用于确定事务在特定时间点应该看到数据的哪个版本。此流程图展示了判断数据版本是否对当前事务可见的完整逻辑过程。</p>
        </div>
        
        <div class="svg-container">
            <svg width="1100" height="850" xmlns="http://www.w3.org/2000/svg">
                <!-- 定义样式和渐变 -->
                <defs>
                    <!-- 渐变定义 -->
                    <linearGradient id="startGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#e1f5e1;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#c8e6c9;stop-opacity:1" />
                    </linearGradient>
                    
                    <linearGradient id="visibleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#e1f5e1;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#a5d6a7;stop-opacity:1" />
                    </linearGradient>
                    
                    <linearGradient id="invisibleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffebee;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ffcdd2;stop-opacity:1" />
                    </linearGradient>
                    
                    <linearGradient id="decisionGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fff3e0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ffe0b2;stop-opacity:1" />
                    </linearGradient>
                    
                    <linearGradient id="infoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#e8f4fd;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#bbdefb;stop-opacity:1" />
                    </linearGradient>
                    
                    <!-- 箭头标记 -->
                    <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" 
                            markerWidth="6" markerHeight="6" orient="auto">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#555" />
                    </marker>
                    
                    <!-- 虚线样式 -->
                    <pattern id="dashPattern" patternUnits="userSpaceOnUse" width="10" height="10">
                        <path d="M 0,0 l 10,10" stroke="#888" stroke-width="2" stroke-dasharray="5,5" />
                    </pattern>
                </defs>
                
                <!-- 节点 -->
                <!-- 开始节点 -->
                <rect x="50" y="50" width="200" height="60" rx="10" ry="10" 
                      fill="url(#startGradient)" stroke="#4caf50" stroke-width="2" />
                <text x="150" y="85" text-anchor="middle" font-size="14" font-weight="bold">
                    开始读取数据
                </text>
                
                <!-- 获取DB_TRX_ID节点 -->
                <rect x="50" y="150" width="200" height="60" rx="10" ry="10" 
                      fill="url(#infoGradient)" stroke="#2196f3" stroke-width="2" />
                <text x="150" y="180" text-anchor="middle" font-size="13" font-weight="bold">
                    获取版本DB_TRX_ID
                </text>
                <text x="150" y="200" text-anchor="middle" font-size="11">
                    (创建该版本的事务ID)
                </text>
                
                <!-- 决策节点1: DB_TRX_ID == m_creator_trx_id? -->
                <polygon points="50,280 150,240 250,280 150,320" 
                         fill="url(#decisionGradient)" stroke="#ff9800" stroke-width="2" />
                <text x="150" y="285" text-anchor="middle" font-size="13" font-weight="bold">
                    DB_TRX_ID == m_creator_trx_id?
                </text>
                <text x="150" y="300" text-anchor="middle" font-size="11">
                    (是否当前事务自身修改?)
                </text>
                
                <!-- 决策节点2: DB_TRX_ID < m_up_limit_id? -->
                <polygon points="30,440 110,400 190,440 110,480" 
                         fill="url(#decisionGradient)" stroke="#ff9800" stroke-width="2" />
                <text x="110" y="445" text-anchor="middle" font-size="13" font-weight="bold">
                    DB_TRX_ID < m_up_limit_id?
                </text>
                <text x="110" y="460" text-anchor="middle" font-size="11">
                    (是否在活跃事务列表之前?)
                </text>
                
                <!-- 决策节点3: DB_TRX_ID >= m_low_limit_id? -->
                <polygon points="30,600 110,560 190,600 110,640" 
                         fill="url(#decisionGradient)" stroke="#ff9800" stroke-width="2" />
                <text x="110" y="605" text-anchor="middle" font-size="13" font-weight="bold">
                    DB_TRX_ID >= m_low_limit_id?
                </text>
                <text x="110" y="620" text-anchor="middle" font-size="11">
                    (是否在未来事务之后?)
                </text>
                
                <!-- 决策节点4: DB_TRX_ID 在 m_ids 列表中? -->
                <polygon points="30,760 110,720 190,760 110,800" 
                         fill="url(#decisionGradient)" stroke="#ff9800" stroke-width="2" />
                <text x="110" y="765" text-anchor="middle" font-size="13" font-weight="bold">
                    DB_TRX_ID 在 m_ids 列表中?
                </text>
                <text x="110" y="780" text-anchor="middle" font-size="11">
                    (是否活跃事务未提交?)
                </text>
                
                <!-- 可见节点 (自身修改) -->
                <rect x="300" y="220" width="200" height="60" rx="10" ry="10" 
                      fill="url(#visibleGradient)" stroke="#4caf50" stroke-width="2" />
                <text x="400" y="250" text-anchor="middle" font-size="14" font-weight="bold">
                    可见
                </text>
                <text x="400" y="270" text-anchor="middle" font-size="12">
                    (自身修改)
                </text>
                
                <!-- 可见节点 (事务已提交) -->
                <rect x="550" y="680" width="200" height="60" rx="10" ry="10" 
                      fill="url(#visibleGradient)" stroke="#4caf50" stroke-width="2" />
                <text x="650" y="710" text-anchor="middle" font-size="14" font-weight="bold">
                    可见
                </text>
                <text x="650" y="730" text-anchor="middle" font-size="12">
                    (事务已提交)
                </text>
                
                <!-- 不可见节点 (新事务修改) -->
                <rect x="300" y="540" width="200" height="60" rx="10" ry="10" 
                      fill="url(#invisibleGradient)" stroke="#f44336" stroke-width="2" />
                <text x="400" y="570" text-anchor="middle" font-size="14" font-weight="bold">
                    不可见
                </text>
                <text x="400" y="590" text-anchor="middle" font-size="12">
                    (未来事务修改)
                </text>
                
                <!-- 不可见节点 (活跃事务未提交) -->
                <rect x="300" y="700" width="200" height="60" rx="10" ry="10" 
                      fill="url(#invisibleGradient)" stroke="#f44336" stroke-width="2" />
                <text x="400" y="730" text-anchor="middle" font-size="14" font-weight="bold">
                    不可见
                </text>
                <text x="400" y="750" text-anchor="middle" font-size="12">
                    (活跃事务未提交)
                </text>
                
                <!-- 返回结果节点 -->
                <rect x="650" y="220" width="200" height="60" rx="10" ry="10" 
                      fill="url(#startGradient)" stroke="#4caf50" stroke-width="2" />
                <text x="750" y="250" text-anchor="middle" font-size="14" font-weight="bold">
                    返回此版本数据
                </text>
                
                <!-- Read View 结构说明 -->
                <rect x="800" y="50" width="250" height="180" rx="10" ry="10" 
                      fill="url(#infoGradient)" stroke="#2196f3" stroke-width="2" />
                <text x="925" y="80" text-anchor="middle" font-size="16" font-weight="bold">
                    Read View 结构
                </text>
                <text x="850" y="110" font-size="13">• m_ids: 活跃事务ID列表</text>
                <text x="850" y="130" font-size="13">• m_up_limit_id: 最小活跃事务ID</text>
                <text x="850" y="150" font-size="13">• m_low_limit_id: 下一个事务ID</text>
                <text x="850" y="170" font-size="13">• m_creator_trx_id: 创建者事务ID</text>
                <text x="850" y="200" font-size="13">• 生成时机: RC(每次读)/RR(第一次读)</text>
                
                <!-- 连接线 -->
                <!-- 开始 -> 获取DB_TRX_ID -->
                <path d="M 150 110 L 150 150" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                
                <!-- 获取DB_TRX_ID -> 决策节点1 -->
                <path d="M 150 210 L 150 240" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                
                <!-- 决策节点1 -> 可见(自身修改) -->
                <path d="M 250 280 L 300 250" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                <text x="275" y="265" font-size="12" fill="#4caf50" text-anchor="middle">是</text>
                
                <!-- 决策节点1 -> 决策节点2 -->
                <path d="M 150 320 L 150 400" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                <text x="160" y="360" font-size="12" fill="#555" text-anchor="middle">否</text>
                
                <!-- 决策节点2 -> 可见(自身修改) -->
                <path d="M 110 440 Q 110 370 200 310 T 300 250" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                <text x="190" y="370" font-size="12" fill="#4caf50" text-anchor="middle">是</text>
                
                <!-- 决策节点2 -> 决策节点3 -->
                <path d="M 110 480 L 110 560" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                <text x="120" y="520" font-size="12" fill="#555" text-anchor="middle">否</text>
                
                <!-- 决策节点3 -> 不可见(新事务修改) -->
                <path d="M 110 600 Q 110 580 200 570 T 300 570" stroke="#f44336" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                <text x="190" y="580" font-size="12" fill="#f44336" text-anchor="middle">是</text>
                
                <!-- 决策节点3 -> 决策节点4 -->
                <path d="M 110 640 L 110 720" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                <text x="120" y="680" font-size="12" fill="#555" text-anchor="middle">否</text>
                
                <!-- 决策节点4 -> 不可见(活跃事务未提交) -->
                <path d="M 110 760 Q 110 740 200 730 T 300 730" stroke="#f44336" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                <text x="190" y="750" font-size="12" fill="#f44336" text-anchor="middle">是</text>
                
                <!-- 决策节点4 -> 可见(事务已提交) -->
                <path d="M 110 800 Q 110 820 200 830 T 300 840 T 400 830 T 500 820 T 550 710" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                <text x="300" y="830" font-size="12" fill="#4caf50" text-anchor="middle">否</text>
                
                <!-- 不可见(新事务修改) -> 查找上一版本 (虚线) -->
                <path d="M 400 600 L 400 650 L 150 650 L 150 720" stroke="#888" stroke-width="2" fill="none" marker-end="url(#arrow)" stroke-dasharray="5,5" />
                <text x="275" y="640" font-size="12" fill="#888" text-anchor="middle">查找上一版本</text>
                
                <!-- 不可见(活跃事务未提交) -> 查找上一版本 (虚线) -->
                <path d="M 400 760 L 400 780 L 150 780 L 150 720" stroke="#888" stroke-width="2" fill="none" marker-end="url(#arrow)" stroke-dasharray="5,5" />
                <text x="275" y="790" font-size="12" fill="#888" text-anchor="middle">查找上一版本</text>
                
                <!-- 可见(自身修改) -> 返回结果 -->
                <path d="M 500 250 L 650 250" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                
                <!-- 可见(事务已提交) -> 返回结果 -->
                <path d="M 650 710 Q 700 710 750 280" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrow)" />
                
                <!-- 标题 -->
                <text x="550" y="30" text-anchor="middle" font-size="24" font-weight="bold" fill="#2c3e50">
                    Read View 可见性判断流程图
                </text>
            </svg>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e1f5e1;"></div>
                <div class="legend-text">开始/结束节点</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e8f4fd;"></div>
                <div class="legend-text">信息/操作节点</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fff3e0;"></div>
                <div class="legend-text">决策节点</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #a5d6a7;"></div>
                <div class="legend-text">可见结果</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ffcdd2;"></div>
                <div class="legend-text">不可见结果</div>
            </div>
        </div>
        
        <div class="note">
            <h3>关键说明：</h3>
            <ul>
                <li>Read View 判断算法是 MVCC（多版本并发控制）的核心机制</li>
                <li>通过检查数据版本的事务ID与Read View中的信息来决定版本可见性</li>
                <li><strong>RC（读已提交）</strong>：每次SELECT生成新的Read View，能看到已提交的最新数据</li>
                <li><strong>RR（可重复读）</strong>：只在第一次SELECT生成Read View，整个事务期间看到相同的数据快照</li>
                <li>不可见时会沿undo log版本链查找更早的版本重新判断</li>
            </ul>
        </div>
        
        <div class="code-block">
            <h3>Read View 数据结构伪代码：</h3>
            <pre>
class ReadView {
    // 活跃事务ID列表
    List&lt;Integer&gt; m_ids;
    
    // 最小活跃事务ID
    Integer m_up_limit_id;
    
    // 下一个事务ID（当前最大事务ID+1）
    Integer m_low_limit_id;
    
    // 创建该Read View的事务自身ID
    Integer m_creator_trx_id;
    
    // 可见性判断方法
    boolean isVisible(Integer trx_id) {
        // 1. 检查是否是自身修改
        if (trx_id == m_creator_trx_id) return true;
        
        // 2. 检查是否在活跃事务列表之前
        if (trx_id < m_up_limit_id) return true;
        
        // 3. 检查是否在未来事务之后
        if (trx_id >= m_low_limit_id) return false;
        
        // 4. 检查是否在活跃事务列表中
        if (m_ids.contains(trx_id)) return false;
        
        // 5. 其他情况：事务已提交
        return true;
    }
}
            </pre>
        </div>
    </div>
</body>
</html>