<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL InnoDB存储引擎专家级架构图</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(25, 25, 35, 0.9);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(100, 100, 255, 0.3);
        }
        
        h1 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(90deg, #4fc3f7, #29b6f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(79, 195, 247, 0.3);
        }
        
        .subtitle {
            color: #b0bec5;
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
        }
        
        .design-philosophy {
            background: rgba(30, 30, 50, 0.7);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 40px;
            border-left: 5px solid #4fc3f7;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .design-philosophy h2 {
            color: #4fc3f7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .philosophy-points {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .philosophy-point {
            background: rgba(40, 40, 60, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(100, 100, 255, 0.2);
        }
        
        .philosophy-point h3 {
            color: #29b6f6;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .architecture-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 50px;
        }
        
        .diagram-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 40px;
            border-radius: 12px;
            background: rgba(20, 20, 30, 0.8);
            padding: 20px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        #innodb-architecture {
            width: 1500px;
            height: 1100px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 30, 50, 0.7);
            border-radius: 12px;
            max-width: 1000px;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #2962ff, #448aff);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(41, 98, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: linear-gradient(135deg, #1a56db, #2962ff);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(41, 98, 255, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .highlight {
            animation: highlight-pulse 1.5s ease infinite;
        }
        
        @keyframes highlight-pulse {
            0% { filter: drop-shadow(0 0 5px rgba(255, 235, 59, 0.7)); }
            50% { filter: drop-shadow(0 0 15px rgba(255, 235, 59, 0.9)); }
            100% { filter: drop-shadow(0 0 5px rgba(255, 235, 59, 0.7)); }
        }
        
        .flow-animation {
            animation: flow-dash 3s linear infinite;
            stroke-dasharray: 10;
        }
        
        @keyframes flow-dash {
            to {
                stroke-dashoffset: 100;
            }
        }
        
        .tooltip {
            position: absolute;
            background: rgba(20, 20, 30, 0.95);
            color: #e0e0e0;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            max-width: 400px;
            display: none;
            border: 1px solid rgba(100, 100, 255, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            line-height: 1.6;
        }
        
        .tooltip h3 {
            color: #4fc3f7;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .tooltip p {
            margin-bottom: 8px;
        }
        
        .tooltip ul {
            padding-left: 20px;
        }
        
        .tooltip li {
            margin-bottom: 5px;
        }
        
        .core-mechanisms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .mechanism {
            background: rgba(30, 30, 50, 0.7);
            border-radius: 12px;
            padding: 25px;
            border-top: 4px solid;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .mechanism-2pc {
            border-color: #ff7043;
        }
        
        .mechanism-mvcc {
            border-color: #66bb6a;
        }
        
        .mechanism-crash {
            border-color: #ba68c8;
        }
        
        .mechanism h3 {
            color: #e0e0e0;
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mechanism-step {
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 3px solid rgba(100, 100, 255, 0.5);
        }
        
        .mechanism-step h4 {
            color: #90caf9;
            margin-bottom: 5px;
        }
        
        .practical-value {
            background: rgba(30, 30, 50, 0.7);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border-left: 5px solid #ffb74d;
        }
        
        .practical-value h2 {
            color: #ffb74d;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .value-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .value-item {
            background: rgba(40, 40, 60, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 183, 77, 0.2);
        }
        
        .value-item h3 {
            color: #ffcc80;
            margin-bottom: 10px;
        }
        
        .value-item ul {
            padding-left: 20px;
        }
        
        .value-item li {
            margin-bottom: 8px;
            color: #b0bec5;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #78909c;
            font-size: 0.9rem;
            padding-top: 25px;
            border-top: 1px solid rgba(100, 100, 255, 0.2);
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 30, 50, 0.7);
            border-radius: 12px;
            max-width: 1200px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 4px;
        }
        
        .icon {
            margin-right: 8px;
            font-size: 1.2rem;
        }
        
        @media (max-width: 1200px) {
            .container {
                padding: 20px;
            }
            
            #innodb-architecture {
                width: 1200px;
                height: 900px;
            }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
            
            .core-mechanisms {
                grid-template-columns: 1fr;
            }
            
            .value-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>MySQL InnoDB存储引擎专家级架构图</h1>
            <p class="subtitle">分层解耦 + 存储引擎插件化设计 • 内存优先 + 日志先行策略 • 核心机制深度解析</p>
        </header>
        
        <div class="design-philosophy">
            <h2><i class="fas fa-brain"></i> 核心设计思想</h2>
            <p>MySQL架构的核心是<strong>"分层解耦 + 存储引擎插件化"</strong>：</p>
            <div class="philosophy-points">
                <div class="philosophy-point">
                    <h3><i class="fas fa-layer-group"></i> 分层解耦</h3>
                    <p>上层（连接层/服务层）聚焦"通用SQL处理"，下层（存储引擎层）聚焦"数据物理存储+核心特性"，通过统一API实现解耦与协同。</p>
                </div>
                <div class="philosophy-point">
                    <h3><i class="fas fa-plug"></i> 插件化设计</h3>
                    <p>InnoDB作为默认引擎，为高并发、强事务、崩溃安全而设计，MySQL可通过插件机制支持不同存储引擎。</p>
                </div>
                <div class="philosophy-point">
                    <h3><i class="fas fa-memory"></i> 内存优先策略</h3>
                    <p>通过Buffer Pool、Change Buffer等内存组件，最大化减少磁盘I/O，提升性能。</p>
                </div>
                <div class="philosophy-point">
                    <h3><i class="fas fa-file-alt"></i> 日志先行</h3>
                    <p>通过Redo Log、Undo Log等日志机制，在保证ACID特性的同时优化性能。</p>
                </div>
            </div>
        </div>
        
        <div class="architecture-container">
            <div class="controls">
                <button id="highlight-connections"><i class="fas fa-network-wired"></i>高亮连接层</button>
                <button id="highlight-server"><i class="fas fa-server"></i>高亮服务层</button>
                <button id="highlight-engine"><i class="fas fa-database"></i>高亮存储引擎层</button>
                <button id="highlight-memory"><i class="fas fa-memory"></i>高亮内存架构</button>
                <button id="highlight-disks"><i class="fas fa-hdd"></i>高亮磁盘架构</button>
                <button id="show-flows"><i class="fas fa-exchange-alt"></i>显示数据流</button>
                <button id="reset-highlight"><i class="fas fa-redo"></i>重置高亮</button>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff7043;"></div>
                    <span>连接层</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #29b6f6;"></div>
                    <span>服务层 (MySQL Server)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #66bb6a;"></div>
                    <span>存储引擎层 (InnoDB)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ba68c8;"></div>
                    <span>内存架构</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffb74d;"></div>
                    <span>磁盘架构</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4db6ac;"></div>
                    <span>后台线程</span>
                </div>
            </div>
            
            <div class="diagram-container">
                <svg id="innodb-architecture" viewBox="0 0 1500 1100" xmlns="http://www.w3.org/2000/svg">
                    <!-- 定义渐变和滤镜 -->
                    <defs>
                        <!-- 连接层渐变 -->
                        <linearGradient id="connectorGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#ff7043" stop-opacity="0.9" />
                            <stop offset="100%" stop-color="#ff7043" stop-opacity="0.5" />
                        </linearGradient>
                        
                        <!-- 服务层渐变 -->
                        <linearGradient id="serverGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#29b6f6" stop-opacity="0.9" />
                            <stop offset="100%" stop-color="#29b6f6" stop-opacity="0.5" />
                        </linearGradient>
                        
                        <!-- 存储引擎层渐变 -->
                        <linearGradient id="engineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#66bb6a" stop-opacity="0.9" />
                            <stop offset="100%" stop-color="#66bb6a" stop-opacity="0.5" />
                        </linearGradient>
                        
                        <!-- 内存架构渐变 -->
                        <linearGradient id="memoryGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#ba68c8" stop-opacity="0.9" />
                            <stop offset="100%" stop-color="#ba68c8" stop-opacity="0.5" />
                        </linearGradient>
                        
                        <!-- 磁盘架构渐变 -->
                        <linearGradient id="diskGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#ffb74d" stop-opacity="0.9" />
                            <stop offset="100%" stop-color="#ffb74d" stop-opacity="0.5" />
                        </linearGradient>
                        
                        <!-- 阴影滤镜 -->
                        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur in="SourceAlpha" stdDeviation="4" />
                            <feOffset dx="3" dy="3" result="offsetblur" />
                            <feComponentTransfer>
                                <feFuncA type="linear" slope="0.3" />
                            </feComponentTransfer>
                            <feMerge>
                                <feMergeNode />
                                <feMergeNode in="SourceGraphic" />
                            </feMerge>
                        </filter>
                        
                        <!-- 发光滤镜 -->
                        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur" />
                            <feMerge>
                                <feMergeNode in="blur"/>
                                <feMergeNode in="blur"/>
                                <feMergeNode in="blur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                        
                        <!-- 箭头定义 -->
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#29b6f6"/>
                        </marker>
                        
                        <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#ff7043"/>
                        </marker>
                        
                        <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#66bb6a"/>
                        </marker>
                        
                        <marker id="arrowhead-purple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#ba68c8"/>
                        </marker>
                        
                        <marker id="arrowhead-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#ffb74d"/>
                        </marker>
                    </defs>
                    
                    <!-- 架构标题 -->
                    <text x="750" y="50" text-anchor="middle" font-size="28" font-weight="bold" fill="#4fc3f7">MySQL InnoDB存储引擎专家级架构图</text>
                    
                    <!-- ========== 第1层：连接层 ========== -->
                    <rect id="connection-layer" x="50" y="80" width="1400" height="100" rx="10" ry="10" fill="url(#connectorGradient)" stroke="#ff7043" stroke-width="2" filter="url(#shadow)"/>
                    <text x="750" y="140" text-anchor="middle" font-size="22" font-weight="bold" fill="white">连接层 (Connectors/Connection Pool)</text>
                    
                    <!-- 连接层内部组件 -->
                    <g id="connection-components">
                        <!-- 线程模型 -->
                        <rect x="100" y="190" width="300" height="80" rx="8" ry="8" fill="#ff7043" stroke="#e64a19" stroke-width="1.5"/>
                        <text x="250" y="225" text-anchor="middle" font-size="16" font-weight="bold" fill="white">线程模型</text>
                        <text x="250" y="250" text-anchor="middle" font-size="13" fill="white">One-Thread-Per-Connection</text>
                        
                        <!-- 连接池 -->
                        <rect x="450" y="190" width="300" height="80" rx="8" ry="8" fill="#ff7043" stroke="#e64a19" stroke-width="1.5"/>
                        <text x="600" y="225" text-anchor="middle" font-size="16" font-weight="bold" fill="white">连接池 (8.0+ Thread Pool)</text>
                        <text x="600" y="250" text-anchor="middle" font-size="13" fill="white">控制并发线程数</text>
                        
                        <!-- 认证授权 -->
                        <rect x="800" y="190" width="300" height="80" rx="8" ry="8" fill="#ff7043" stroke="#e64a19" stroke-width="1.5"/>
                        <text x="950" y="225" text-anchor="middle" font-size="16" font-weight="bold" fill="white">认证与授权</text>
                        <text x="950" y="250" text-anchor="middle" font-size="13" fill="white">基于mysql.user表(InnoDB)</text>
                        
                        <!-- 协议支持 -->
                        <rect x="1100" y="190" width="300" height="80" rx="8" ry="8" fill="#ff7043" stroke="#e64a19" stroke-width="1.5"/>
                        <text x="1250" y="225" text-anchor="middle" font-size="16" font-weight="bold" fill="white">协议支持</text>
                        <text x="1250" y="250" text-anchor="middle" font-size="13" fill="white">TCP/IP, Socket, 命名管道</text>
                    </g>
                    
                    <!-- 连接层到服务层的箭头 -->
                    <path id="flow-connector-to-server" d="M 750 270 L 750 330" stroke="#29b6f6" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <circle cx="750" cy="300" r="5" fill="#29b6f6"/>
                    
                    <!-- ========== 第2层：服务层 ========== -->
                    <rect id="server-layer" x="50" y="330" width="1400" height="200" rx="10" ry="10" fill="url(#serverGradient)" stroke="#29b6f6" stroke-width="2" filter="url(#shadow)"/>
                    <text x="750" y="380" text-anchor="middle" font-size="22" font-weight="bold" fill="white">服务层 (MySQL Server Layer)</text>
                    
                    <!-- 服务层内部组件 -->
                    <g id="server-components">
                        <!-- SQL接口 -->
                        <rect id="sql-interface" x="100" y="420" width="200" height="80" rx="8" ry="8" fill="#29b6f6" stroke="#0288d1" stroke-width="1.5"/>
                        <text x="200" y="455" text-anchor="middle" font-size="15" font-weight="bold" fill="white">SQL接口</text>
                        <text x="200" y="480" text-anchor="middle" font-size="12" fill="white">DML/DDL/DQL/DCL处理</text>
                        
                        <!-- 解析器 -->
                        <rect id="parser" x="350" y="420" width="200" height="80" rx="8" ry="8" fill="#29b6f6" stroke="#0288d1" stroke-width="1.5"/>
                        <text x="450" y="455" text-anchor="middle" font-size="15" font-weight="bold" fill="white">解析器</text>
                        <text x="450" y="480" text-anchor="middle" font-size="12" fill="white">词法/语法分析 → AST</text>
                        
                        <!-- 优化器 -->
                        <rect id="optimizer" x="600" y="420" width="200" height="80" rx="8" ry="8" fill="#29b6f6" stroke="#0288d1" stroke-width="1.5"/>
                        <text x="700" y="455" text-anchor="middle" font-size="15" font-weight="bold" fill="white">优化器 (CBO)</text>
                        <text x="700" y="480" text-anchor="middle" font-size="12" fill="white">基于成本优化 + 索引统计</text>
                        
                        <!-- 执行器 -->
                        <rect id="executor" x="850" y="420" width="200" height="80" rx="8" ry="8" fill="#29b6f6" stroke="#0288d1" stroke-width="1.5"/>
                        <text x="950" y="455" text-anchor="middle" font-size="15" font-weight="bold" fill="white">执行器</text>
                        <text x="950" y="480" text-anchor="middle" font-size="12" fill="white">调用存储引擎API</text>
                        
                        <!-- Binlog模块 -->
                        <rect id="binlog-module" x="1100" y="420" width="250" height="80" rx="8" ry="8" fill="#29b6f6" stroke="#0288d1" stroke-width="1.5"/>
                        <text x="1225" y="455" text-anchor="middle" font-size="15" font-weight="bold" fill="white">Binlog模块</text>
                        <text x="1225" y="480" text-anchor="middle" font-size="12" fill="white">逻辑日志(主从复制/恢复)</text>
                    </g>
                    
                    <!-- 服务层到存储引擎层的箭头 -->
                    <path id="flow-server-to-engine" d="M 750 530 L 750 590" stroke="#66bb6a" stroke-width="2" marker-end="url(#arrowhead-green)"/>
                    <circle cx="750" cy="560" r="5" fill="#66bb6a"/>
                    
                    <!-- ========== 第3层：存储引擎层 ========== -->
                    <rect id="engine-layer" x="50" y="590" width="1400" height="380" rx="10" ry="10" fill="url(#engineGradient)" stroke="#66bb6a" stroke-width="2" filter="url(#shadow)"/>
                    <text x="750" y="640" text-anchor="middle" font-size="22" font-weight="bold" fill="white">存储引擎层 (InnoDB Engine)</text>
                    
                    <!-- 存储引擎层内部：内存架构 -->
                    <rect id="memory-arch" x="100" y="680" width="600" height="250" rx="8" ry="8" fill="url(#memoryGradient)" stroke="#ba68c8" stroke-width="2" filter="url(#shadow)"/>
                    <text x="400" y="710" text-anchor="middle" font-size="20" font-weight="bold" fill="white">内存架构 (性能核心)</text>
                    
                    <!-- 内存架构组件 -->
                    <g id="memory-components">
                        <!-- Buffer Pool -->
                        <rect id="buffer-pool" x="130" y="740" width="250" height="80" rx="8" ry="8" fill="#ba68c8" stroke="#8e24aa" stroke-width="1.5"/>
                        <text x="255" y="770" text-anchor="middle" font-size="15" font-weight="bold" fill="white">缓冲池 (Buffer Pool)</text>
                        <text x="255" y="795" text-anchor="middle" font-size="12" fill="white">数据页/索引页缓存 (LRU算法)</text>
                        
                        <!-- Change Buffer -->
                        <rect id="change-buffer" x="130" y="840" width="250" height="70" rx="8" ry="8" fill="#ba68c8" stroke="#8e24aa" stroke-width="1.5"/>
                        <text x="255" y="870" text-anchor="middle" font-size="14" font-weight="bold" fill="white">变更缓冲 (Change Buffer)</text>
                        <text x="255" y="890" text-anchor="middle" font-size="11" fill="white">非唯一二级索引异步更新</text>
                        
                        <!-- Log Buffer -->
                        <rect id="log-buffer" x="410" y="740" width="250" height="80" rx="8" ry="8" fill="#ba68c8" stroke="#8e24aa" stroke-width="1.5"/>
                        <text x="535" y="770" text-anchor="middle" font-size="15" font-weight="bold" fill="white">日志缓冲区 (Log Buffer)</text>
                        <text x="535" y="795" text-anchor="middle" font-size="12" fill="white">Redo Log缓存 (innodb_flush_log_at_trx_commit)</text>
                        
                        <!-- Adaptive Hash Index -->
                        <rect id="adaptive-hash" x="410" y="840" width="250" height="70" rx="8" ry="8" fill="#ba68c8" stroke="#8e24aa" stroke-width="1.5"/>
                        <text x="535" y="870" text-anchor="middle" font-size="14" font-weight="bold" fill="white">自适应哈希索引 (AHI)</text>
                        <text x="535" y="890" text-anchor="middle" font-size="11" fill="white">热点数据等值查询加速</text>
                    </g>
                    
                    <!-- 存储引擎层内部：磁盘架构 -->
                    <rect id="disk-arch" x="750" y="680" width="600" height="250" rx="8" ry="8" fill="url(#diskGradient)" stroke="#ffb74d" stroke-width="2" filter="url(#shadow)"/>
                    <text x="1050" y="710" text-anchor="middle" font-size="20" font-weight="bold" fill="white">磁盘架构 (可靠性核心)</text>
                    
                    <!-- 磁盘架构组件 -->
                    <g id="disk-components">
                        <!-- 表空间 -->
                        <rect id="tablespace" x="780" y="740" width="250" height="80" rx="8" ry="8" fill="#ffb74d" stroke="#f57c00" stroke-width="1.5"/>
                        <text x="905" y="770" text-anchor="middle" font-size="15" font-weight="bold" fill="white">表空间 (Tablespace)</text>
                        <text x="905" y="795" text-anchor="middle" font-size="12" fill="white">ibdata1(系统) / *.ibd(独立)</text>
                        
                        <!-- Redo Log -->
                        <rect id="redo-log" x="780" y="840" width="250" height="70" rx="8" ry="8" fill="#ffb74d" stroke="#f57c00" stroke-width="1.5"/>
                        <text x="905" y="870" text-anchor="middle" font-size="14" font-weight="bold" fill="white">重做日志 (Redo Log)</text>
                        <text x="905" y="890" text-anchor="middle" font-size="11" fill="white">物理日志，崩溃恢复，循环写</text>
                        
                        <!-- Undo Log -->
                        <rect id="undo-log" x="1060" y="740" width="250" height="80" rx="8" ry="8" fill="#ffb74d" stroke="#f57c00" stroke-width="1.5"/>
                        <text x="1185" y="770" text-anchor="middle" font-size="15" font-weight="bold" fill="white">回滚日志 (Undo Log)</text>
                        <text x="1185" y="795" text-anchor="middle" font-size="12" fill="white">逻辑日志，事务回滚+MVCC</text>
                        
                        <!-- Double Write Buffer -->
                        <rect id="double-write" x="1060" y="840" width="250" height="70" rx="8" ry="8" fill="#ffb74d" stroke="#f57c00" stroke-width="1.5"/>
                        <text x="1185" y="870" text-anchor="middle" font-size="14" font-weight="bold" fill="white">双写缓冲区</text>
                        <text x="1185" y="890" text-anchor="middle" font-size="11" fill="white">防止部分写失效，数据安全</text>
                    </g>
                    
                    <!-- 存储引擎层内部：后台线程 -->
                    <g id="background-threads">
                        <rect x="100" y="950" width="1300" height="100" rx="8" ry="8" fill="rgba(77, 182, 172, 0.8)" stroke="#4db6ac" stroke-width="2"/>
                        <text x="750" y="980" text-anchor="middle" font-size="18" font-weight="bold" fill="white">后台线程 (自动化管家)</text>
                        
                        <!-- Master Thread -->
                        <rect id="master-thread" x="150" y="1000" width="180" height="35" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="1.5"/>
                        <text x="240" y="1022" text-anchor="middle" font-size="13" fill="white">Master Thread</text>
                        
                        <!-- IO Thread -->
                        <rect id="io-thread" x="380" y="1000" width="150" height="35" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="1.5"/>
                        <text x="455" y="1022" text-anchor="middle" font-size="13" fill="white">IO Thread</text>
                        
                        <!-- Purge Thread -->
                        <rect id="purge-thread" x="580" y="1000" width="150" height="35" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="1.5"/>
                        <text x="655" y="1022" text-anchor="middle" font-size="13" fill="white">Purge Thread</text>
                        
                        <!-- Page Cleaner Thread -->
                        <rect id="page-cleaner" x="780" y="1000" width="180" height="35" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="1.5"/>
                        <text x="870" y="1022" text-anchor="middle" font-size="13" fill="white">Page Cleaner Thread</text>
                        
                        <!-- Deadlock Monitor -->
                        <rect id="deadlock-monitor" x="1010" y="1000" width="180" height="35" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="1.5"/>
                        <text x="1100" y="1022" text-anchor="middle" font-size="13" fill="white">Deadlock Monitor</text>
                    </g>
                    
                    <!-- ========== 数据流连接线 ========== -->
                    <!-- 连接层到服务层内部组件 -->
                    <path class="flow-line" d="M 250 270 L 250 420" stroke="#ff7043" stroke-width="1.5" stroke-dasharray="5,5" fill="none" opacity="0.6"/>
                    <path class="flow-line" d="M 600 270 L 450 420" stroke="#ff7043" stroke-width="1.5" stroke-dasharray="5,5" fill="none" opacity="0.6"/>
                    <path class="flow-line" d="M 950 270 L 700 420" stroke="#ff7043" stroke-width="1.5" stroke-dasharray="5,5" fill="none" opacity="0.6"/>
                    <path class="flow-line" d="M 1250 270 L 950 420" stroke="#ff7043" stroke-width="1.5" stroke-dasharray="5,5" fill="none" opacity="0.6"/>
                    
                    <!-- 服务层内部数据流 -->
                    <path class="flow-line" d="M 200 500 L 350 460" stroke="#29b6f6" stroke-width="2" marker-end="url(#arrowhead)" opacity="0.7"/>
                    <path class="flow-line" d="M 450 500 L 600 460" stroke="#29b6f6" stroke-width="2" marker-end="url(#arrowhead)" opacity="0.7"/>
                    <path class="flow-line" d="M 700 500 L 850 460" stroke="#29b6f6" stroke-width="2" marker-end="url(#arrowhead)" opacity="0.7"/>
                    
                    <!-- Binlog到两阶段提交 -->
                    <path class="flow-line" d="M 1225 500 L 1225 590" stroke="#29b6f6" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)" opacity="0.7"/>
                    
                    <!-- 执行器到存储引擎 -->
                    <path class="flow-line" d="M 950 500 L 750 590" stroke="#29b6f6" stroke-width="2" marker-end="url(#arrowhead-green)" opacity="0.7"/>
                    
                    <!-- 内存架构到磁盘架构的连接 -->
                    <path class="flow-line" d="M 255 820 L 905 820" stroke="#ba68c8" stroke-width="2" stroke-dasharray="5,5" opacity="0.7"/>
                    <path class="flow-line" d="M 535 820 L 1185 820" stroke="#ba68c8" stroke-width="2" stroke-dasharray="5,5" opacity="0.7"/>
                    
                    <!-- 后台线程到内存/磁盘的连接 -->
                    <path class="flow-line" d="M 240 1035 L 240 930" stroke="#4db6ac" stroke-width="1.5" stroke-dasharray="3,3" opacity="0.7"/>
                    <path class="flow-line" d="M 455 1035 L 535 930" stroke="#4db6ac" stroke-width="1.5" stroke-dasharray="3,3" opacity="0.7"/>
                    <path class="flow-line" d="M 655 1035 L 255 930" stroke="#4db6ac" stroke-width="1.5" stroke-dasharray="3,3" opacity="0.7"/>
                    <path class="flow-line" d="M 870 1035 L 905 930" stroke="#4db6ac" stroke-width="1.5" stroke-dasharray="3,3" opacity="0.7"/>
                    <path class="flow-line" d="M 1100 1035 L 535 930" stroke="#4db6ac" stroke-width="1.5" stroke-dasharray="3,3" opacity="0.7"/>
                    
                    <!-- 两阶段提交区域 -->
                    <rect x="600" y="1020" width="300" height="50" rx="8" ry="8" fill="rgba(255, 112, 67, 0.2)" stroke="#ff7043" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="750" y="1050" text-anchor="middle" font-size="16" font-weight="bold" fill="#ff7043">两阶段提交 (2PC)</text>
                    <text x="750" y="1068" text-anchor="middle" font-size="12" fill="#ff7043">保证 Binlog 与 Redo Log 一致性</text>
                    
                    <!-- MVCC机制标注 -->
                    <rect x="50" y="1060" width="300" height="40" rx="8" ry="8" fill="rgba(102, 187, 106, 0.2)" stroke="#66bb6a" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="200" y="1085" text-anchor="middle" font-size="14" font-weight="bold" fill="#66bb6a">MVCC多版本并发控制</text>
                    
                    <!-- 崩溃恢复标注 -->
                    <rect x="1150" y="1060" width="300" height="40" rx="8" ry="8" fill="rgba(186, 104, 200, 0.2)" stroke="#ba68c8" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="1300" y="1085" text-anchor="middle" font-size="14" font-weight="bold" fill="#ba68c8">崩溃恢复机制</text>
                </svg>
            </div>
        </div>
        
        <div class="core-mechanisms">
            <div class="mechanism mechanism-2pc">
                <h3><i class="fas fa-sync-alt"></i> 两阶段提交 (2PC) 机制</h3>
                <p><strong>解决核心问题：</strong>保证 Binlog（服务层）与 Redo Log（InnoDB）的一致性</p>
                
                <div class="mechanism-step">
                    <h4>阶段 1：Prepare</h4>
                    <p>1. InnoDB 执行数据修改，记录 redo log，标记为"Prepare"状态</p>
                    <p>2. InnoDB 返回"Prepare 成功"给执行器</p>
                </div>
                
                <div class="mechanism-step">
                    <h4>阶段 2：Commit</h4>
                    <p>1. 服务层记录 binlog 到磁盘</p>
                    <p>2. 执行器调用 InnoDB "提交事务"，InnoDB 将 redo log 标记为"Commit"状态</p>
                    <p>3. InnoDB 释放行锁，返回"提交成功"</p>
                </div>
                
                <div class="mechanism-step">
                    <h4>崩溃恢复逻辑</h4>
                    <p>• redo log 是"Commit"状态：直接恢复</p>
                    <p>• redo log 是"Prepare"状态：检查 binlog 是否完整 → 完整则提交，不完整则回滚</p>
                </div>
            </div>
            
            <div class="mechanism mechanism-mvcc">
                <h3><i class="fas fa-code-branch"></i> MVCC 多版本并发控制</h3>
                <p><strong>设计目标：</strong>解决"读锁阻塞写、写锁阻塞读"问题，提升高并发性能</p>
                
                <div class="mechanism-step">
                    <h4>实现原理 (RR隔离级别)</h4>
                    <p>• 事务ID (TRX_ID)：每个事务分配唯一递增ID</p>
                    <p>• Undo Log 版本链：数据修改时旧版本存入 Undo Log，形成版本链</p>
                    <p>• Read View：事务第一次读时创建，包含活跃事务ID列表</p>
                </div>
                
                <div class="mechanism-step">
                    <h4>读取规则</h4>
                    <p>从版本链中找"第一个 TRX_ID < min_trx_id 或 TRX_ID 不在活跃事务列表中"的版本</p>
                    <p>保证读取的是"事务启动时已提交的数据"</p>
                </div>
                
                <div class="mechanism-step">
                    <h4>隔离级别差异</h4>
                    <p>• RC（读已提交）：每次读都创建新的 Read View</p>
                    <p>• RR（可重复读）：仅第一次读创建 Read View，结合间隙锁解决幻读</p>
                </div>
            </div>
            
            <div class="mechanism mechanism-crash">
                <h3><i class="fas fa-shield-alt"></i> 崩溃恢复机制</h3>
                <p><strong>设计目标：</strong>保证数据持久性，实现"不死的"存储引擎</p>
                
                <div class="mechanism-step">
                    <h4>恢复流程</h4>
                    <p>1. <strong>Redo 阶段 (前滚)：</strong>读取 Checkpoint 后的 redo log，恢复所有已提交事务</p>
                    <p>2. <strong>Undo 阶段 (回滚)：</strong>扫描 Undo Log，回滚所有未提交事务</p>
                    <p>3. <strong>清理阶段：</strong>Purge 线程清理过期 Undo Log，合并 Change Buffer</p>
                </div>
                
                <div class="mechanism-step">
                    <h4>关键优化</h4>
                    <p>• Checkpoint 标记"已刷盘的 redo log"</p>
                    <p>• 恢复时只需处理 Checkpoint 后的日志，大幅减少恢复时间</p>
                </div>
                
                <div class="mechanism-step">
                    <h4>Double Write Buffer 作用</h4>
                    <p>防止"部分写失效"（刷数据页时断电，页只写了一半）</p>
                    <p>刷数据页时先写双写缓冲区，再写数据文件</p>
                </div>
            </div>
        </div>
        
        <div class="practical-value">
            <h2><i class="fas fa-tools"></i> 架构设计的实战价值</h2>
            <p>理解架构后，能精准定位问题、优化性能：</p>
            
            <div class="value-grid">
                <div class="value-item">
                    <h3><i class="fas fa-tachometer-alt"></i> 性能调优</h3>
                    <ul>
                        <li>增大 <code>innodb_buffer_pool_size</code>（优先）</li>
                        <li>写多读少场景：开启 Change Buffer</li>
                        <li>核心业务：<code>innodb_flush_log_at_trx_commit=1</code> + <code>sync_binlog=1</code>（双1配置）</li>
                        <li>高并发等值查询：利用 Adaptive Hash Index</li>
                    </ul>
                </div>
                
                <div class="value-item">
                    <h3><i class="fas fa-bug"></i> 问题排查</h3>
                    <ul>
                        <li>锁等待：查 InnoDB 锁信息 (<code>show engine innodb status</code>)</li>
                        <li>慢查询：优化器选错索引 → 更新统计信息 (<code>analyze table</code>)</li>
                        <li>磁盘膨胀：长事务导致 Undo Log 膨胀 → Kill 长事务</li>
                        <li>内存不足：监控 Buffer Pool 命中率</li>
                    </ul>
                </div>
                
                <div class="value-item">
                    <h3><i class="fas fa-archway"></i> 架构选型</h3>
                    <ul>
                        <li>核心业务：用 InnoDB（事务/行锁）</li>
                        <li>避免 MyISAM（表锁/无事务）</li>
                        <li>临时表/统计报表：结合 Memory 引擎</li>
                        <li>开启独立表空间 (<code>innodb_file_per_table=1</code>)</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <footer>
            <p>MySQL InnoDB 存储引擎专家级架构图 | 分层解耦 + 内存优先 + 日志先行设计典范</p>
            <p>© 2023 数据库架构深度解析 | 基于 MySQL 8.0 + InnoDB 引擎</p>
        </footer>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // 获取SVG元素和工具提示
        const svg = document.getElementById('innodb-architecture');
        const tooltip = document.getElementById('tooltip');
        
        // 组件详细信息配置
        const components = [
            // 连接层组件
            { id: 'connection-layer', name: '连接层', desc: '负责处理客户端连接，包括连接处理、身份验证、安全等。支持多种线程模型和协议。', details: '• 线程模型：one-thread-per-connection 或线程池<br>• 认证：基于mysql.user表(InnoDB存储)<br>• 协议：TCP/IP, Unix Socket, 命名管道等' },
            
            // 服务层组件
            { id: 'sql-interface', name: 'SQL接口', desc: '接收DML/DDL/DQL/DCL，统一封装为"引擎无关的操作指令"，转发给执行器。', details: '将SQL语句转换为存储引擎无关的操作指令，是服务层的入口' },
            { id: 'parser', name: '解析器', desc: '两步拆解SQL：词法分析（拆分Token）和语法分析（生成AST）。', details: '1. 词法分析：拆分SQL为Token<br>2. 语法分析：生成抽象语法树(AST)<br>3. 输出：结构化的"待执行操作树"' },
            { id: 'optimizer', name: '优化器 (CBO)', desc: '基于成本的优化器，目标是生成"最优执行计划"。依赖InnoDB提供的索引统计信息。', details: '• 计算成本：IO成本 + CPU成本<br>• 选择计划：主键索引vs二级索引、嵌套循环vs哈希连接<br>• 依赖：InnoDB索引统计信息(Cardinality)' },
            { id: 'executor', name: '执行器', desc: '按执行计划调用存储引擎API，是服务层与InnoDB的"直接交互层"。', details: '1. 调用InnoDB API (如ha_innodb::read_row)<br>2. 处理返回数据，过滤/计算<br>3. 处理锁等待(返回Lock wait timeout exceeded)<br>4. 返回结果给客户端' },
            { id: 'binlog-module', name: 'Binlog模块', desc: '服务层的"逻辑日志"，用于主从复制、数据恢复。通过"两阶段提交"保证与redo log一致性。', details: '• 格式：STATEMENT, ROW(默认), MIXED<br>• 作用：主从复制、数据恢复<br>• 与InnoDB协同：通过两阶段提交保证一致性' },
            
            // 内存架构组件
            { id: 'buffer-pool', name: '缓冲池 (Buffer Pool)', desc: 'InnoDB最核心的内存区域，缓存数据页和索引页。采用改进版LRU算法管理。', details: '• 缓存：数据页(16KB)、索引页<br>• 算法：改进版LRU(young/old区，避免预读污染)<br>• 脏页：修改过但未刷盘的页，由Page Cleaner异步刷盘<br>• 预读：线性预读/随机预读，减少后续IO' },
            { id: 'change-buffer', name: '变更缓冲 (Change Buffer)', desc: '减少"非唯一二级索引"的随机IO，对INSERT/UPDATE/DELETE操作先缓存，后续异步合并。', details: '• 目标：减少非唯一二级索引的随机IO<br>• 原理：先缓存变更，查询时或后台线程异步合并<br>• 限制：仅支持非唯一二级索引(唯一索引需校验唯一性)<br>• 场景：写多读少时收益极大' },
            { id: 'log-buffer', name: '日志缓冲区 (Log Buffer)', desc: '缓存redo log，减少磁盘写入次数。刷盘策略由innodb_flush_log_at_trx_commit控制。', details: '• 缓存：redo log<br>• 刷盘策略：<br>  - 0: 每秒刷盘(性能高，崩溃丢1秒数据)<br>  - 1: 事务提交时立即刷盘(最安全，默认)<br>  - 2: 刷到OS缓存，每秒刷盘' },
            { id: 'adaptive-hash', name: '自适应哈希索引 (AHI)', desc: '自动为Buffer Pool中的热点页构建哈希索引，加速等值查询。', details: '• 目标：加速热点数据等值查询(如id=1)<br>• 原理：自动构建哈希索引，等值查询O(1)<br>• 特性：自适应创建/销毁，内存有限(默认占Buffer Pool的1/64)<br>• 适用：高并发等值查询，范围查询无效' },
            
            // 磁盘架构组件
            { id: 'tablespace', name: '表空间', desc: 'InnoDB数据的"容器"，分为系统表空间、独立表空间、临时表空间、通用表空间。', details: '• 系统表空间(ibdata1)：存储元数据、undo log、Double Write Buffer<br>• 独立表空间(*.ibd)：每张表的Data+Index单独存储<br>• 临时表空间(ibtmp1)：存储临时表数据，重启自动清空<br>• 通用表空间：手动创建，可存放多张表' },
            { id: 'redo-log', name: '重做日志 (Redo Log)', desc: '保证事务"持久性"(ACID-D)，解决"数据刷盘慢"的问题。物理日志，循环写。', details: '• 目标：保证事务持久性<br>• 特性：物理日志(记录"页号xxx，偏移量yyy，修改为zzz")<br>• 循环写：固定大小文件组，写满后覆盖旧日志<br>• 价值：事务提交只需写Redo Log(顺序写快)，无需立即刷数据页(随机写慢)' },
            { id: 'undo-log', name: '回滚日志 (Undo Log)', desc: '支持事务回滚 + MVCC多版本控制。逻辑日志，记录修改前的数据。', details: '• 目标：支持事务回滚 + MVCC<br>• 特性：逻辑日志(记录修改前的数据)<br>• 版本链：旧版本存入Undo Log，形成版本链<br>• 生命周期：事务提交后不立即删除(MVCC需要)，由Purge线程异步清理' },
            { id: 'double-write', name: '双写缓冲区', desc: '防止"部分写失效"(刷数据页时断电，页只写了一半)。默认开启，牺牲少量性能换可靠性。', details: '• 解决的问题：部分写失效<br>• 原理：刷数据页时，先写"双写缓冲区"(ibdata1中的连续区域，顺序写)，再写数据文件<br>• 恢复逻辑：崩溃后检查数据页，若损坏则从双写缓冲区读取完整页恢复<br>• 默认开启(innodb_doublewrite=1)' },
            
            // 后台线程
            { id: 'master-thread', name: 'Master Thread', desc: '核心线程，负责"全局调度"：刷Log Buffer、合并Change Buffer、刷脏页、检查Checkpoint。', details: '• 核心职责：全局调度<br>• 每秒：刷Log Buffer到Redo Log<br>• 每10秒：合并Change Buffer + 刷脏页 + 检查Checkpoint' },
            { id: 'io-thread', name: 'IO Thread', desc: '处理异步IO：读IO（读取数据页）、写IO（刷脏页/Redo Log）、Log IO（刷Log Buffer）等。', details: '处理各种异步IO操作：<br>• 读IO：读取数据页<br>• 写IO：刷脏页、Redo Log<br>• Log IO：刷Log Buffer' },
            { id: 'purge-thread', name: 'Purge Thread', desc: '清理过期的Undo Log（事务提交且无MVCC引用的版本），避免Undo Log膨胀。', details: '• 职责：清理过期Undo Log<br>• 条件：事务提交且无MVCC引用的版本<br>• 重要性：避免Undo Log膨胀，释放磁盘空间' },
            { id: 'page-cleaner', name: 'Page Cleaner Thread', desc: '专门负责刷脏页，减轻Master Thread压力（8.0优化）。', details: '• 职责：专门刷脏页<br>• 优化：减轻Master Thread压力(8.0引入)<br>• 配置：可通过innodb_page_cleaners调整线程数' },
            { id: 'deadlock-monitor', name: 'Deadlock Monitor', desc: '定时检测死锁（默认1秒），发现后回滚"代价最小的事务"。', details: '• 检测频率：默认1秒<br>• 处理策略：回滚"代价最小的事务"(如修改行数最少的)<br>• 输出：死锁信息记录到错误日志' }
        ];
        
        // 为每个组件添加事件监听器
        components.forEach(component => {
            const elem = document.getElementById(component.id);
            if (elem) {
                // 鼠标悬停显示工具提示
                elem.addEventListener('mouseover', (e) => {
                    tooltip.style.display = 'block';
                    tooltip.innerHTML = `
                        <h3>${component.name}</h3>
                        <p>${component.desc}</p>
                        ${component.details ? `<div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(100,100,255,0.3)">${component.details}</div>` : ''}
                    `;
                    
                    // 高亮当前组件
                    elem.style.filter = 'url(#glow)';
                });
                
                // 鼠标移动时更新工具提示位置
                elem.addEventListener('mousemove', (e) => {
                    const x = e.clientX + 15;
                    const y = e.clientY + 15;
                    tooltip.style.left = `${x}px`;
                    tooltip.style.top = `${y}px`;
                });
                
                // 鼠标离开时隐藏工具提示
                elem.addEventListener('mouseout', (e) => {
                    tooltip.style.display = 'none';
                    elem.style.filter = 'none';
                });
                
                // 点击时高亮
                elem.addEventListener('click', (e) => {
                    // 移除所有高亮
                    document.querySelectorAll('.highlight').forEach(el => {
                        el.classList.remove('highlight');
                    });
                    
                    // 添加高亮
                    elem.classList.add('highlight');
                    
                    // 防止事件冒泡
                    e.stopPropagation();
                });
            }
        });
        
        // 高亮控制功能
        document.getElementById('highlight-connections').addEventListener('click', () => {
            highlightLayer('connection-layer');
            highlightComponents('connection-components');
        });
        
        document.getElementById('highlight-server').addEventListener('click', () => {
            highlightLayer('server-layer');
            highlightComponents('server-components');
        });
        
        document.getElementById('highlight-engine').addEventListener('click', () => {
            highlightLayer('engine-layer');
            highlightComponents(['memory-arch', 'disk-arch', 'background-threads']);
        });
        
        document.getElementById('highlight-memory').addEventListener('click', () => {
            highlightLayer('memory-arch');
            highlightComponents('memory-components');
        });
        
        document.getElementById('highlight-disks').addEventListener('click', () => {
            highlightLayer('disk-arch');
            highlightComponents('disk-components');
        });
        
        document.getElementById('show-flows').addEventListener('click', () => {
            const flowLines = document.querySelectorAll('.flow-line');
            flowLines.forEach(line => {
                line.style.opacity = '1';
                line.classList.add('flow-animation');
            });
            
            // 3秒后恢复
            setTimeout(() => {
                flowLines.forEach(line => {
                    line.style.opacity = '0.6';
                    line.classList.remove('flow-animation');
                });
            }, 3000);
        });
        
        document.getElementById('reset-highlight').addEventListener('click', () => {
            // 移除所有高亮
            document.querySelectorAll('.highlight').forEach(elem => {
                elem.classList.remove('highlight');
            });
            
            // 重置所有层的边框
            ['connection-layer', 'server-layer', 'engine-layer', 'memory-arch', 'disk-arch'].forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.style.strokeWidth = '2px';
                    elem.style.strokeOpacity = '1';
                }
            });
            
            // 隐藏数据流动画
            const flowLines = document.querySelectorAll('.flow-line');
            flowLines.forEach(line => {
                line.style.opacity = '0.6';
                line.classList.remove('flow-animation');
            });
        });
        
        function highlightLayer(layerId) {
            // 先重置所有高亮
            document.querySelectorAll('.highlight').forEach(elem => {
                elem.classList.remove('highlight');
            });
            
            // 高亮指定层
            const layer = document.getElementById(layerId);
            if (layer) {
                layer.classList.add('highlight');
            }
        }
        
        function highlightComponents(componentIds) {
            if (typeof componentIds === 'string') {
                const group = document.getElementById(componentIds);
                if (group) {
                    const children = group.querySelectorAll('rect');
                    children.forEach(child => {
                        child.classList.add('highlight');
                    });
                }
            } else if (Array.isArray(componentIds)) {
                componentIds.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.classList.add('highlight');
                });
            }
        }
        
        // 点击SVG空白处重置高亮
        svg.addEventListener('click', (e) => {
            if (e.target.tagName === 'svg' || e.target.id === 'innodb-architecture') {
                document.getElementById('reset-highlight').click();
            }
        });
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.key === '1') document.getElementById('highlight-connections').click();
            else if (e.key === '2') document.getElementById('highlight-server').click();
            else if (e.key === '3') document.getElementById('highlight-engine').click();
            else if (e.key === '4') document.getElementById('highlight-memory').click();
            else if (e.key === '5') document.getElementById('highlight-disks').click();
            else if (e.key === 'f') document.getElementById('show-flows').click();
            else if (e.key === '0' || e.key === 'Escape') document.getElementById('reset-highlight').click();
        });
        
        // 添加键盘快捷键提示
        document.addEventListener('keydown', (e) => {
            if (e.key === 'h' && e.ctrlKey) {
                alert('键盘快捷键：\n\n1 - 高亮连接层\n2 - 高亮服务层\n3 - 高亮存储引擎层\n4 - 高亮内存架构\n5 - 高亮磁盘架构\nf - 显示数据流\n0/Esc - 重置高亮');
                e.preventDefault();
            }
        });
    </script>
</body>
</html>