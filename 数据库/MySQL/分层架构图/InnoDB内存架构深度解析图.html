<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InnoDB内存架构深度解析图</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0f1f 0%, #1a1a2e 100%);
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(20, 20, 30, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            padding: 30px;
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(186, 104, 200, 0.3);
        }
        
        h1 {
            color: #ba68c8;
            margin-bottom: 10px;
            font-size: 2.8rem;
            background: linear-gradient(90deg, #ba68c8, #9575cd, #7986cb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 15px rgba(186, 104, 200, 0.3);
        }
        
        .subtitle {
            color: #ce93d8;
            font-size: 1.3rem;
            max-width: 1000px;
            margin: 0 auto;
            line-height: 1.8;
        }
        
        .memory-philosophy {
            background: rgba(30, 30, 50, 0.7);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 40px;
            border-left: 5px solid #ba68c8;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .memory-philosophy h2 {
            color: #ba68c8;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .philosophy-points {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .philosophy-point {
            background: rgba(40, 40, 60, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(186, 104, 200, 0.2);
        }
        
        .philosophy-point h3 {
            color: #ce93d8;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .diagram-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 40px;
            border-radius: 12px;
            background: rgba(15, 15, 25, 0.9);
            padding: 20px;
            box-shadow: inset 0 0 25px rgba(0, 0, 0, 0.6);
            position: relative;
        }
        
        #innodb-memory-architecture {
            width: 1600px;
            height: 1400px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(30, 30, 50, 0.8);
            border-radius: 12px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #ba68c8, #9575cd);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(186, 104, 200, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: linear-gradient(135deg, #9c27b0, #7e57c2);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(186, 104, 200, 0.4);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #757575, #9e9e9e);
        }
        
        button.secondary:hover {
            background: linear-gradient(135deg, #616161, #757575);
        }
        
        .highlight {
            animation: highlight-pulse 1.5s ease infinite;
        }
        
        @keyframes highlight-pulse {
            0% { stroke-width: 3px; stroke: #fff; }
            50% { stroke-width: 4px; stroke: #ffeb3b; }
            100% { stroke-width: 3px; stroke: #fff; }
        }
        
        .flow-animation {
            animation: flow-dash 2s linear infinite;
            stroke-dasharray: 10;
        }
        
        @keyframes flow-dash {
            to {
                stroke-dashoffset: 100;
            }
        }
        
        .tooltip {
            position: absolute;
            background: rgba(15, 15, 25, 0.98);
            color: #e0e0e0;
            padding: 20px;
            border-radius: 12px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            max-width: 500px;
            display: none;
            border: 1px solid rgba(186, 104, 200, 0.3);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7);
            line-height: 1.7;
        }
        
        .tooltip h3 {
            color: #ba68c8;
            margin-bottom: 10px;
            font-size: 18px;
            border-bottom: 1px solid rgba(186, 104, 200, 0.3);
            padding-bottom: 5px;
        }
        
        .tooltip h4 {
            color: #ce93d8;
            margin: 15px 0 8px 0;
            font-size: 16px;
        }
        
        .tooltip p {
            margin-bottom: 12px;
        }
        
        .tooltip ul {
            padding-left: 20px;
            margin-bottom: 12px;
        }
        
        .tooltip li {
            margin-bottom: 6px;
        }
        
        .tooltip .code {
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            color: #ffcc80;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 30, 50, 0.8);
            border-radius: 12px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 4px;
        }
        
        .component-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }
        
        .component-detail {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 12px;
            padding: 25px;
            border-top: 4px solid;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .component-detail h3 {
            color: #e0e0e0;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }
        
        .component-subsection {
            margin-bottom: 20px;
        }
        
        .component-subsection h4 {
            color: #ce93d8;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .component-subsection ul {
            padding-left: 20px;
        }
        
        .component-subsection li {
            margin-bottom: 8px;
            color: #b0bec5;
        }
        
        .memory-optimization {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border-left: 5px solid #4fc3f7;
        }
        
        .memory-optimization h2 {
            color: #4fc3f7;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .optimization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .optimization-item {
            background: rgba(40, 40, 60, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }
        
        .optimization-item h3 {
            color: #90caf9;
            margin-bottom: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: #78909c;
            font-size: 0.9rem;
            padding-top: 25px;
            border-top: 1px solid rgba(186, 104, 200, 0.2);
        }
        
        .icon {
            margin-right: 8px;
            font-size: 1.2rem;
        }
        
        @media (max-width: 1200px) {
            .container {
                padding: 20px;
            }
            
            #innodb-memory-architecture {
                width: 1300px;
                height: 1200px;
            }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 350px;
                justify-content: center;
            }
            
            .component-details {
                grid-template-columns: 1fr;
            }
            
            .philosophy-points {
                grid-template-columns: 1fr;
            }
            
            .optimization-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>InnoDB内存架构深度解析图</h1>
            <p class="subtitle">"用内存换IO"的核心设计 • 性能关键组件 • 内存架构占服务器内存50%-70%</p>
        </header>
        
        <div class="memory-philosophy">
            <h2><i class="fas fa-brain"></i> InnoDB内存架构设计哲学</h2>
            <p>InnoDB性能的关键是<strong>"尽量把磁盘操作放到内存"</strong>，内存架构占服务器内存的50%-70%（<code>innodb_buffer_pool_size</code>是最重要的性能参数）。</p>
            
            <div class="philosophy-points">
                <div class="philosophy-point">
                    <h3><i class="fas fa-bolt"></i> 内存优先策略</h3>
                    <p>通过多级缓存将热点数据和索引保留在内存中，最大限度减少磁盘I/O操作，将随机I/O转换为顺序I/O。</p>
                </div>
                <div class="philosophy-point">
                    <h3><i class="fas fa-layer-group"></i> 分层缓存设计</h3>
                    <p>Buffer Pool主缓存 + Change Buffer二级索引缓存 + AHI热点数据缓存 + Log Buffer日志缓存，形成完整的内存缓存体系。</p>
                </div>
                <div class="philosophy-point">
                    <h3><i class="fas fa-exchange-alt"></i> 智能预读机制</h3>
                    <p>根据数据访问模式智能预读数据，提前将"可能需要的页"加载到内存，减少后续磁盘访问延迟。</p>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="highlight-buffer-pool"><i class="fas fa-layer-group"></i>缓冲池(Buffer Pool)</button>
            <button id="highlight-change-buffer"><i class="fas fa-exchange-alt"></i>变更缓冲(Change Buffer)</button>
            <button id="highlight-adaptive-hash"><i class="fas fa-bolt"></i>自适应哈希索引(AHI)</button>
            <button id="highlight-log-buffer"><i class="fas fa-file-alt"></i>日志缓冲区(Log Buffer)</button>
            <button id="show-lru-mechanism"><i class="fas fa-sort-amount-down"></i>LRU算法机制</button>
            <button id="show-flush-mechanism"><i class="fas fa-tint"></i>脏页刷盘机制</button>
            <button id="show-full-memory-flow"><i class="fas fa-project-diagram"></i>完整内存数据流</button>
            <button id="reset-highlight" class="secondary"><i class="fas fa-redo"></i>重置视图</button>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #9575cd;"></div>
                <span>缓冲池(Buffer Pool)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #7986cb;"></div>
                <span>变更缓冲(Change Buffer)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4fc3f7;"></div>
                <span>自适应哈希索引(AHI)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ba68c8;"></div>
                <span>日志缓冲区(Log Buffer)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ffb74d;"></div>
                <span>磁盘存储</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4db6ac;"></div>
                <span>后台线程</span>
            </div>
        </div>
        
        <div class="diagram-container">
            <svg id="innodb-memory-architecture" viewBox="0 0 1600 1400" xmlns="http://www.w3.org/2000/svg">
                <!-- 定义渐变和滤镜 -->
                <defs>
                    <!-- Buffer Pool渐变 -->
                    <linearGradient id="bufferPoolGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#9575cd" stop-opacity="0.9" />
                        <stop offset="100%" stop-color="#9575cd" stop-opacity="0.5" />
                    </linearGradient>
                    
                    <!-- Change Buffer渐变 -->
                    <linearGradient id="changeBufferGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#7986cb" stop-opacity="0.9" />
                        <stop offset="100%" stop-color="#7986cb" stop-opacity="0.5" />
                    </linearGradient>
                    
                    <!-- AHI渐变 -->
                    <linearGradient id="ahiGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#4fc3f7" stop-opacity="0.9" />
                        <stop offset="100%" stop-color="#4fc3f7" stop-opacity="0.5" />
                    </linearGradient>
                    
                    <!-- Log Buffer渐变 -->
                    <linearGradient id="logBufferGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#ba68c8" stop-opacity="0.9" />
                        <stop offset="100%" stop-color="#ba68c8" stop-opacity="0.5" />
                    </linearGradient>
                    
                    <!-- 磁盘渐变 -->
                    <linearGradient id="diskGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#ffb74d" stop-opacity="0.9" />
                        <stop offset="100%" stop-color="#ffb74d" stop-opacity="0.5" />
                    </linearGradient>
                    
                    <!-- 发光滤镜 -->
                    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur" />
                        <feMerge>
                            <feMergeNode in="blur"/>
                            <feMergeNode in="blur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    
                    <!-- 箭头定义 -->
                    <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto">
                        <path d="M0,0 L8,4 L0,8 Z" fill="#4fc3f7" stroke="none"/>
                    </marker>
                    
                    <marker id="arrowhead-purple" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto">
                        <path d="M0,0 L8,4 L0,8 Z" fill="#9575cd" stroke="none"/>
                    </marker>
                    
                    <marker id="arrowhead-blue" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto">
                        <path d="M0,0 L8,4 L0,8 Z" fill="#7986cb" stroke="none"/>
                    </marker>
                    
                    <marker id="arrowhead-teal" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto">
                        <path d="M0,0 L8,4 L0,8 Z" fill="#4fc3f7" stroke="none"/>
                    </marker>
                    
                    <marker id="arrowhead-pink" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto">
                        <path d="M0,0 L8,4 L0,8 Z" fill="#ba68c8" stroke="none"/>
                    </marker>
                    
                    <marker id="arrowhead-orange" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto">
                        <path d="M0,0 L8,4 L0,8 Z" fill="#ffb74d" stroke="none"/>
                    </marker>
                    
                    <marker id="arrowhead-green" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto">
                        <path d="M0,0 L8,4 L0,8 Z" fill="#4db6ac" stroke="none"/>
                    </marker>
                </defs>
                
                <!-- 架构标题 -->
                <text x="800" y="50" text-anchor="middle" font-size="32" font-weight="bold" fill="#ba68c8">InnoDB内存架构深度解析图</text>
                <text x="800" y="85" text-anchor="middle" font-size="18" fill="#ce93d8">"用内存换IO"的核心设计 • 性能关键组件</text>
                
                <!-- 内存架构容器 -->
                <rect x="50" y="120" width="1500" height="1150" rx="10" ry="10" fill="rgba(30, 30, 50, 0.5)" stroke="#ba68c8" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="800" y="150" text-anchor="middle" font-size="26" font-weight="bold" fill="#ba68c8">InnoDB Memory Architecture (内存架构)</text>
                
                <!-- 左侧：Buffer Pool详细结构 -->
                <rect id="buffer-pool-container" x="100" y="200" width="650" height="650" rx="8" ry="8" fill="url(#bufferPoolGradient)" stroke="#9575cd" stroke-width="3"/>
                <text x="425" y="240" text-anchor="middle" font-size="28" font-weight="bold" fill="white">缓冲池 (Buffer Pool)</text>
                <text x="425" y="275" text-anchor="middle" font-size="18" fill="white" font-style="italic">缓存数据页(16KB)和索引页，InnoDB最核心的内存区域</text>
                
                <!-- Buffer Pool内部结构 -->
                <g id="buffer-pool-internal">
                    <!-- 内存池标注 -->
                    <rect x="120" y="300" width="610" height="40" rx="6" ry="6" fill="#b39ddb" stroke="#7e57c2" stroke-width="2"/>
                    <text x="425" y="325" text-anchor="middle" font-size="16" font-weight="bold" fill="white">总大小: innodb_buffer_pool_size (建议占服务器内存50%-70%)</text>
                    
                    <!-- 改进LRU链表 -->
                    <rect id="lru-list" x="120" y="360" width="610" height="250" rx="6" ry="6" fill="#9575cd" stroke="#7e57c2" stroke-width="2"/>
                    <text x="425" y="390" text-anchor="middle" font-size="22" font-weight="bold" fill="white">改进LRU链表 (避免预读污染)</text>
                    
                    <!-- Young区 (5/8) -->
                    <rect id="young-area" x="140" y="420" width="570" height="80" rx="6" ry="6" fill="#7e57c2" stroke="#5e35b1" stroke-width="2"/>
                    <text x="425" y="460" text-anchor="middle" font-size="20" font-weight="bold" fill="white">Young区 (5/8) - 热点数据</text>
                    <text x="425" y="485" text-anchor="middle" font-size="14" fill="white">频繁访问的页，位于链表头部</text>
                    
                    <!-- Old区 (3/8) -->
                    <rect id="old-area" x="140" y="510" width="570" height="80" rx="6" ry="6" fill="#9575cd" stroke="#7e57c2" stroke-width="2"/>
                    <text x="425" y="550" text-anchor="middle" font-size="20" font-weight="bold" fill="white">Old区 (3/8) - 新加载数据</text>
                    <text x="425" y="575" text-anchor="middle" font-size="14" fill="white">新页先放入此区域尾部，访问后移到Young区</text>
                    
                    <!-- 预读机制 -->
                    <rect id="read-ahead" x="120" y="620" width="300" height="100" rx="6" ry="6" fill="#9575cd" stroke="#7e57c2" stroke-width="2"/>
                    <text x="270" y="650" text-anchor="middle" font-size="18" font-weight="bold" fill="white">预读机制 (Read Ahead)</text>
                    <text x="270" y="680" text-anchor="middle" font-size="14" fill="white">提前加载"可能需要的页"</text>
                    <text x="270" y="700" text-anchor="middle" font-size="12" fill="white">线性预读 / 随机预读</text>
                    
                    <!-- 脏页管理 -->
                    <rect id="dirty-page" x="430" y="620" width="300" height="100" rx="6" ry="6" fill="#9575cd" stroke="#7e57c2" stroke-width="2"/>
                    <text x="580" y="650" text-anchor="middle" font-size="18" font-weight="bold" fill="white">脏页管理 (Dirty Pages)</text>
                    <text x="580" y="680" text-anchor="middle" font-size="14" fill="white">修改过但未刷盘的页</text>
                    <text x="580" y="700" text-anchor="middle" font-size="12" fill="white">由Page Cleaner线程异步刷盘</text>
                    
                    <!-- 页类型 -->
                    <rect x="120" y="730" width="610" height="100" rx="6" ry="6" fill="#b39ddb" stroke="#7e57c2" stroke-width="2"/>
                    <text x="425" y="760" text-anchor="middle" font-size="18" font-weight="bold" fill="white">缓存页类型 (16KB/页)</text>
                    
                    <g id="page-types">
                        <rect x="140" y="790" width="180" height="30" rx="4" ry="4" fill="#d1c4e9" stroke="#7e57c2" stroke-width="1"/>
                        <text x="230" y="810" text-anchor="middle" font-size="13" fill="white">数据页 (Data Pages)</text>
                        
                        <rect x="330" y="790" width="180" height="30" rx="4" ry="4" fill="#d1c4e9" stroke="#7e57c2" stroke-width="1"/>
                        <text x="420" y="810" text-anchor="middle" font-size="13" fill="white">索引页 (Index Pages)</text>
                        
                        <rect x="520" y="790" width="180" height="30" rx="4" ry="4" fill="#d1c4e9" stroke="#7e57c2" stroke-width="1"/>
                        <text x="610" y="810" text-anchor="middle" font-size="13" fill="white">自适应哈希页</text>
                    </g>
                </g>
                
                <!-- 中间：Change Buffer和AHI -->
                <rect id="change-buffer-container" x="770" y="200" width="350" height="300" rx="8" ry="8" fill="url(#changeBufferGradient)" stroke="#7986cb" stroke-width="3"/>
                <text x="945" y="240" text-anchor="middle" font-size="24" font-weight="bold" fill="white">变更缓冲 (Change Buffer)</text>
                <text x="945" y="270" text-anchor="middle" font-size="16" fill="white" font-style="italic">减少"非唯一二级索引"的随机IO</text>
                
                <!-- Change Buffer内部 -->
                <g id="change-buffer-internal">
                    <rect x="790" y="300" width="310" height="80" rx="6" ry="6" fill="#7986cb" stroke="#5c6bc0" stroke-width="2"/>
                    <text x="945" y="340" text-anchor="middle" font-size="18" font-weight="bold" fill="white">变更缓存区</text>
                    <text x="945" y="365" text-anchor="middle" font-size="14" fill="white">INSERT/UPDATE/DELETE操作先缓存于此</text>
                    
                    <rect x="790" y="390" width="310" height="90" rx="6" ry="6" fill="#7986cb" stroke="#5c6bc0" stroke-width="2"/>
                    <text x="945" y="425" text-anchor="middle" font-size="16" font-weight="bold" fill="white">异步合并机制</text>
                    <text x="945" y="450" text-anchor="middle" font-size="13" fill="white">查询该索引时或后台线程定期合并</text>
                    <text x="945" y="470" text-anchor="middle" font-size="12" fill="white">将变更应用到磁盘索引页</text>
                    
                    <!-- 限制条件 -->
                    <rect x="830" y="490" width="230" height="60" rx="4" ry="4" fill="#9fa8da" stroke="#5c6bc0" stroke-width="1"/>
                    <text x="945" y="515" text-anchor="middle" font-size="13" fill="white">仅支持非唯一二级索引</text>
                    <text x="945" y="535" text-anchor="middle" font-size="11" fill="white">(唯一索引需立即访问磁盘校验唯一性)</text>
                </g>
                
                <!-- AHI (自适应哈希索引) -->
                <rect id="adaptive-hash-index" x="770" y="520" width="350" height="200" rx="8" ry="8" fill="url(#ahiGradient)" stroke="#4fc3f7" stroke-width="3"/>
                <text x="945" y="560" text-anchor="middle" font-size="24" font-weight="bold" fill="white">自适应哈希索引 (AHI)</text>
                <text x="945" y="590" text-anchor="middle" font-size="16" fill="white" font-style="italic">加速热点数据等值查询</text>
                
                <!-- AHI内部 -->
                <g id="ahi-internal">
                    <rect x="790" y="620" width="310" height="80" rx="6" ry="6" fill="#4fc3f7" stroke="#0288d1" stroke-width="2"/>
                    <text x="945" y="655" text-anchor="middle" font-size="18" font-weight="bold" fill="white">自动创建/销毁</text>
                    <text x="945" y="680" text-anchor="middle" font-size="14" fill="white">为Buffer Pool中的热点页自动构建哈希索引</text>
                    
                    <rect x="790" y="710" width="310" height="80" rx="6" ry="6" fill="#4fc3f7" stroke="#0288d1" stroke-width="2"/>
                    <text x="945" y="745" text-anchor="middle" font-size="18" font-weight="bold" fill="white">O(1)等值查询</text>
                    <text x="945" y="770" text-anchor="middle" font-size="14" fill="white">哈希索引等值查询比B+树快</text>
                </g>
                
                <!-- Log Buffer -->
                <rect id="log-buffer-container" x="770" y="740" width="350" height="200" rx="8" ry="8" fill="url(#logBufferGradient)" stroke="#ba68c8" stroke-width="3"/>
                <text x="945" y="780" text-anchor="middle" font-size="24" font-weight="bold" fill="white">日志缓冲区 (Log Buffer)</text>
                <text x="945" y="810" text-anchor="middle" font-size="16" fill="white" font-style="italic">缓存redo log，减少磁盘写入次数</text>
                
                <!-- Log Buffer内部 -->
                <g id="log-buffer-internal">
                    <rect x="790" y="840" width="310" height="80" rx="6" ry="6" fill="#ba68c8" stroke="#9c27b0" stroke-width="2"/>
                    <text x="945" y="875" text-anchor="middle" font-size="18" font-weight="bold" fill="white">Redo Log缓存区</text>
                    <text x="945" y="900" text-anchor="middle" font-size="14" fill="white">事务修改先记录到内存缓冲区</text>
                    
                    <!-- 刷盘策略 -->
                    <g id="flush-policy">
                        <rect x="790" y="930" width="310" height="60" rx="4" ry="4" fill="#ce93d8" stroke="#9c27b0" stroke-width="1"/>
                        <text x="945" y="955" text-anchor="middle" font-size="16" font-weight="bold" fill="white">刷盘策略: innodb_flush_log_at_trx_commit</text>
                        
                        <!-- 策略选项 -->
                        <rect x="810" y="1000" width="90" height="30" rx="4" ry="4" fill="#f48fb1" stroke="#ad1457" stroke-width="1"/>
                        <text x="855" y="1020" text-anchor="middle" font-size="12" fill="white">=0 (每秒)</text>
                        
                        <rect x="910" y="1000" width="90" height="30" rx="4" ry="4" fill="#f48fb1" stroke="#ad1457" stroke-width="1"/>
                        <text x="955" y="1020" text-anchor="middle" font-size="12" fill="white">=1 (实时)</text>
                        
                        <rect x="1010" y="1000" width="90" height="30" rx="4" ry="4" fill="#f48fb1" stroke="#ad1457" stroke-width="1"/>
                        <text x="1055" y="1020" text-anchor="middle" font-size="12" fill="white">=2 (OS缓存)</text>
                    </g>
                </g>
                
                <!-- 右侧：磁盘存储结构 -->
                <rect id="disk-storage" x="1140" y="200" width="400" height="650" rx="8" ry="8" fill="url(#diskGradient)" stroke="#ffb74d" stroke-width="3"/>
                <text x="1340" y="240" text-anchor="middle" font-size="24" font-weight="bold" fill="white">磁盘存储 (Disk Storage)</text>
                <text x="1340" y="270" text-anchor="middle" font-size="16" fill="white" font-style="italic">数据持久化存储</text>
                
                <!-- 磁盘存储内部 -->
                <g id="disk-storage-internal">
                    <!-- 数据文件 -->
                    <rect x="1160" y="300" width="360" height="100" rx="6" ry="6" fill="#ffb74d" stroke="#f57c00" stroke-width="2"/>
                    <text x="1340" y="340" text-anchor="middle" font-size="20" font-weight="bold" fill="white">数据文件 (*.ibd)</text>
                    <text x="1340" y="370" text-anchor="middle" font-size="14" fill="white">表数据和索引的持久化存储</text>
                    <text x="1340" y="390" text-anchor="middle" font-size="12" fill="white">独立表空间 (innodb_file_per_table=1)</text>
                    
                    <!-- 二级索引 -->
                    <rect x="1160" y="410" width="360" height="80" rx="6" ry="6" fill="#ffb74d" stroke="#f57c00" stroke-width="2"/>
                    <text x="1340" y="445" text-anchor="middle" font-size="18" font-weight="bold" fill="white">二级索引 (Secondary Index)</text>
                    <text x="1340" y="470" text-anchor="middle" font-size="14" fill="white">非唯一索引，Change Buffer优化目标</text>
                    
                    <!-- Redo Log文件 -->
                    <rect x="1160" y="500" width="360" height="100" rx="6" ry="6" fill="#ffb74d" stroke="#f57c00" stroke-width="2"/>
                    <text x="1340" y="535" text-anchor="middle" font-size="20" font-weight="bold" fill="white">Redo Log文件 (ib_logfile*)</text>
                    <text x="1340" y="565" text-anchor="middle" font-size="14" fill="white">事务持久性保证，循环写入</text>
                    <text x="1340" y="585" text-anchor="middle" font-size="12" fill="white">物理日志，崩溃恢复使用</text>
                    
                    <!-- 系统表空间 -->
                    <rect x="1160" y="610" width="360" height="80" rx="6" ry="6" fill="#ffb74d" stroke="#f57c00" stroke-width="2"/>
                    <text x="1340" y="645" text-anchor="middle" font-size="18" font-weight="bold" fill="white">系统表空间 (ibdata1)</text>
                    <text x="1340" y="670" text-anchor="middle" font-size="14" fill="white">元数据、Undo Log、Double Write Buffer</text>
                    
                    <!-- 数据页结构 -->
                    <rect x="1160" y="700" width="360" height="80" rx="6" ry="6" fill="#ffb74d" stroke="#f57c00" stroke-width="2"/>
                    <text x="1340" y="735" text-anchor="middle" font-size="18" font-weight="bold" fill="white">数据页结构 (16KB)</text>
                    <text x="1340" y="760" text-anchor="middle" font-size="14" fill="white">页头 + 行数据 + 页尾，B+树组织</text>
                </g>
                
                <!-- 底部：后台线程 -->
                <rect x="100" y="870" width="1400" height="120" rx="8" ry="8" fill="rgba(77, 182, 172, 0.8)" stroke="#4db6ac" stroke-width="3"/>
                <text x="800" y="910" text-anchor="middle" font-size="24" font-weight="bold" fill="white">后台线程 (Background Threads)</text>
                
                <!-- 后台线程组件 -->
                <g id="background-threads">
                    <rect id="page-cleaner" x="150" y="940" width="200" height="40" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="2"/>
                    <text x="250" y="965" text-anchor="middle" font-size="15" fill="white">Page Cleaner Thread</text>
                    
                    <rect id="io-thread" x="380" y="940" width="160" height="40" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="2"/>
                    <text x="460" y="965" text-anchor="middle" font-size="15" fill="white">IO Thread</text>
                    
                    <rect id="master-thread" x="570" y="940" width="180" height="40" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="2"/>
                    <text x="660" y="965" text-anchor="middle" font-size="15" fill="white">Master Thread</text>
                    
                    <rect id="log-thread" x="780" y="940" width="150" height="40" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="2"/>
                    <text x="855" y="965" text-anchor="middle" font-size="15" fill="white">Log Thread</text>
                    
                    <rect id="purge-thread" x="960" y="940" width="160" height="40" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="2"/>
                    <text x="1040" y="965" text-anchor="middle" font-size="15" fill="white">Purge Thread</text>
                    
                    <rect id="read-thread" x="1150" y="940" width="160" height="40" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="2"/>
                    <text x="1230" y="965" text-anchor="middle" font-size="15" fill="white">Read Thread</text>
                    
                    <rect id="write-thread" x="1330" y="940" width="160" height="40" rx="6" ry="6" fill="#4db6ac" stroke="#00897b" stroke-width="2"/>
                    <text x="1410" y="965" text-anchor="middle" font-size="15" fill="white">Write Thread</text>
                </g>
                
                <!-- 关键标注：内存换IO -->
                <rect x="100" y="1010" width="400" height="50" rx="6" ry="6" fill="rgba(186, 104, 200, 0.2)" stroke="#ba68c8" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="300" y="1040" text-anchor="middle" font-size="16" font-weight="bold" fill="#ba68c8">内存换IO核心策略</text>
                <text x="300" y="1055" text-anchor="middle" font-size="12" fill="#ba68c8">将磁盘操作尽可能转换为内存操作</text>
                
                <!-- 关键标注：调优参数 -->
                <rect x="520" y="1010" width="350" height="50" rx="6" ry="6" fill="rgba(149, 117, 205, 0.2)" stroke="#9575cd" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="695" y="1040" text-anchor="middle" font-size="16" font-weight="bold" fill="#9575cd">关键调优参数</text>
                <text x="695" y="1055" text-anchor="middle" font-size="12" fill="#9575cd">innodb_buffer_pool_size (50%-70%内存)</text>
                
                <!-- 关键标注：适用场景 -->
                <rect x="890" y="1010" width="350" height="50" rx="6" ry="6" fill="rgba(121, 134, 203, 0.2)" stroke="#7986cb" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="1065" y="1040" text-anchor="middle" font-size="16" font-weight="bold" fill="#7986cb">适用场景</text>
                <text x="1065" y="1055" text-anchor="middle" font-size="12" fill="#7986cb">写多读少(Change Buffer)，高并发等值查询(AHI)</text>
                
                <!-- 关键标注：刷盘策略 -->
                <rect x="1260" y="1010" width="240" height="50" rx="6" ry="6" fill="rgba(79, 195, 247, 0.2)" stroke="#4fc3f7" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="1380" y="1040" text-anchor="middle" font-size="16" font-weight="bold" fill="#4fc3f7">刷盘策略</text>
                <text x="1380" y="1055" text-anchor="middle" font-size="12" fill="#4fc3f7">金融场景=1，非核心场景=0/2</text>
                
                <!-- ========== 数据流向连接线 ========== -->
                <!-- Buffer Pool内部流向 -->
                <path class="buffer-pool-flow" d="M 425 500 L 425 510" stroke="#7e57c2" stroke-width="2" marker-end="url(#arrowhead-purple)" opacity="0.9"/>
                <path class="buffer-pool-flow" d="M 425 590 L 425 600" stroke="#9575cd" stroke-width="2" marker-end="url(#arrowhead-purple)" opacity="0.9"/>
                
                <!-- Buffer Pool到磁盘的刷盘 -->
                <path class="flush-flow" d="M 580 720 L 1140 720 L 1140 340" stroke="#9575cd" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead-orange)" opacity="0.8"/>
                
                <!-- Change Buffer到磁盘的合并 -->
                <path class="change-buffer-flow" d="M 945 580 L 1140 580 L 1140 450" stroke="#7986cb" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead-blue)" opacity="0.8"/>
                
                <!-- AHI到Buffer Pool的连接 -->
                <path class="ahi-flow" d="M 945 710 L 750 710 L 750 790" stroke="#4fc3f7" stroke-width="2" marker-end="url(#arrowhead-teal)" opacity="0.8"/>
                
                <!-- Log Buffer到磁盘 -->
                <path class="log-buffer-flow" d="M 945 920 L 1140 920 L 1140 535" stroke="#ba68c8" stroke-width="2" marker-end="url(#arrowhead-pink)" opacity="0.8"/>
                
                <!-- 后台线程到各组件 -->
                <path class="thread-flow" d="M 250 940 L 250 860" stroke="#4db6ac" stroke-width="1.5" stroke-dasharray="3,3" marker-end="url(#arrowhead-green)" opacity="0.7"/>
                <path class="thread-flow" d="M 460 940 L 425 860" stroke="#4db6ac" stroke-width="1.5" stroke-dasharray="3,3" marker-end="url(#arrowhead-green)" opacity="0.7"/>
                <path class="thread-flow" d="M 660 940 L 580 860" stroke="#4db6ac" stroke-width="1.5" stroke-dasharray="3,3" marker-end="url(#arrowhead-green)" opacity="0.7"/>
                <path class="thread-flow" d="M 855 940 L 945 860" stroke="#4db6ac" stroke-width="1.5" stroke-dasharray="3,3" marker-end="url(#arrowhead-green)" opacity="0.7"/>
                
                <!-- 磁盘到Buffer Pool的读取 -->
                <path class="read-flow" d="M 1340 340 L 1340 300 L 750 300 L 750 420" stroke="#ffb74d" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead-purple)" opacity="0.8"/>
                
                <!-- 预读机制标注 -->
                <rect x="270" y="630" width="200" height="30" rx="4" ry="4" fill="rgba(149, 117, 205, 0.3)" stroke="#9575cd" stroke-width="1"/>
                <text x="370" y="650" text-anchor="middle" font-size="12" fill="#9575cd">减少后续IO，提升性能</text>
                
                <!-- 脏页刷盘触发条件 -->
                <rect x="580" y="630" width="200" height="30" rx="4" ry="4" fill="rgba(149, 117, 205, 0.3)" stroke="#9575cd" stroke-width="1"/>
                <text x="680" y="650" text-anchor="middle" font-size="12" fill="#9575cd">Buffer Pool满 / redo log满 / 定时</text>
                
                <!-- Change Buffer适用场景 -->
                <rect x="830" y="560" width="230" height="30" rx="4" ry="4" fill="rgba(121, 134, 203, 0.3)" stroke="#7986cb" stroke-width="1"/>
                <text x="945" y="580" text-anchor="middle" font-size="12" fill="#7986cb">写多读少场景收益极大</text>
                
                <!-- AHI适用场景 -->
                <rect x="830" y="680" width="230" height="30" rx="4" ry="4" fill="rgba(79, 195, 247, 0.3)" stroke="#4fc3f7" stroke-width="1"/>
                <text x="945" y="700" text-anchor="middle" font-size="12" fill="#4fc3f7">高并发等值查询，范围查询无效</text>
                
                <!-- 刷盘策略说明 -->
                <rect x="830" y="970" width="230" height="30" rx="4" ry="4" fill="rgba(186, 104, 200, 0.3)" stroke="#ba68c8" stroke-width="1"/>
                <text x="945" y="990" text-anchor="middle" font-size="12" fill="#ba68c8">0=性能高，1=最安全，2=平衡</text>
            </svg>
        </div>
        
        <div class="component-details">
            <div class="component-detail" style="border-color: #9575cd;">
                <h3><i class="fas fa-layer-group"></i> Buffer Pool (缓冲池) 深度解析</h3>
                
                <div class="component-subsection">
                    <h4>核心作用</h4>
                    <ul>
                        <li><strong>数据页缓存</strong>: 缓存16KB的数据页，包含行数据和索引数据</li>
                        <li><strong>索引页缓存</strong>: 缓存B+树索引的各个节点页</li>
                        <li><strong>内存交换区</strong>: 所有读写操作先经过Buffer Pool</li>
                        <li><strong>性能关键</strong>: <code>innodb_buffer_pool_size</code>是最重要的性能参数</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>改进LRU算法</h4>
                    <ul>
                        <li><strong>Young区(5/8)</strong>: 热点数据区，频繁访问的页</li>
                        <li><strong>Old区(3/8)</strong>: 新加载页先进入此区域尾部</li>
                        <li><strong>访问提升</strong>: Old区的页被访问后移动到Young区头部</li>
                        <li><strong>避免预读污染</strong>: 防止一次性预读大量数据冲刷热点数据</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>预读机制</h4>
                    <ul>
                        <li><strong>线性预读</strong>: 顺序访问模式下，预测后续页并提前加载</li>
                        <li><strong>随机预读</strong>: 随机访问模式下，预测同一extent内的其他页</li>
                        <li><strong>触发条件</strong>: 基于访问模式和统计信息自动判断</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>脏页管理</h4>
                    <ul>
                        <li><strong>定义</strong>: 修改过但未刷盘的页称为脏页</li>
                        <li><strong>刷盘线程</strong>: Page Cleaner Thread负责异步刷盘</li>
                        <li><strong>触发条件</strong>: Buffer Pool满、Redo Log写满、定时刷盘(默认1秒)</li>
                        <li><strong>检查点</strong>: 通过Checkpoint机制标记可覆盖的Redo Log位置</li>
                    </ul>
                </div>
            </div>
            
            <div class="component-detail" style="border-color: #7986cb;">
                <h3><i class="fas fa-exchange-alt"></i> Change Buffer (变更缓冲) 深度解析</h3>
                
                <div class="component-subsection">
                    <h4>设计目标</h4>
                    <ul>
                        <li><strong>减少随机IO</strong>: 将二级索引的随机写操作合并</li>
                        <li><strong>提升写入性能</strong>: 批量处理二级索引的变更操作</li>
                        <li><strong>写优化</strong>: 特别适合INSERT/UPDATE/DELETE频繁的场景</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>工作原理</h4>
                    <ul>
                        <li><strong>变更缓存</strong>: 对非唯一二级索引的变更先缓存到Change Buffer</li>
                        <li><strong>异步合并</strong>: 后续查询该索引时或后台线程定期合并变更到磁盘</li>
                        <li><strong>内存结构</strong>: B+树组织，按表空间ID和页号索引</li>
                        <li><strong>持久化</strong>: Change Buffer本身也持久化到系统表空间</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>适用场景</h4>
                    <ul>
                        <li><strong>写多读少</strong>: 电商商品入库、日志记录等写入密集型场景</li>
                        <li><strong>二级索引多</strong>: 表有多个非唯一二级索引</li>
                        <li><strong>批量操作</strong>: 批量INSERT/UPDATE/DELETE操作</li>
                        <li><strong>收益极大</strong>: 可减少90%以上的二级索引随机IO</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>限制条件</h4>
                    <ul>
                        <li><strong>仅非唯一索引</strong>: 唯一索引需要立即校验唯一性，无法使用</li>
                        <li><strong>内存限制</strong>: 由<code>innodb_change_buffer_max_size</code>控制(默认25%)</li>
                        <li><strong>合并时机</strong>: 查询时或后台线程定期合并</li>
                    </ul>
                </div>
            </div>
            
            <div class="component-detail" style="border-color: #4fc3f7;">
                <h3><i class="fas fa-bolt"></i> Adaptive Hash Index (AHI) 深度解析</h3>
                
                <div class="component-subsection">
                    <h4>设计目标</h4>
                    <ul>
                        <li><strong>加速等值查询</strong>: 将热点数据的等值查询从B+树的O(log n)优化到O(1)</li>
                        <li><strong>自适应调整</strong>: 根据访问模式自动创建和销毁哈希索引</li>
                        <li><strong>内存优化</strong>: 只缓存最热点的数据，避免内存浪费</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>工作原理</h4>
                    <ul>
                        <li><strong>自动监控</strong>: 监控Buffer Pool中页的访问模式</li>
                        <li><strong>热点识别</strong>: 识别频繁被等值查询访问的页</li>
                        <li><strong>哈希构建</strong>: 为热点页构建哈希索引，建立键值到页位置的映射</li>
                        <li><strong>自动维护</strong>: 根据访问频率动态调整哈希索引</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>适用场景</h4>
                    <ul>
                        <li><strong>高并发等值查询</strong>: 订单查询、用户信息查询等场景</li>
                        <li><strong>热点数据</strong>: 频繁被访问的少量数据</li>
                        <li><strong>点查优化</strong>: WHERE id=1, WHERE username='admin'等查询</li>
                        <li><strong>配置建议</strong>: 可通过<code>innodb_adaptive_hash_index</code>开启/关闭</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>限制条件</h4>
                    <ul>
                        <li><strong>仅等值查询</strong>: 范围查询(如id>10)无法使用</li>
                        <li><strong>内存有限</strong>: 默认占Buffer Pool的1/64</li>
                        <li><strong>自适应</strong>: 无法手动控制哪些数据被哈希索引</li>
                        <li><strong>并发问题</strong>: 高并发下可能成为瓶颈(8.0已优化)</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="memory-optimization">
            <h2><i class="fas fa-tachometer-alt"></i> InnoDB内存架构优化建议</h2>
            <p>基于内存架构的设计原理，以下是最佳实践和调优建议：</p>
            
            <div class="optimization-grid">
                <div class="optimization-item">
                    <h3>Buffer Pool调优</h3>
                    <ul>
                        <li><strong>大小设置</strong>: <code>innodb_buffer_pool_size</code>设置为物理内存的50%-70%</li>
                        <li><strong>多实例</strong>: 大内存服务器可使用多个Buffer Pool实例</li>
                        <li><strong>监控命中率</strong>: 监控Buffer Pool命中率，确保>95%</li>
                        <li><strong>预热优化</strong>: 使用<code>innodb_buffer_pool_dump_at_shutdown</code>和<code>innodb_buffer_pool_load_at_startup</code></li>
                    </ul>
                </div>
                
                <div class="optimization-item">
                    <h3>Change Buffer调优</h3>
                    <ul>
                        <li><strong>大小调整</strong>: 写多读少场景可增大<code>innodb_change_buffer_max_size</code>(默认25%)</li>
                        <li><strong>监控使用率</strong>: 通过<code>SHOW ENGINE INNODB STATUS</code>监控Change Buffer使用情况</li>
                        <li><strong>场景适配</strong>: 根据业务场景决定是否启用</li>
                        <li><strong>性能监控</strong>: 监控Change Buffer的合并效率和等待</li>
                    </ul>
                </div>
                
                <div class="optimization-item">
                    <h3>AHI调优</h3>
                    <ul>
                        <li><strong>启用/禁用</strong>: 高并发等值查询场景启用，范围查询多可禁用</li>
                        <li><strong>分区优化</strong>: 8.0支持AHI分区，减少锁竞争</li>
                        <li><strong>监控热点</strong>: 监控AHI命中率和内存使用情况</li>
                        <li><strong>内存限制</strong>: 通过<code>innodb_adaptive_hash_index_parts</code>调整分区数</li>
                    </ul>
                </div>
                
                <div class="optimization-item">
                    <h3>Log Buffer调优</h3>
                    <ul>
                        <li><strong>刷盘策略</strong>: 金融场景<code>innodb_flush_log_at_trx_commit=1</code>，非核心场景可用0或2</li>
                        <li><strong>大小调整</strong>: 大事务可适当增大<code>innodb_log_buffer_size</code>(默认16MB)</li>
                        <li><strong>性能平衡</strong>: 平衡数据安全性和写入性能</li>
                        <li><strong>监控等待</strong>: 监控log buffer等待情况，避免成为瓶颈</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="component-details">
            <div class="component-detail" style="border-color: #ba68c8;">
                <h3><i class="fas fa-file-alt"></i> Log Buffer (日志缓冲区) 深度解析</h3>
                
                <div class="component-subsection">
                    <h4>核心作用</h4>
                    <ul>
                        <li><strong>Redo Log缓存</strong>: 缓存事务产生的Redo Log条目</li>
                        <li><strong>减少磁盘写入</strong>: 批量写入磁盘，减少I/O次数</li>
                        <li><strong>性能优化</strong>: 将随机写转换为顺序写</li>
                        <li><strong>事务支持</strong>: 配合Redo Log保证事务的持久性(ACID-D)</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>刷盘策略详解</h4>
                    <ul>
                        <li><strong>策略0 (每秒刷盘)</strong>: 
                            <ul>
                                <li>每秒将Log Buffer刷到磁盘</li>
                                <li>性能最高，崩溃可能丢失最多1秒数据</li>
                                <li>适合非核心业务、日志记录等场景</li>
                            </ul>
                        </li>
                        <li><strong>策略1 (实时刷盘)</strong>:
                            <ul>
                                <li>每次事务提交都刷盘</li>
                                <li>最安全，符合ACID持久性要求</li>
                                <li>性能较低，但保证数据不丢失</li>
                                <li>金融、交易等核心业务必须使用</li>
                            </ul>
                        </li>
                        <li><strong>策略2 (OS缓存)</strong>:
                            <ul>
                                <li>事务提交时刷到操作系统缓存</li>
                                <li>每秒从OS缓存刷到磁盘</li>
                                <li>平衡安全性和性能</li>
                                <li>崩溃可能丢失OS缓存中的数据</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>性能调优</h4>
                    <ul>
                        <li><strong>缓冲区大小</strong>: <code>innodb_log_buffer_size</code>默认16MB，大事务可适当增大</li>
                        <li><strong>策略选择</strong>: 根据业务重要性选择合适的刷盘策略</li>
                        <li><strong>监控指标</strong>: 监控log buffer等待、刷盘频率等指标</li>
                        <li><strong>与Redo Log配合</strong>: 合理设置Redo Log文件大小和数量</li>
                    </ul>
                </div>
                
                <div class="component-subsection">
                    <h4>与Redo Log的关系</h4>
                    <ul>
                        <li><strong>缓存与持久化</strong>: Log Buffer是Redo Log的内存缓存</li>
                        <li><strong>写入流程</strong>: 事务修改 → 记录Redo Log到Log Buffer → 刷到Redo Log文件</li>
                        <li><strong>崩溃恢复</strong>: 通过Redo Log恢复已提交但未刷盘的数据</li>
                        <li><strong>循环写入</strong>: Redo Log文件循环使用，通过Checkpoint标记可覆盖位置</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <footer>
            <p>InnoDB内存架构深度解析图 | "用内存换IO"的核心设计 • 性能关键组件</p>
            <p>© 2023 MySQL InnoDB内存架构深度解析 | 基于MySQL 8.0.30架构</p>
        </footer>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // 获取SVG元素和工具提示
        const svg = document.getElementById('innodb-memory-architecture');
        const tooltip = document.getElementById('tooltip');
        
        // InnoDB内存架构组件详细信息配置
        const memoryComponents = [
            // Buffer Pool组件
            { id: 'buffer-pool-container', name: '缓冲池 (Buffer Pool)', desc: 'InnoDB最核心的内存区域，缓存数据页和索引页。', details: '<h4>核心特性：</h4><ul><li>大小由<code>innodb_buffer_pool_size</code>控制(建议占服务器内存50%-70%)</li><li>缓存16KB的数据页和索引页</li><li>采用改进LRU算法管理，避免预读污染</li><li>包含Free List、LRU List、Flush List三个链表</li><li>预读机制提前加载可能需要的页</li><li>脏页由Page Cleaner线程异步刷盘</li></ul>' },
            
            { id: 'young-area', name: 'Young区 (热点数据区)', desc: '改进LRU算法的热点数据区域，占Buffer Pool的5/8。', details: '<h4>管理机制：</h4><ul><li>存储频繁访问的热点数据页</li><li>位于LRU链表的前部</li><li>新页从Old区提升而来</li><li>淘汰时从尾部移除</li></ul>' },
            
            { id: 'old-area', name: 'Old区 (新数据区)', desc: '改进LRU算法的新数据区域，占Buffer Pool的3/8。', details: '<h4>管理机制：</h4><ul><li>新加载的页先进入此区域尾部</li><li>避免一次性预读大量数据冲刷热点数据</li><li>页被访问后移动到Young区头部</li><li>在Old区未被访问的页会被优先淘汰</li></ul>' },
            
            { id: 'read-ahead', name: '预读机制 (Read Ahead)', desc: '根据数据访问模式提前加载可能需要的页到Buffer Pool。', details: '<h4>预读类型：</h4><ul><li><strong>线性预读</strong>: 顺序访问模式下，预测后续连续的页</li><li><strong>随机预读</strong>: 随机访问模式下，预测同一extent内的其他页</li><li><strong>触发条件</strong>: 基于访问模式自动判断和调整</li><li><strong>性能优化</strong>: 减少后续磁盘I/O，提升查询性能</li></ul>' },
            
            { id: 'dirty-page', name: '脏页管理 (Dirty Pages)', desc: '管理已被修改但未刷盘到磁盘的数据页。', details: '<h4>刷盘机制：</h4><ul><li><strong>刷盘线程</strong>: Page Cleaner Thread负责异步刷盘</li><li><strong>触发条件</strong>: Buffer Pool满、Redo Log写满、定时刷盘(默认1秒)</li><li><strong>检查点</strong>: 通过Checkpoint机制标记已刷盘的数据位置</li><li><strong>性能影响</strong>: 脏页过多会影响内存使用和恢复时间</li></ul>' },
            
            // Change Buffer组件
            { id: 'change-buffer-container', name: '变更缓冲 (Change Buffer)', desc: '非唯一二级索引的写缓存优化，减少随机I/O。', details: '<h4>工作原理：</h4><ul><li>对INSERT/UPDATE/DELETE操作，先缓存到Change Buffer</li><li>后续查询需要访问该索引页时，合并变更到索引页</li><li>后台线程定期合并Change Buffer中的变更</li><li>仅适用于非唯一二级索引(唯一索引需要检查唯一性)</li><li>配置参数: <code>innodb_change_buffer_max_size</code>(默认25%)</li></ul>' },
            
            // AHI组件
            { id: 'adaptive-hash-index', name: '自适应哈希索引 (AHI)', desc: '自动为Buffer Pool中的热点数据构建哈希索引，实现O(1)的等值查询。', details: '<h4>特性：</h4><ul><li><strong>自适应</strong>: 自动创建和销毁，无需人工干预</li><li><strong>内存限制</strong>: 默认占Buffer Pool的1/64</li><li><strong>适用场景</strong>: 高并发等值查询，对范围查询无效</li><li><strong>配置参数</strong>: <code>innodb_adaptive_hash_index</code></li><li><strong>分区优化</strong>: 8.0支持分区减少锁竞争</li></ul>' },
            
            // Log Buffer组件
            { id: 'log-buffer-container', name: '日志缓冲区 (Log Buffer)', desc: 'Redo Log的内存缓冲区，减少磁盘写入次数。', details: '<h4>刷盘策略：</h4><ul><li><strong>innodb_flush_log_at_trx_commit=0</strong>: 每秒刷盘，性能高，可能丢失1秒数据</li><li><strong>=1</strong>: 每次事务提交都刷盘，最安全，性能较低(默认)</li><li><strong>=2</strong>: 刷到OS缓存，每秒刷盘，平衡安全性和性能</li><li><strong>配置建议</strong>: 金融场景必须设为1，非核心场景可设0/2提升性能</li></ul>' },
            
            // 后台线程组件
            { id: 'page-cleaner', name: 'Page Cleaner Thread', desc: '专门负责刷脏页的后台线程，减轻Master Thread负担。', details: '<h4>主要职责：</h4><ul><li>异步刷脏页到磁盘</li><li>根据多种触发条件执行刷盘操作</li><li>减少主线程负担，提升并发性能</li><li>配置参数: <code>innodb_page_cleaners</code>(默认4)</li></ul>' },
            
            { id: 'master-thread', name: 'Master Thread', desc: 'InnoDB的主后台线程，负责全局调度和协调。', details: '<h4>主要职责：</h4><ul><li>每秒：刷新Log Buffer到Redo Log</li><li>每10秒：合并Change Buffer，刷脏页，检查Checkpoint</li><li>空闲时：执行各种后台任务</li><li>协调其他后台线程的工作</li></ul>' },
            
            // 磁盘存储组件
            { id: 'disk-storage', name: '磁盘存储 (Disk Storage)', desc: '数据持久化存储，包括数据文件、Redo Log文件等。', details: '<h4>存储组件：</h4><ul><li><strong>数据文件(*.ibd)</strong>: 表数据和索引的持久化存储</li><li><strong>Redo Log文件(ib_logfile*)</strong>: 事务持久性保证，循环写入</li><li><strong>系统表空间(ibdata1)</strong>: 元数据、Undo Log、Double Write Buffer</li><li><strong>数据页结构</strong>: 16KB大小，包含页头、行数据、页尾等</li></ul>' },
        ];
        
        // 为每个组件添加事件监听器
        memoryComponents.forEach(component => {
            const elem = document.getElementById(component.id);
            if (elem) {
                // 鼠标悬停显示工具提示
                elem.addEventListener('mouseover', (e) => {
                    tooltip.style.display = 'block';
                    tooltip.innerHTML = `
                        <h3>${component.name}</h3>
                        <p>${component.desc}</p>
                        ${component.details ? `<div style="margin-top:15px;">${component.details}</div>` : ''}
                    `;
                    
                    // 高亮当前组件
                    elem.style.filter = 'url(#glow)';
                });
                
                // 鼠标移动时更新工具提示位置
                elem.addEventListener('mousemove', (e) => {
                    const x = e.clientX + 20;
                    const y = e.clientY + 20;
                    
                    // 确保工具提示不会超出屏幕
                    const maxX = window.innerWidth - 520;
                    const maxY = window.innerHeight - 300;
                    
                    tooltip.style.left = `${Math.min(x, maxX)}px`;
                    tooltip.style.top = `${Math.min(y, maxY)}px`;
                });
                
                // 鼠标离开时隐藏工具提示
                elem.addEventListener('mouseout', (e) => {
                    tooltip.style.display = 'none';
                    elem.style.filter = 'none';
                });
                
                // 点击时高亮
                elem.addEventListener('click', (e) => {
                    // 移除所有高亮
                    document.querySelectorAll('.highlight').forEach(el => {
                        el.classList.remove('highlight');
                    });
                    
                    // 添加高亮
                    elem.classList.add('highlight');
                    
                    // 防止事件冒泡
                    e.stopPropagation();
                });
            }
        });
        
        // 高亮控制功能
        document.getElementById('highlight-buffer-pool').addEventListener('click', () => {
            highlightComponents(['buffer-pool-container', 'young-area', 'old-area', 'read-ahead', 'dirty-page']);
            showFlows(['buffer-pool-flow', 'flush-flow', 'read-flow']);
        });
        
        document.getElementById('highlight-change-buffer').addEventListener('click', () => {
            highlightComponents(['change-buffer-container']);
            showFlows(['change-buffer-flow']);
        });
        
        document.getElementById('highlight-adaptive-hash').addEventListener('click', () => {
            highlightComponents(['adaptive-hash-index']);
            showFlows(['ahi-flow']);
        });
        
        document.getElementById('highlight-log-buffer').addEventListener('click', () => {
            highlightComponents(['log-buffer-container', 'flush-policy']);
            showFlows(['log-buffer-flow']);
        });
        
        document.getElementById('show-lru-mechanism').addEventListener('click', () => {
            highlightComponents(['young-area', 'old-area']);
            showFlows(['buffer-pool-flow']);
        });
        
        document.getElementById('show-flush-mechanism').addEventListener('click', () => {
            highlightComponents(['dirty-page', 'page-cleaner']);
            showFlows(['flush-flow', 'thread-flow']);
        });
        
        document.getElementById('show-full-memory-flow').addEventListener('click', () => {
            showFlows(['buffer-pool-flow', 'flush-flow', 'change-buffer-flow', 'ahi-flow', 'log-buffer-flow', 'thread-flow', 'read-flow']);
        });
        
        document.getElementById('reset-highlight').addEventListener('click', () => {
            resetView();
        });
        
        function highlightComponents(componentIds) {
            resetView();
            
            componentIds.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.classList.add('highlight');
                }
            });
        }
        
        function showFlows(flowClasses) {
            // 隐藏所有数据流
            document.querySelectorAll('.buffer-pool-flow, .flush-flow, .change-buffer-flow, .ahi-flow, .log-buffer-flow, .thread-flow, .read-flow').forEach(line => {
                line.style.opacity = '0.4';
                line.classList.remove('flow-animation');
            });
            
            // 显示指定的数据流
            flowClasses.forEach(className => {
                document.querySelectorAll(`.${className}`).forEach(line => {
                    line.style.opacity = '0.9';
                    line.classList.add('flow-animation');
                });
            });
        }
        
        function resetView() {
            // 移除所有高亮
            document.querySelectorAll('.highlight').forEach(elem => {
                elem.classList.remove('highlight');
            });
            
            // 隐藏所有数据流动画
            document.querySelectorAll('.buffer-pool-flow, .flush-flow, .change-buffer-flow, .ahi-flow, .log-buffer-flow, .thread-flow, .read-flow').forEach(line => {
                line.style.opacity = '0.6';
                line.classList.remove('flow-animation');
            });
        }
        
        // 点击SVG空白处重置高亮
        svg.addEventListener('click', (e) => {
            if (e.target.tagName === 'svg' || e.target.id === 'innodb-memory-architecture') {
                resetView();
            }
        });
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.key === '1') document.getElementById('highlight-buffer-pool').click();
            else if (e.key === '2') document.getElementById('highlight-change-buffer').click();
            else if (e.key === '3') document.getElementById('highlight-adaptive-hash').click();
            else if (e.key === '4') document.getElementById('highlight-log-buffer').click();
            else if (e.key === '5') document.getElementById('show-lru-mechanism').click();
            else if (e.key === '6') document.getElementById('show-flush-mechanism').click();
            else if (e.key === 'f') document.getElementById('show-full-memory-flow').click();
            else if (e.key === '0' || e.key === 'Escape') document.getElementById('reset-highlight').click();
            else if (e.key === 'h' && e.ctrlKey) {
                alert('键盘快捷键：\n\n1 - 缓冲池(Buffer Pool)\n2 - 变更缓冲(Change Buffer)\n3 - 自适应哈希索引(AHI)\n4 - 日志缓冲区(Log Buffer)\n5 - LRU算法机制\n6 - 脏页刷盘机制\nf - 完整内存数据流\n0/Esc - 重置视图\nCtrl+H - 显示帮助');
                e.preventDefault();
            }
        });
        
        // 初始显示Buffer Pool
        setTimeout(() => {
            document.getElementById('highlight-buffer-pool').click();
        }, 1000);
    </script>
</body>
</html>