<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL连接层详细架构图</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0c1e29 0%, #1a2c3b 100%);
            color: #e0f2fe;
            min-height: 100vh;
            padding: 20px;
            overflow-x: auto;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(5, 25, 45, 0.8);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border-left: 6px solid #00c6ff;
        }
        
        h1 {
            font-size: 2.6rem;
            margin-bottom: 15px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.5px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a5d8ff;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.7;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .canvas-section {
            background: rgba(5, 25, 45, 0.8);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            overflow: auto;
            border-top: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        canvas {
            display: block;
            background: #051a2d;
            border-radius: 8px;
            width: 1500px;
            height: 900px;
        }
        
        .controls-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .panel {
            flex: 1;
            min-width: 300px;
            background: rgba(5, 25, 45, 0.8);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        h2 {
            font-size: 1.7rem;
            margin-bottom: 20px;
            color: #4facfe;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(79, 172, 254, 0.3);
        }
        
        .component-list {
            list-style: none;
            margin-top: 10px;
        }
        
        .component-list li {
            padding: 14px 18px;
            margin-bottom: 12px;
            background: linear-gradient(90deg, rgba(0, 114, 255, 0.1), rgba(0, 198, 255, 0.1));
            border-radius: 8px;
            border-left: 4px solid #00c6ff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .component-list li:hover {
            background: linear-gradient(90deg, rgba(0, 114, 255, 0.2), rgba(0, 198, 255, 0.2));
            transform: translateX(5px);
        }
        
        .component-list li.active {
            background: linear-gradient(90deg, rgba(0, 114, 255, 0.3), rgba(0, 198, 255, 0.3));
            border-left-color: #00f2fe;
            box-shadow: 0 5px 15px rgba(0, 198, 255, 0.2);
        }
        
        .component-id {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: #0072ff;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            margin-right: 15px;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .component-info {
            flex-grow: 1;
        }
        
        .component-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .component-type {
            font-size: 0.9rem;
            color: #88ccff;
            background: rgba(0, 114, 255, 0.2);
            padding: 3px 10px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            flex: 1;
            padding: 14px;
            background: linear-gradient(to right, #0072ff, #00c6ff);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 114, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .details-section {
            background: rgba(5, 25, 45, 0.8);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        .details-content {
            line-height: 1.7;
            color: #cae9ff;
        }
        
        .details-content p {
            margin-bottom: 15px;
        }
        
        .details-content ul {
            padding-left: 20px;
            margin-bottom: 20px;
        }
        
        .details-content li {
            margin-bottom: 10px;
            position: relative;
            padding-left: 10px;
        }
        
        .details-content li:before {
            content: "→";
            color: #00f2fe;
            position: absolute;
            left: -15px;
        }
        
        .highlight {
            color: #00f2fe;
            font-weight: bold;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }
        
        .legend-color {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #88ccff;
            font-size: 0.9rem;
            border-top: 1px solid rgba(136, 204, 255, 0.2);
        }
        
        .flow-path {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 40, 80, 0.3);
            border-radius: 8px;
            border-left: 4px solid #00f2fe;
        }
        
        .flow-path h3 {
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .architecture-layers {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .layer {
            padding: 15px;
            background: rgba(0, 40, 80, 0.3);
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }
        
        .layer h3 {
            color: #4facfe;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .layer h3:before {
            content: "▸";
            margin-right: 10px;
            color: #00f2fe;
        }
        
        @media (max-width: 1200px) {
            .controls-section {
                flex-direction: column;
            }
            
            canvas {
                width: 100%;
                height: 700px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MySQL连接层详细架构图</h1>
            <p class="subtitle">MySQL连接层是客户端与服务器交互的入口，负责连接管理、用户认证、线程调度和会话管理。本图详细展示了连接层的内部组件、数据流向和交互关系，包括传统线程模型和MySQL 8.0线程池优化。</p>
        </header>
        
        <div class="main-content">
            <div class="canvas-section">
                <canvas id="mysqlCanvas" width="1500" height="900">
                    您的浏览器不支持HTML5 Canvas，请使用现代浏览器查看此图表。
                </canvas>
            </div>
            
            <div class="controls-section">
                <div class="panel">
                    <h2>连接层组件</h2>
                    <ul class="component-list" id="componentList">
                        <!-- 组件列表将通过JavaScript动态生成 -->
                    </ul>
                    
                    <div class="btn-group">
                        <button id="animateBtn" class="btn">演示连接流程</button>
                        <button id="resetBtn" class="btn">重置视图</button>
                    </div>
                    
                    <div class="flow-path">
                        <h3>典型连接路径</h3>
                        <div class="architecture-layers">
                            <div class="layer">
                                <h3>连接接入层</h3>
                                <p>客户端通过TCP/IP、Unix Socket等方式连接到MySQL服务器</p>
                            </div>
                            <div class="layer">
                                <h3>连接管理</h3>
                                <p>连接监听、连接池管理、连接限制和超时处理</p>
                            </div>
                            <div class="layer">
                                <h3>认证与安全</h3>
                                <p>用户身份验证、权限检查、安全插件支持</p>
                            </div>
                            <div class="layer">
                                <h3>线程调度</h3>
                                <p>线程分配、线程池管理、请求队列处理</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <h2>组件详情</h2>
                    <div class="details-content" id="detailContent">
                        <p>MySQL连接层是客户端与MySQL服务器交互的入口点，负责管理所有客户端连接，验证用户身份，并分配处理线程。</p>
                        <p>连接层的主要功能包括：<span class="highlight">连接管理</span>、<span class="highlight">用户认证</span>、<span class="highlight">线程调度</span>和<span class="highlight">安全控制</span>。</p>
                        <p>在高并发场景下，连接层的性能直接影响整个数据库系统的吞吐量。MySQL 8.0引入了线程池(Thread Pool)来优化传统的一连接一线程(one-thread-per-connection)模型，显著提升了高并发处理能力。</p>
                        <p>点击左侧组件查看详细说明。</p>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #0072ff;"></div>
                            <span>网络连接</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00c6ff;"></div>
                            <span>连接管理</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00d2ff;"></div>
                            <span>线程管理</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #4facfe;"></div>
                            <span>认证模块</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00f2fe;"></div>
                            <span>核心组件</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff6b6b;"></div>
                            <span>已选中</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>MySQL连接层详细架构图 | 连接管理 + 线程调度 + 认证逻辑 | 高并发优化 | 技术专家视图</p>
        </footer>
    </div>

    <script>
        // 获取Canvas和上下文
        const canvas = document.getElementById('mysqlCanvas');
        const ctx = canvas.getContext('2d');
        
        // 设置Canvas尺寸适应容器
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawComponents();
        }
        
        // 组件数据 - 重新设计布局，分为5个主要区域
        const components = [
            // 区域1：客户端连接 (左侧)
            { 
                id: 1, 
                name: "客户端应用", 
                type: "network",
                description: "各种MySQL客户端应用程序，如MySQL命令行客户端、应用程序连接池、管理工具等，通过不同协议发起连接请求。",
                details: [
                    "应用程序通过MySQL Connector/J, Connector/Python等驱动连接",
                    "支持JDBC, ODBC, .NET等标准接口",
                    "客户端可以配置连接池(如HikariCP, Druid)",
                    "连接参数：主机、端口、用户名、密码、数据库等"
                ],
                x: 50, y: 150, width: 200, height: 100
            },
            { 
                id: 2, 
                name: "连接协议", 
                type: "network",
                description: "MySQL支持的连接协议，包括TCP/IP、Unix Socket、命名管道和共享内存。不同协议适用于不同的使用场景。",
                details: [
                    "TCP/IP：远程连接，默认端口3306，支持SSL加密",
                    "Unix Socket：本地连接，绕过网络协议栈，性能更高",
                    "命名管道：Windows系统进程间通信",
                    "共享内存：Windows系统高效进程间通信"
                ],
                x: 50, y: 300, width: 200, height: 100
            },
            
            // 区域2：连接管理层 (左中)
            { 
                id: 3, 
                name: "连接监听器", 
                type: "connection",
                description: "监听并接受客户端连接请求，根据MySQL配置绑定到指定的网络接口和端口。",
                details: [
                    "监听配置的端口(默认3306)，支持IPv4和IPv6",
                    "处理连接请求队列，防止连接风暴",
                    "可配置多个监听地址(bind-address)",
                    "支持SSL/TLS加密连接"
                ],
                x: 300, y: 100, width: 220, height: 100
            },
            { 
                id: 4, 
                name: "连接管理器", 
                type: "connection",
                description: "管理所有活跃连接的生命周期，包括连接的创建、维护和销毁。",
                details: [
                    "维护连接池，重用连接资源",
                    "管理最大连接数(max_connections参数)",
                    "处理连接超时(wait_timeout, interactive_timeout)",
                    "跟踪连接状态和统计信息"
                ],
                x: 300, y: 250, width: 220, height: 100
            },
            { 
                id: 5, 
                name: "连接限制器", 
                type: "connection",
                description: "实施连接限制策略，防止过多的连接耗尽系统资源。",
                details: [
                    "基于用户、主机的连接限制",
                    "实施最大连接数限制",
                    "资源使用监控和限制",
                    "连接排队机制"
                ],
                x: 300, y: 400, width: 220, height: 100
            },
            
            // 区域3：认证与安全层 (中部)
            { 
                id: 6, 
                name: "认证协议处理器", 
                type: "auth",
                description: "处理MySQL认证协议握手过程，支持多种认证方法。",
                details: [
                    "处理初始握手协议",
                    "支持多种认证方法：mysql_native_password, caching_sha2_password",
                    "协议版本协商",
                    "SSL/TLS连接升级"
                ],
                x: 580, y: 150, width: 220, height: 100
            },
            { 
                id: 7, 
                name: "身份验证器", 
                type: "auth",
                description: "验证客户端提供的用户名和密码，检查用户身份的有效性。",
                details: [
                    "查询mysql.user系统表验证凭证",
                    "支持多种密码哈希算法",
                    "密码过期检查",
                    "账户锁定状态检查"
                ],
                x: 580, y: 300, width: 220, height: 100
            },
            { 
                id: 8, 
                name: "权限检查器", 
                type: "auth",
                description: "检查用户权限，包括全局权限、数据库权限、表级权限和列级权限。",
                details: [
                    "检查全局权限(GRANT权限)",
                    "检查数据库级权限",
                    "检查表级和列级权限",
                    "角色权限继承检查"
                ],
                x: 580, y: 450, width: 220, height: 100
            },
            
            // 区域4：线程管理层 (右中)
            { 
                id: 9, 
                name: "线程分配器", 
                type: "thread",
                description: "为通过认证的连接分配处理线程，传统模式下一连接一线程。",
                details: [
                    "传统模式：one-thread-per-connection",
                    "为每个连接创建独立的线程",
                    "线程生命周期管理",
                    "线程局部存储初始化"
                ],
                x: 860, y: 150, width: 220, height: 100
            },
            { 
                id: 10, 
                name: "线程池(8.0+)", 
                type: "thread",
                description: "MySQL 8.0引入的线程池特性，将连接分组绑定到线程，显著提升高并发性能。",
                details: [
                    "线程分组：将连接分配到不同的线程组",
                    "线程复用：一个线程处理多个连接请求",
                    "防止线程爆炸：限制最大线程数",
                    "提高CPU缓存命中率"
                ],
                x: 860, y: 300, width: 220, height: 100
            },
            { 
                id: 11, 
                name: "请求队列", 
                type: "thread",
                description: "在线程池模式下，管理等待处理的请求队列，实现请求的公平调度。",
                details: [
                    "管理待处理请求队列",
                    "实现请求的公平调度",
                    "队列长度限制",
                    "优先级调度支持"
                ],
                x: 860, y: 450, width: 220, height: 100
            },
            
            // 区域5：会话与接口层 (右侧)
            { 
                id: 12, 
                name: "会话管理器", 
                type: "core",
                description: "为用户连接创建和管理会话上下文，包括会话变量、临时表和状态信息。",
                details: [
                    "维护会话级系统变量",
                    "管理临时表和临时文件",
                    "跟踪会话状态和统计信息",
                    "隔离不同用户的会话数据"
                ],
                x: 1140, y: 150, width: 220, height: 100
            },
            { 
                id: 13, 
                name: "查询接收器", 
                type: "core",
                description: "接收客户端发送的SQL查询，进行初步处理并转发给SQL层。",
                details: [
                    "接收客户端SQL查询",
                    "查询包解析和验证",
                    "多语句查询分割",
                    "查询大小限制检查"
                ],
                x: 1140, y: 300, width: 220, height: 100
            },
            { 
                id: 14, 
                name: "结果发送器", 
                type: "network",
                description: "将SQL层的处理结果返回给客户端，包括结果集、状态信息和错误消息。",
                details: [
                    "结果集序列化",
                    "分块传输大型结果集",
                    "状态信息返回(affected rows等)",
                    "错误消息格式化"
                ],
                x: 1140, y: 450, width: 220, height: 100
            },
            
            // 区域6：支持组件 (底部)
            { 
                id: 15, 
                name: "权限缓存", 
                type: "auth",
                description: "缓存用户权限信息，减少对系统表的频繁查询，提高认证性能。",
                details: [
                    "缓存mysql.user、mysql.db等系统表数据",
                    "减少权限验证时的磁盘I/O",
                    "支持权限刷新命令(FLUSH PRIVILEGES)",
                    "自动失效过期的缓存条目"
                ],
                x: 300, y: 600, width: 220, height: 100
            },
            { 
                id: 16, 
                name: "连接统计", 
                type: "connection",
                description: "收集和统计连接层相关指标，用于监控和性能分析。",
                details: [
                    "连接数统计(当前、最大、历史)",
                    "线程状态统计",
                    "请求处理时间统计",
                    "资源使用统计"
                ],
                x: 580, y: 600, width: 220, height: 100
            },
            { 
                id: 17, 
                name: "审计日志", 
                type: "core",
                description: "记录连接层的重要事件，用于安全审计和故障排查。",
                details: [
                    "连接成功/失败日志",
                    "用户认证日志",
                    "权限变更日志",
                    "连接断开日志"
                ],
                x: 860, y: 600, width: 220, height: 100
            }
        ];
        
        // 连接线数据
        const connections = [
            // 客户端到连接监听器
            { from: 1, to: 2, label: "连接请求", type: "request" },
            { from: 2, to: 3, label: "协议连接", type: "protocol" },
            
            // 连接管理内部流
            { from: 3, to: 4, label: "连接创建", type: "internal" },
            { from: 4, to: 5, label: "连接检查", type: "check" },
            
            // 认证流程
            { from: 5, to: 6, label: "认证开始", type: "auth" },
            { from: 6, to: 7, label: "身份验证", type: "auth" },
            { from: 7, to: 8, label: "权限验证", type: "auth" },
            
            // 线程分配
            { from: 8, to: 9, label: "传统线程", type: "thread", dashed: true },
            { from: 8, to: 10, label: "线程池", type: "thread" },
            { from: 10, to: 11, label: "请求排队", type: "queue" },
            
            // 会话管理
            { from: 8, to: 12, label: "创建会话", type: "session" },
            { from: 10, to: 12, label: "关联会话", type: "session" },
            
            // 查询处理
            { from: 12, to: 13, label: "接收查询", type: "query" },
            { from: 13, to: 14, label: "发送结果", type: "result" },
            
            // 支持组件连接
            { from: 7, to: 15, label: "权限缓存", type: "cache", bidirectional: true },
            { from: 4, to: 16, label: "统计收集", type: "stats" },
            { from: 3, to: 17, label: "审计日志", type: "audit" },
            { from: 7, to: 17, label: "认证审计", type: "audit" },
            
            // 返回流
            { from: 14, to: 1, label: "结果返回", type: "result", dashed: true, curve: true }
        ];
        
        // 颜色映射
        const colors = {
            network: "#0072ff",
            connection: "#00c6ff", 
            thread: "#00d2ff",
            auth: "#4facfe",
            core: "#00f2fe",
            highlight: "#ff6b6b",
            text: "#e0f2fe",
            background: "#051a2d",
            line: "rgba(255, 255, 255, 0.4)",
            lineHighlight: "rgba(255, 107, 107, 0.7)"
        };
        
        // 当前选中的组件
        let selectedComponent = null;
        let animationInProgress = false;
        
        // 初始化组件列表
        function initComponentList() {
            const componentList = document.getElementById('componentList');
            componentList.innerHTML = '';
            
            components.forEach(component => {
                const li = document.createElement('li');
                li.dataset.id = component.id;
                li.innerHTML = `
                    <div class="component-id">${component.id}</div>
                    <div class="component-info">
                        <div class="component-name">${component.name}</div>
                        <div class="component-type">${component.type}</div>
                    </div>
                `;
                
                li.addEventListener('click', () => {
                    if (animationInProgress) return;
                    
                    // 移除所有active类
                    document.querySelectorAll('.component-list li').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // 添加active类到当前项
                    li.classList.add('active');
                    
                    // 选中组件
                    selectComponent(component.id);
                });
                
                componentList.appendChild(li);
            });
        }
        
        // 绘制所有组件
        function drawComponents() {
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制背景网格
            drawGrid();
            
            // 绘制区域标签
            drawRegionLabels();
            
            // 绘制连接线
            connections.forEach(conn => {
                drawConnection(conn);
            });
            
            // 绘制组件
            components.forEach(component => {
                drawComponent(component);
            });
            
            // 绘制标题
            drawTitle();
        }
        
        // 绘制网格背景
        function drawGrid() {
            ctx.strokeStyle = "rgba(0, 100, 200, 0.08)";
            ctx.lineWidth = 1;
            
            // 垂直线
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // 水平线
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }
        
        // 绘制区域标签
        function drawRegionLabels() {
            const regions = [
                { name: "客户端层", x: 50, y: 80 },
                { name: "连接管理层", x: 300, y: 80 },
                { name: "认证与安全层", x: 580, y: 80 },
                { name: "线程管理层", x: 860, y: 80 },
                { name: "会话与接口层", x: 1140, y: 80 },
                { name: "支持组件", x: 580, y: 550 }
            ];
            
            ctx.fillStyle = "rgba(0, 114, 255, 0.2)";
            ctx.font = "bold 18px 'Segoe UI', sans-serif";
            ctx.textAlign = "center";
            
            regions.forEach(region => {
                // 区域标题背景
                ctx.fillStyle = "rgba(0, 114, 255, 0.1)";
                ctx.fillRect(region.x - 20, region.y - 30, 260, 40);
                
                // 区域标题
                ctx.fillStyle = "#4facfe";
                ctx.fillText(region.name, region.x + 110, region.y);
                
                // 区域边框
                ctx.strokeStyle = "rgba(79, 172, 254, 0.3)";
                ctx.lineWidth = 2;
                ctx.strokeRect(region.x - 20, region.y - 30, 260, 40);
            });
        }
        
        // 绘制组件
        function drawComponent(component) {
            const isSelected = selectedComponent && selectedComponent.id === component.id;
            
            // 设置颜色
            const color = isSelected ? colors.highlight : colors[component.type];
            
            // 绘制组件阴影
            if (isSelected) {
                ctx.shadowColor = color;
                ctx.shadowBlur = 20;
            }
            
            // 绘制组件主体
            ctx.fillStyle = isSelected ? color + "22" : "rgba(0, 30, 60, 0.8)";
            ctx.strokeStyle = color;
            ctx.lineWidth = isSelected ? 3 : 2;
            
            // 绘制组件背景
            roundRect(ctx, component.x, component.y, component.width, component.height, 12);
            
            // 绘制组件顶部装饰条
            ctx.fillStyle = color;
            ctx.fillRect(component.x, component.y, component.width, 8);
            
            // 绘制组件名称
            ctx.fillStyle = isSelected ? colors.highlight : colors.text;
            ctx.font = "bold 16px 'Segoe UI', sans-serif";
            ctx.textAlign = "center";
            
            // 名称换行处理
            const nameLines = wrapText(component.name, component.width - 30);
            let lineHeight = 20;
            nameLines.forEach((line, index) => {
                ctx.fillText(line, component.x + component.width/2, component.y + 35 + index * lineHeight);
            });
            
            // 绘制组件类型
            ctx.fillStyle = color;
            ctx.font = "13px 'Segoe UI', sans-serif";
            ctx.fillText(component.type.toUpperCase(), component.x + component.width/2, component.y + component.height - 25);
            
            // 绘制组件ID
            ctx.fillStyle = color;
            ctx.font = "bold 14px 'Segoe UI', sans-serif";
            ctx.textAlign = "left";
            ctx.fillText(`#${component.id}`, component.x + 15, component.y + 25);
            
            // 重置阴影
            ctx.shadowBlur = 0;
        }
        
        // 文本换行函数
        function wrapText(text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];
            
            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }
        
        // 绘制连接线
        function drawConnection(conn) {
            const fromComp = components.find(c => c.id === conn.from);
            const toComp = components.find(c => c.id === conn.to);
            
            if (!fromComp || !toComp) return;
            
            // 计算起点和终点
            let startX, startY, endX, endY;
            
            if (conn.from === 14 && conn.to === 1 && conn.curve) {
                // 特殊处理返回曲线
                startX = fromComp.x + fromComp.width / 2;
                startY = fromComp.y + fromComp.height;
                endX = toComp.x + toComp.width / 2;
                endY = toComp.y;
                
                // 绘制贝塞尔曲线
                drawCurvedLine(startX, startY, endX, endY, conn);
                return;
            }
            
            // 正常连接线
            startX = fromComp.x + fromComp.width;
            startY = fromComp.y + fromComp.height / 2;
            endX = toComp.x;
            endY = toComp.y + toComp.height / 2;
            
            // 设置线条样式
            const isHighlighted = selectedComponent && 
                (selectedComponent.id === conn.from || selectedComponent.id === conn.to);
            
            ctx.strokeStyle = isHighlighted ? colors.lineHighlight : colors.line;
            ctx.lineWidth = isHighlighted ? 3 : 2;
            ctx.setLineDash(conn.dashed ? [5, 5] : []);
            
            // 绘制箭头线
            drawArrowLine(startX, startY, endX, endY, 10);
            
            // 绘制标签
            if (conn.label) {
                const midX = (startX + endX) / 2;
                const midY = (startY + endY) / 2;
                
                ctx.fillStyle = isHighlighted ? colors.highlight : colors.text;
                ctx.font = "12px 'Segoe UI', sans-serif";
                ctx.textAlign = "center";
                
                // 标签背景
                ctx.fillStyle = "rgba(5, 25, 45, 0.9)";
                const textWidth = ctx.measureText(conn.label).width;
                ctx.fillRect(midX - textWidth/2 - 5, midY - 20, textWidth + 10, 20);
                
                // 标签文字
                ctx.fillStyle = isHighlighted ? colors.highlight : colors.text;
                ctx.fillText(conn.label, midX, midY - 7);
            }
            
            ctx.setLineDash([]);
        }
        
        // 绘制曲线连接线
        function drawCurvedLine(startX, startY, endX, endY, conn) {
            const isHighlighted = selectedComponent && 
                (selectedComponent.id === conn.from || selectedComponent.id === conn.to);
            
            ctx.strokeStyle = isHighlighted ? colors.lineHighlight : colors.line;
            ctx.lineWidth = isHighlighted ? 3 : 2;
            ctx.setLineDash(conn.dashed ? [5, 5] : []);
            
            // 计算控制点
            const cp1x = startX + 200;
            const cp1y = startY + 100;
            const cp2x = endX - 200;
            const cp2y = endY - 100;
            
            // 绘制贝塞尔曲线
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, endX, endY);
            ctx.stroke();
            
            // 绘制箭头
            drawArrowOnCurve(startX, startY, cp1x, cp1y, cp2x, cp2y, endX, endY, 10);
            
            // 绘制标签
            if (conn.label) {
                // 计算曲线上的点
                const t = 0.5;
                const midX = Math.pow(1-t,3)*startX + 3*Math.pow(1-t,2)*t*cp1x + 3*(1-t)*Math.pow(t,2)*cp2x + Math.pow(t,3)*endX;
                const midY = Math.pow(1-t,3)*startY + 3*Math.pow(1-t,2)*t*cp1y + 3*(1-t)*Math.pow(t,2)*cp2y + Math.pow(t,3)*endY;
                
                ctx.fillStyle = isHighlighted ? colors.highlight : colors.text;
                ctx.font = "12px 'Segoe UI', sans-serif";
                ctx.textAlign = "center";
                
                // 标签背景
                ctx.fillStyle = "rgba(5, 25, 45, 0.9)";
                const textWidth = ctx.measureText(conn.label).width;
                ctx.fillRect(midX - textWidth/2 - 5, midY - 20, textWidth + 10, 20);
                
                // 标签文字
                ctx.fillStyle = isHighlighted ? colors.highlight : colors.text;
                ctx.fillText(conn.label, midX, midY - 7);
            }
            
            ctx.setLineDash([]);
        }
        
        // 在曲线上绘制箭头
        function drawArrowOnCurve(x1, y1, cp1x, cp1y, cp2x, cp2y, x2, y2, arrowSize) {
            // 在曲线末端绘制箭头
            const t = 0.95; // 接近末端的位置
            const arrowX = Math.pow(1-t,3)*x1 + 3*Math.pow(1-t,2)*t*cp1x + 3*(1-t)*Math.pow(t,2)*cp2x + Math.pow(t,3)*x2;
            const arrowY = Math.pow(1-t,3)*y1 + 3*Math.pow(1-t,2)*t*cp1y + 3*(1-t)*Math.pow(t,2)*cp2y + Math.pow(t,3)*y2;
            
            // 计算切线方向
            const dx = 3*Math.pow(1-t,2)*(cp1x-x1) + 6*(1-t)*t*(cp2x-cp1x) + 3*Math.pow(t,2)*(x2-cp2x);
            const dy = 3*Math.pow(1-t,2)*(cp1y-y1) + 6*(1-t)*t*(cp2y-cp1y) + 3*Math.pow(t,2)*(y2-cp2y);
            const angle = Math.atan2(dy, dx);
            
            // 绘制箭头
            ctx.beginPath();
            ctx.moveTo(arrowX, arrowY);
            ctx.lineTo(
                arrowX - arrowSize * Math.cos(angle - Math.PI / 6),
                arrowY - arrowSize * Math.sin(angle - Math.PI / 6)
            );
            ctx.lineTo(
                arrowX - arrowSize * Math.cos(angle + Math.PI / 6),
                arrowY - arrowSize * Math.sin(angle + Math.PI / 6)
            );
            ctx.closePath();
            ctx.fillStyle = ctx.strokeStyle;
            ctx.fill();
        }
        
        // 绘制带箭头的线
        function drawArrowLine(fromX, fromY, toX, toY, arrowSize) {
            // 计算角度
            const angle = Math.atan2(toY - fromY, toX - fromX);
            
            // 绘制线
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.stroke();
            
            // 绘制箭头
            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(
                toX - arrowSize * Math.cos(angle - Math.PI / 6),
                toY - arrowSize * Math.sin(angle - Math.PI / 6)
            );
            ctx.lineTo(
                toX - arrowSize * Math.cos(angle + Math.PI / 6),
                toY - arrowSize * Math.sin(angle + Math.PI / 6)
            );
            ctx.closePath();
            ctx.fillStyle = ctx.strokeStyle;
            ctx.fill();
        }
        
        // 绘制标题
        function drawTitle() {
            // 标题背景
            ctx.fillStyle = "rgba(0, 20, 40, 0.9)";
            ctx.fillRect(0, 0, canvas.width, 70);
            
            // 主标题
            ctx.fillStyle = "#4facfe";
            ctx.font = "bold 26px 'Segoe UI', sans-serif";
            ctx.textAlign = "center";
            ctx.fillText("MySQL连接层详细架构图", canvas.width/2, 40);
            
            // 副标题
            ctx.font = "16px 'Segoe UI', sans-serif";
            ctx.fillStyle = "#88ccff";
            ctx.fillText("连接管理 · 线程调度 · 认证逻辑 · 高并发优化", canvas.width/2, 65);
            
            // 装饰线
            ctx.strokeStyle = "rgba(79, 172, 254, 0.5)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width/2 - 200, 70);
            ctx.lineTo(canvas.width/2 + 200, 70);
            ctx.stroke();
        }
        
        // 绘制圆角矩形
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        
        // 选择组件
        function selectComponent(id) {
            selectedComponent = components.find(c => c.id === id);
            
            // 更新详情区域
            document.getElementById('detailContent').innerHTML = `
                <h3>${selectedComponent.name} (#${selectedComponent.id})</h3>
                <p><strong>组件类型：</strong><span class="component-type">${selectedComponent.type}</span></p>
                <p><strong>功能描述：</strong>${selectedComponent.description}</p>
                <p><strong>主要功能：</strong></p>
                <ul>
                    ${selectedComponent.details.map(detail => `<li>${detail}</li>`).join('')}
                </ul>
                <p><strong>位置：</strong>区域 ${Math.floor((selectedComponent.x - 50) / 250) + 1}</p>
            `;
            
            // 重绘画布
            drawComponents();
        }
        
        // 演示连接流程
        function animateConnectionFlow() {
            if (animationInProgress) return;
            animationInProgress = true;
            
            const steps = [
                { compId: 1, delay: 600, highlight: true },
                { compId: 2, delay: 600, highlight: true },
                { compId: 3, delay: 700, highlight: true },
                { compId: 4, delay: 700, highlight: true },
                { compId: 5, delay: 700, highlight: true },
                { compId: 6, delay: 800, highlight: true },
                { compId: 7, delay: 800, highlight: true },
                { compId: 8, delay: 800, highlight: true },
                { compId: 10, delay: 900, highlight: true },
                { compId: 11, delay: 700, highlight: true },
                { compId: 12, delay: 700, highlight: true },
                { compId: 13, delay: 800, highlight: true },
                { compId: 14, delay: 800, highlight: true },
                { compId: 1, delay: 1000, highlight: false, final: true }
            ];
            
            // 重置所有组件选中状态
            selectedComponent = null;
            drawComponents();
            
            // 执行动画步骤
            let totalDelay = 0;
            steps.forEach((step, index) => {
                setTimeout(() => {
                    if (step.compId) {
                        const comp = components.find(c => c.id === step.compId);
                        if (comp) {
                            // 临时高亮组件
                            if (step.highlight) {
                                // 绘制脉冲效果
                                drawPulseEffect(comp);
                                
                                // 临时选择组件
                                selectedComponent = comp;
                                drawComponents();
                                
                                // 更新组件列表高亮
                                document.querySelectorAll('.component-list li').forEach(item => {
                                    if (parseInt(item.dataset.id) === comp.id) {
                                        item.classList.add('active');
                                    } else {
                                        item.classList.remove('active');
                                    }
                                });
                            }
                            
                            // 如果是最后一步，恢复视图
                            if (step.final) {
                                setTimeout(() => {
                                    selectedComponent = null;
                                    drawComponents();
                                    animationInProgress = false;
                                    
                                    // 重置组件列表高亮
                                    document.querySelectorAll('.component-list li').forEach(item => {
                                        item.classList.remove('active');
                                    });
                                    
                                    // 恢复详情区域
                                    document.getElementById('detailContent').innerHTML = `
                                        <p>MySQL连接层是客户端与MySQL服务器交互的入口点，负责管理所有客户端连接，验证用户身份，并分配处理线程。</p>
                                        <p>连接层的主要功能包括：<span class="highlight">连接管理</span>、<span class="highlight">用户认证</span>、<span class="highlight">线程调度</span>和<span class="highlight">安全控制</span>。</p>
                                        <p>在高并发场景下，连接层的性能直接影响整个数据库系统的吞吐量。MySQL 8.0引入了线程池(Thread Pool)来优化传统的一连接一线程(one-thread-per-connection)模型，显著提升了高并发处理能力。</p>
                                        <p>点击左侧组件查看详细说明。</p>
                                    `;
                                }, 800);
                            }
                        }
                    }
                }, totalDelay);
                
                totalDelay += step.delay;
            });
        }
        
        // 绘制脉冲效果
        function drawPulseEffect(comp) {
            const centerX = comp.x + comp.width / 2;
            const centerY = comp.y + comp.height / 2;
            let radius = 5;
            let opacity = 1;
            
            // 绘制多个脉冲圈
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const pulseInterval = setInterval(() => {
                        // 清除之前的脉冲
                        drawComponents();
                        
                        // 绘制新脉冲
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                        ctx.strokeStyle = `rgba(255, 107, 107, ${opacity})`;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        radius += 2;
                        opacity -= 0.05;
                        
                        if (opacity <= 0) {
                            clearInterval(pulseInterval);
                            radius = 5;
                            opacity = 1;
                        }
                    }, 50);
                }, i * 200);
            }
        }
        
        // 初始化
        function init() {
            // 初始化组件列表
            initComponentList();
            
            // 初始绘制
            resizeCanvas();
            drawComponents();
            
            // 窗口调整大小时重绘
            window.addEventListener('resize', resizeCanvas);
            
            // 添加按钮事件
            document.getElementById('animateBtn').addEventListener('click', animateConnectionFlow);
            document.getElementById('resetBtn').addEventListener('click', () => {
                if (animationInProgress) return;
                
                selectedComponent = null;
                drawComponents();
                
                // 重置组件列表高亮
                document.querySelectorAll('.component-list li').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 恢复详情区域
                document.getElementById('detailContent').innerHTML = `
                    <p>MySQL连接层是客户端与MySQL服务器交互的入口点，负责管理所有客户端连接，验证用户身份，并分配处理线程。</p>
                    <p>连接层的主要功能包括：<span class="highlight">连接管理</span>、<span class="highlight">用户认证</span>、<span class="highlight">线程调度</span>和<span class="highlight">安全控制</span>。</p>
                    <p>在高并发场景下，连接层的性能直接影响整个数据库系统的吞吐量。MySQL 8.0引入了线程池(Thread Pool)来优化传统的一连接一线程(one-thread-per-connection)模型，显著提升了高并发处理能力。</p>
                    <p>点击左侧组件查看详细说明。</p>
                `;
            });
            
            // 初始选择第一个组件
            setTimeout(() => {
                document.querySelector('.component-list li').click();
            }, 500);
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>